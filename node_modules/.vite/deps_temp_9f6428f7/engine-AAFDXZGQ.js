import {
  waitForReceipt
} from "./chunk-V6BCGFJC.js";
import "./chunk-QWTK625L.js";
import {
  readContract
} from "./chunk-OEYP3ZA3.js";
import "./chunk-NOCRRPHM.js";
import "./chunk-B7FDTVAN.js";
import "./chunk-RZCLSFDG.js";
import "./chunk-BXEIBF7B.js";
import "./chunk-L4NN5UUQ.js";
import "./chunk-A5QRUZ7S.js";
import {
  getContract
} from "./chunk-6JXWMKOB.js";
import "./chunk-NCIUOEBK.js";
import "./chunk-6JZ5SMSC.js";
import "./chunk-QWRIO2XV.js";
import "./chunk-2OMZKD5Y.js";
import "./chunk-67FUEQYA.js";
import "./chunk-HAADYJEF.js";
import "./chunk-A2CDDISI.js";
import "./chunk-JZ3W4FG5.js";
import "./chunk-SS3OIJZU.js";
import "./chunk-T2RSOTGF.js";
import {
  stringify
} from "./chunk-2CIJO3V3.js";
import "./chunk-MW5FLPJ5.js";
import "./chunk-UG6X6BL6.js";
import "./chunk-4HC36SBT.js";
import "./chunk-HXWRQBIO.js";
import "./chunk-FLUAB4EX.js";
import "./chunk-YEW47TY7.js";
import "./chunk-E7HBP2XZ.js";
import "./chunk-G24WGTAU.js";
import "./chunk-L7Y3EIPZ.js";
import "./chunk-PPP72TBL.js";
import "./chunk-3OXDSLPJ.js";
import "./chunk-HARK4W7T.js";
import "./chunk-5JRVV4XU.js";

// node_modules/thirdweb/dist/esm/transaction/actions/gasless/providers/engine.js
async function prepareEngineTransaction({ account, serializableTransaction, transaction, gasless }) {
  const forrwaderContract = getContract({
    address: gasless.relayerForwarderAddress,
    chain: transaction.chain,
    client: transaction.client
  });
  const nonce = await readContract({
    contract: forrwaderContract,
    method: "function getNonce(address) view returns (uint256)",
    params: [account.address]
  });
  const [signature, message] = await (async () => {
    if (!serializableTransaction.to) {
      throw new Error("engine transactions must have a 'to' address");
    }
    if (!serializableTransaction.gas) {
      throw new Error("engine transactions must have a 'gas' value");
    }
    if (!serializableTransaction.data) {
      throw new Error("engine transactions must have a 'data' value");
    }
    if (gasless.experimentalChainlessSupport) {
      const message3 = {
        chainid: BigInt(transaction.chain.id),
        data: serializableTransaction.data,
        from: account.address,
        gas: serializableTransaction.gas,
        nonce,
        to: serializableTransaction.to,
        value: 0n
      };
      return [
        await account.signTypedData({
          domain: {
            name: "GSNv2 Forwarder",
            verifyingContract: forrwaderContract.address,
            version: "0.0.1"
          },
          message: message3,
          primaryType: "ForwardRequest",
          types: { ForwardRequest: ChainAwareForwardRequest }
        }),
        message3
      ];
    }
    const message2 = {
      data: serializableTransaction.data,
      from: account.address,
      gas: serializableTransaction.gas,
      nonce,
      to: serializableTransaction.to,
      value: 0n
    };
    return [
      await account.signTypedData({
        domain: {
          chainId: transaction.chain.id,
          name: gasless.domainName ?? "GSNv2 Forwarder",
          verifyingContract: forrwaderContract.address,
          version: gasless.domainVersion ?? "0.0.1"
        },
        message: message2,
        primaryType: "ForwardRequest",
        types: { ForwardRequest }
      }),
      message2
    ];
  })();
  const messageType = "forward";
  return { message, messageType, signature };
}
var ForwardRequest = [
  { name: "from", type: "address" },
  { name: "to", type: "address" },
  { name: "value", type: "uint256" },
  { name: "gas", type: "uint256" },
  { name: "nonce", type: "uint256" },
  { name: "data", type: "bytes" }
];
var ChainAwareForwardRequest = [
  { name: "from", type: "address" },
  { name: "to", type: "address" },
  { name: "value", type: "uint256" },
  { name: "gas", type: "uint256" },
  { name: "nonce", type: "uint256" },
  { name: "data", type: "bytes" },
  { name: "chainid", type: "uint256" }
];
async function relayEngineTransaction(options) {
  const { message, messageType, signature } = await prepareEngineTransaction(options);
  const response = await fetch(options.gasless.relayerUrl, {
    body: stringify({
      forwarderAddress: options.gasless.relayerForwarderAddress,
      request: message,
      signature,
      type: messageType
    }),
    headers: {
      "Content-Type": "application/json"
    },
    method: "POST"
  });
  if (!response.ok) {
    throw new Error(`Failed to send transaction: ${await response.text()}`);
  }
  const json = await response.json();
  if (!json.result) {
    throw new Error(`Relay transaction failed: ${json.message}`);
  }
  const queueId = json.result.queueId;
  const timeout = 6e4;
  const interval = 1e3;
  const endtime = Date.now() + timeout;
  while (Date.now() < endtime) {
    const receipt = await fetchReceipt({ options, queueId });
    if (receipt) {
      return {
        chain: options.transaction.chain,
        client: options.transaction.client,
        transactionHash: receipt.transactionHash
      };
    }
    await new Promise((resolve) => setTimeout(resolve, interval));
  }
  throw new Error(`Failed to find relayed transaction after ${timeout}ms`);
}
async function fetchReceipt(args) {
  const { options, queueId } = args;
  const url = options.gasless.relayerUrl.split("/relayer/")[0];
  const res = await fetch(`${url}/transaction/status/${queueId}`, {
    method: "GET"
  });
  const resJson = await res.json();
  if (!res.ok) {
    return null;
  }
  const result = resJson.result;
  if (!result) {
    return null;
  }
  switch (result.status) {
    case "errored":
      throw new Error(`Transaction errored with reason: ${result.errorMessage}`);
    case "cancelled":
      throw new Error("Transaction execution cancelled.");
    case "mined": {
      const receipt = await waitForReceipt({
        chain: options.transaction.chain,
        client: options.transaction.client,
        transactionHash: result.transactionHash
      });
      return receipt;
    }
    default: {
      return null;
    }
  }
}
export {
  prepareEngineTransaction,
  relayEngineTransaction
};
//# sourceMappingURL=engine-AAFDXZGQ.js.map
