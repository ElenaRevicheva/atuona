const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/secp256k1-DzhVOf5U.js","assets/main-DwyrSW8F.js"])))=>i.map(i=>d[i]);
import{c9 as Ui,_ as $l,ca as no,cb as Sl,cc as N,cd as Oi,ce as Al,cf as pc,cg as Ol,ch as Tl,ci as zr,cj as ws,ck as Vt,cl as sr,cm as Rl,cn as Te,co as Ul,cp as Cl,cq as He,cr as Qt,cs as Ci,ct as An,cu as Qe,cv as Nl,cw as On,cx as Tn,cy as rr,cz as Rn,cA as oo,cB as Bl,cC as kl,cD as Hr,cE as Fr,cF as Pi,cG as Un,cH as vt,cI as dt,cJ as St,cK as Dl,cL as _s,cM as ao,cN as ql}from"./main-DwyrSW8F.js";/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function jl(i){return i instanceof Uint8Array||ArrayBuffer.isView(i)&&i.constructor.name==="Uint8Array"}function gc(i,e){return Array.isArray(e)?e.length===0?!0:i?e.every(t=>typeof t=="string"):e.every(t=>Number.isSafeInteger(t)):!1}function Ks(i,e){if(typeof e!="string")throw new Error(`${i}: string expected`);return!0}function Cn(i){if(!Number.isSafeInteger(i))throw new Error(`invalid integer: ${i}`)}function Vr(i){if(!Array.isArray(i))throw new Error("array expected")}function Gs(i,e){if(!gc(!0,e))throw new Error(`${i}: array of strings expected`)}function Ll(i,e){if(!gc(!1,e))throw new Error(`${i}: array of numbers expected`)}function Ml(...i){const e=n=>n,t=(n,o)=>a=>n(o(a)),s=i.map(n=>n.encode).reduceRight(t,e),r=i.map(n=>n.decode).reduce(t,e);return{encode:s,decode:r}}function zl(i){const e=typeof i=="string"?i.split(""):i,t=e.length;Gs("alphabet",e);const s=new Map(e.map((r,n)=>[r,n]));return{encode:r=>(Vr(r),r.map(n=>{if(!Number.isSafeInteger(n)||n<0||n>=t)throw new Error(`alphabet.encode: digit index outside alphabet "${n}". Allowed: ${i}`);return e[n]})),decode:r=>(Vr(r),r.map(n=>{Ks("alphabet.decode",n);const o=s.get(n);if(o===void 0)throw new Error(`Unknown letter: "${n}". Allowed: ${i}`);return o}))}}function Hl(i=""){return Ks("join",i),{encode:e=>(Gs("join.decode",e),e.join(i)),decode:e=>(Ks("join.decode",e),e.split(i))}}function Fl(i,e="="){return Cn(i),Ks("padding",e),{encode(t){for(Gs("padding.encode",t);t.length*i%8;)t.push(e);return t},decode(t){Gs("padding.decode",t);let s=t.length;if(s*i%8)throw new Error("padding: invalid, string should have whole number of bytes");for(;s>0&&t[s-1]===e;s--)if((s-1)*i%8===0)throw new Error("padding: invalid, string has too much padding");return t.slice(0,s)}}}const yc=(i,e)=>e===0?i:yc(e,i%e),Ws=(i,e)=>i+(e-yc(i,e)),mr=(()=>{let i=[];for(let e=0;e<40;e++)i.push(2**e);return i})();function co(i,e,t,s){if(Vr(i),e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(t<=0||t>32)throw new Error(`convertRadix2: wrong to=${t}`);if(Ws(e,t)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${t} carryBits=${Ws(e,t)}`);let r=0,n=0;const o=mr[e],a=mr[t]-1,c=[];for(const h of i){if(Cn(h),h>=o)throw new Error(`convertRadix2: invalid data word=${h} from=${e}`);if(r=r<<e|h,n+e>32)throw new Error(`convertRadix2: carry overflow pos=${n} from=${e}`);for(n+=e;n>=t;n-=t)c.push((r>>n-t&a)>>>0);const l=mr[n];if(l===void 0)throw new Error("invalid carry");r&=l-1}if(r=r<<t-n&a,!s&&n>=e)throw new Error("Excess padding");if(!s&&r>0)throw new Error(`Non-zero padding: ${r}`);return s&&n>0&&c.push(r>>>0),c}function Vl(i,e=!1){if(Cn(i),i<=0||i>32)throw new Error("radix2: bits should be in (0..32]");if(Ws(8,i)>32||Ws(i,8)>32)throw new Error("radix2: carry overflow");return{encode:t=>{if(!jl(t))throw new Error("radix2.encode input should be Uint8Array");return co(Array.from(t),8,i,!e)},decode:t=>(Ll("radix2.decode",t),Uint8Array.from(co(t,i,8,e)))}}const Kl=Ml(Vl(5),zl("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),Fl(5),Hl(""));var Gl=Object.defineProperty,Wl=(i,e,t)=>e in i?Gl(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ho=(i,e,t)=>Wl(i,typeof e!="symbol"?e+"":e,t);let Jl=class extends Ui{constructor(e){super(),this.opts=e,ho(this,"protocol","wc"),ho(this,"version",2)}};var Yl=Object.defineProperty,Zl=(i,e,t)=>e in i?Yl(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ql=(i,e,t)=>Zl(i,e+"",t);let Xl=class extends Ui{constructor(e,t){super(),this.core=e,this.logger=t,Ql(this,"records",new Map)}},eu=class{constructor(e,t){this.logger=e,this.core=t}},tu=class extends Ui{constructor(e,t){super(),this.relayer=e,this.logger=t}},iu=class extends Ui{constructor(e){super()}},su=class{constructor(e,t,s,r){this.core=e,this.logger=t,this.name=s}},ru=class extends Ui{constructor(e,t){super(),this.relayer=e,this.logger=t}},nu=class extends Ui{constructor(e,t){super(),this.core=e,this.logger=t}},ou=class{constructor(e,t,s){this.core=e,this.logger=t,this.store=s}},au=class{constructor(e,t){this.projectId=e,this.logger=t}},cu=class{constructor(e,t,s){this.core=e,this.logger=t,this.telemetryEnabled=s}};var hu=Object.defineProperty,lu=(i,e,t)=>e in i?hu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,lo=(i,e,t)=>lu(i,typeof e!="symbol"?e+"":e,t);let uu=class{constructor(e){this.opts=e,lo(this,"protocol","wc"),lo(this,"version",2)}},du=class{constructor(e){this.client=e}};function ds(i,{strict:e=!0}={}){return!i||typeof i!="string"?!1:e?/^0x[0-9a-fA-F]*$/.test(i):i.startsWith("0x")}function Kr(i){return ds(i,{strict:!1})?Math.ceil((i.length-2)/2):i.length}const mc="2.31.0";let Li={getDocsUrl:({docsBaseUrl:i,docsPath:e="",docsSlug:t})=>e?`${i??"https://viem.sh"}${e}${t?`#${t}`:""}`:void 0,version:`viem@${mc}`};class si extends Error{constructor(e,t={}){var a;const s=(()=>{var c;return t.cause instanceof si?t.cause.details:(c=t.cause)!=null&&c.message?t.cause.message:t.details})(),r=t.cause instanceof si&&t.cause.docsPath||t.docsPath,n=(a=Li.getDocsUrl)==null?void 0:a.call(Li,{...t,docsPath:r}),o=[e||"An error occurred.","",...t.metaMessages?[...t.metaMessages,""]:[],...n?[`Docs: ${n}`]:[],...s?[`Details: ${s}`]:[],...Li.version?[`Version: ${Li.version}`]:[]].join(`
`);super(o,t.cause?{cause:t.cause}:void 0),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docsPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metaMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shortMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"BaseError"}),this.details=s,this.docsPath=r,this.metaMessages=t.metaMessages,this.name=t.name??this.name,this.shortMessage=e,this.version=mc}walk(e){return wc(this,e)}}function wc(i,e){return e!=null&&e(i)?i:i&&typeof i=="object"&&"cause"in i&&i.cause!==void 0?wc(i.cause,e):e?null:i}class bc extends si{constructor({size:e,targetSize:t,type:s}){super(`${s.charAt(0).toUpperCase()}${s.slice(1).toLowerCase()} size (${e}) exceeds padding size (${t}).`,{name:"SizeExceedsPaddingSizeError"})}}function Ni(i,{dir:e,size:t=32}={}){return typeof i=="string"?fu(i,{dir:e,size:t}):pu(i,{dir:e,size:t})}function fu(i,{dir:e,size:t=32}={}){if(t===null)return i;const s=i.replace("0x","");if(s.length>t*2)throw new bc({size:Math.ceil(s.length/2),targetSize:t,type:"hex"});return`0x${s[e==="right"?"padEnd":"padStart"](t*2,"0")}`}function pu(i,{dir:e,size:t=32}={}){if(t===null)return i;if(i.length>t)throw new bc({size:i.length,targetSize:t,type:"bytes"});const s=new Uint8Array(t);for(let r=0;r<t;r++){const n=e==="right";s[n?r:t-r-1]=i[n?r:i.length-r-1]}return s}class gu extends si{constructor({max:e,min:t,signed:s,size:r,value:n}){super(`Number "${n}" is not in safe ${r?`${r*8}-bit ${s?"signed":"unsigned"} `:""}integer range ${e?`(${t} to ${e})`:`(above ${t})`}`,{name:"IntegerOutOfRangeError"})}}class yu extends si{constructor({givenSize:e,maxSize:t}){super(`Size cannot exceed ${t} bytes. Given size: ${e} bytes.`,{name:"SizeOverflowError"})}}function Bi(i,{size:e}){if(Kr(i)>e)throw new yu({givenSize:Kr(i),maxSize:e})}function Gr(i,e={}){const{signed:t}=e;e.size&&Bi(i,{size:e.size});const s=BigInt(i);if(!t)return s;const r=(i.length-2)/2,n=(1n<<BigInt(r)*8n-1n)-1n;return s<=n?s:s-BigInt(`0x${"f".padStart(r*2,"f")}`)-1n}function mu(i,e={}){return Number(Gr(i,e))}const wu=Array.from({length:256},(i,e)=>e.toString(16).padStart(2,"0"));function Wr(i,e={}){return typeof i=="number"||typeof i=="bigint"?Ec(i,e):typeof i=="string"?Eu(i,e):typeof i=="boolean"?bu(i,e):vc(i,e)}function bu(i,e={}){const t=`0x${Number(i)}`;return typeof e.size=="number"?(Bi(t,{size:e.size}),Ni(t,{size:e.size})):t}function vc(i,e={}){let t="";for(let r=0;r<i.length;r++)t+=wu[i[r]];const s=`0x${t}`;return typeof e.size=="number"?(Bi(s,{size:e.size}),Ni(s,{dir:"right",size:e.size})):s}function Ec(i,e={}){const{signed:t,size:s}=e,r=BigInt(i);let n;s?t?n=(1n<<BigInt(s)*8n-1n)-1n:n=2n**(BigInt(s)*8n)-1n:typeof i=="number"&&(n=BigInt(Number.MAX_SAFE_INTEGER));const o=typeof n=="bigint"&&t?-n-1n:0;if(n&&r>n||r<o){const c=typeof i=="bigint"?"n":"";throw new gu({max:n?`${n}${c}`:void 0,min:`${o}${c}`,signed:t,size:s,value:`${i}${c}`})}const a=`0x${(t&&r<0?(1n<<BigInt(s*8))+BigInt(r):r).toString(16)}`;return s?Ni(a,{size:s}):a}const vu=new TextEncoder;function Eu(i,e={}){const t=vu.encode(i);return vc(t,e)}const Iu=new TextEncoder;function xu(i,e={}){return typeof i=="number"||typeof i=="bigint"?Pu(i,e):typeof i=="boolean"?_u(i,e):ds(i)?Ic(i,e):xc(i,e)}function _u(i,e={}){const t=new Uint8Array(1);return t[0]=Number(i),typeof e.size=="number"?(Bi(t,{size:e.size}),Ni(t,{size:e.size})):t}const wt={zero:48,nine:57,A:65,F:70,a:97,f:102};function uo(i){if(i>=wt.zero&&i<=wt.nine)return i-wt.zero;if(i>=wt.A&&i<=wt.F)return i-(wt.A-10);if(i>=wt.a&&i<=wt.f)return i-(wt.a-10)}function Ic(i,e={}){let t=i;e.size&&(Bi(t,{size:e.size}),t=Ni(t,{dir:"right",size:e.size}));let s=t.slice(2);s.length%2&&(s=`0${s}`);const r=s.length/2,n=new Uint8Array(r);for(let o=0,a=0;o<r;o++){const c=uo(s.charCodeAt(a++)),h=uo(s.charCodeAt(a++));if(c===void 0||h===void 0)throw new si(`Invalid byte sequence ("${s[a-2]}${s[a-1]}" in "${s}").`);n[o]=c*16+h}return n}function Pu(i,e){const t=Ec(i,e);return Ic(t)}function xc(i,e={}){const t=Iu.encode(i);return typeof e.size=="number"?(Bi(t,{size:e.size}),Ni(t,{dir:"right",size:e.size})):t}const Ps=BigInt(2**32-1),fo=BigInt(32);function $u(i,e=!1){return e?{h:Number(i&Ps),l:Number(i>>fo&Ps)}:{h:Number(i>>fo&Ps)|0,l:Number(i&Ps)|0}}function Su(i,e=!1){const t=i.length;let s=new Uint32Array(t),r=new Uint32Array(t);for(let n=0;n<t;n++){const{h:o,l:a}=$u(i[n],e);[s[n],r[n]]=[o,a]}return[s,r]}const Au=(i,e,t)=>i<<t|e>>>32-t,Ou=(i,e,t)=>e<<t|i>>>32-t,Tu=(i,e,t)=>e<<t-32|i>>>64-t,Ru=(i,e,t)=>i<<t-32|e>>>64-t,ci=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Uu(i){return i instanceof Uint8Array||ArrayBuffer.isView(i)&&i.constructor.name==="Uint8Array"}function Js(i){if(!Number.isSafeInteger(i)||i<0)throw new Error("positive integer expected, got "+i)}function fs(i,...e){if(!Uu(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error("Uint8Array expected of length "+e+", got length="+i.length)}function IE(i){if(typeof i!="function"||typeof i.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Js(i.outputLen),Js(i.blockLen)}function po(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function Cu(i,e){fs(i);const t=e.outputLen;if(i.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Nu(i){return new Uint32Array(i.buffer,i.byteOffset,Math.floor(i.byteLength/4))}function _c(...i){for(let e=0;e<i.length;e++)i[e].fill(0)}function xE(i){return new DataView(i.buffer,i.byteOffset,i.byteLength)}function _E(i,e){return i<<32-e|i>>>e}const Bu=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function ku(i){return i<<24&4278190080|i<<8&16711680|i>>>8&65280|i>>>24&255}function Du(i){for(let e=0;e<i.length;e++)i[e]=ku(i[e]);return i}const go=Bu?i=>i:Du;function qu(i){if(typeof i!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(i))}function Pc(i){return typeof i=="string"&&(i=qu(i)),fs(i),i}function PE(...i){let e=0;for(let s=0;s<i.length;s++){const r=i[s];fs(r),e+=r.length}const t=new Uint8Array(e);for(let s=0,r=0;s<i.length;s++){const n=i[s];t.set(n,r),r+=n.length}return t}class ju{}function Lu(i){const e=s=>i().update(Pc(s)).digest(),t=i();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>i(),e}function $E(i=32){if(ci&&typeof ci.getRandomValues=="function")return ci.getRandomValues(new Uint8Array(i));if(ci&&typeof ci.randomBytes=="function")return Uint8Array.from(ci.randomBytes(i));throw new Error("crypto.getRandomValues must be defined")}const Mu=BigInt(0),Mi=BigInt(1),zu=BigInt(2),Hu=BigInt(7),Fu=BigInt(256),Vu=BigInt(113),$c=[],Sc=[],Ac=[];for(let i=0,e=Mi,t=1,s=0;i<24;i++){[t,s]=[s,(2*t+3*s)%5],$c.push(2*(5*s+t)),Sc.push((i+1)*(i+2)/2%64);let r=Mu;for(let n=0;n<7;n++)e=(e<<Mi^(e>>Hu)*Vu)%Fu,e&zu&&(r^=Mi<<(Mi<<BigInt(n))-Mi);Ac.push(r)}const Oc=Su(Ac,!0),Ku=Oc[0],Gu=Oc[1],yo=(i,e,t)=>t>32?Tu(i,e,t):Au(i,e,t),mo=(i,e,t)=>t>32?Ru(i,e,t):Ou(i,e,t);function Wu(i,e=24){const t=new Uint32Array(10);for(let s=24-e;s<24;s++){for(let o=0;o<10;o++)t[o]=i[o]^i[o+10]^i[o+20]^i[o+30]^i[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,h=t[c],l=t[c+1],u=yo(h,l,1)^t[a],d=mo(h,l,1)^t[a+1];for(let p=0;p<50;p+=10)i[o+p]^=u,i[o+p+1]^=d}let r=i[2],n=i[3];for(let o=0;o<24;o++){const a=Sc[o],c=yo(r,n,a),h=mo(r,n,a),l=$c[o];r=i[l],n=i[l+1],i[l]=c,i[l+1]=h}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=i[o+a];for(let a=0;a<10;a++)i[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}i[0]^=Ku[s],i[1]^=Gu[s]}_c(t)}class Nn extends ju{constructor(e,t,s,r=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=t,this.outputLen=s,this.enableXOF=r,this.rounds=n,Js(s),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=Nu(this.state)}clone(){return this._cloneInto()}keccak(){go(this.state32),Wu(this.state32,this.rounds),go(this.state32),this.posOut=0,this.pos=0}update(e){po(this),e=Pc(e),fs(e);const{blockLen:t,state:s}=this,r=e.length;for(let n=0;n<r;){const o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)s[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:t,pos:s,blockLen:r}=this;e[s]^=t,t&128&&s===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){po(this,!1),fs(e),this.finish();const t=this.state,{blockLen:s}=this;for(let r=0,n=e.length;r<n;){this.posOut>=s&&this.keccak();const o=Math.min(s-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return Js(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(Cu(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,_c(this.state)}_cloneInto(e){const{blockLen:t,suffix:s,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new Nn(t,s,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=s,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}}const Ju=(i,e,t)=>Lu(()=>new Nn(e,i,t)),Yu=Ju(1,136,256/8);function Tc(i,e){const t=e||"hex",s=Yu(ds(i,{strict:!1})?xu(i):i);return t==="bytes"?s:Wr(s)}class Zu extends Map{constructor(e){super(),Object.defineProperty(this,"maxSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSize=e}get(e){const t=super.get(e);return super.has(e)&&t!==void 0&&(this.delete(e),super.set(e,t)),t}set(e,t){if(super.set(e,t),this.maxSize&&this.size>this.maxSize){const s=this.keys().next().value;s&&this.delete(s)}return this}}const wr=new Zu(8192);function Qu(i,e){if(wr.has(`${i}.${e}`))return wr.get(`${i}.${e}`);const t=i.substring(2).toLowerCase(),s=Tc(xc(t),"bytes"),r=t.split("");for(let o=0;o<40;o+=2)s[o>>1]>>4>=8&&r[o]&&(r[o]=r[o].toUpperCase()),(s[o>>1]&15)>=8&&r[o+1]&&(r[o+1]=r[o+1].toUpperCase());const n=`0x${r.join("")}`;return wr.set(`${i}.${e}`,n),n}function Xu(i){const e=Tc(`0x${i.substring(4)}`).substring(26);return Qu(`0x${e}`)}async function ed({hash:i,signature:e}){const t=ds(i)?i:Wr(i),{secp256k1:s}=await $l(async()=>{const{secp256k1:o}=await import("./secp256k1-DzhVOf5U.js");return{secp256k1:o}},__vite__mapDeps([0,1]));return`0x${(()=>{if(typeof e=="object"&&"r"in e&&"s"in e){const{r:h,s:l,v:u,yParity:d}=e,p=Number(d??u),m=wo(p);return new s.Signature(Gr(h),Gr(l)).addRecoveryBit(m)}const o=ds(e)?e:Wr(e);if(Kr(o)!==65)throw new Error("invalid signature length");const a=mu(`0x${o.slice(130)}`),c=wo(a);return s.Signature.fromCompact(o.substring(2,130)).addRecoveryBit(c)})().recoverPublicKey(t.substring(2)).toHex(!1)}`}function wo(i){if(i===0||i===1)return i;if(i===27)return 0;if(i===28)return 1;throw new Error("Invalid yParityOrV value")}async function td({hash:i,signature:e}){return Xu(await ed({hash:i,signature:e}))}function id(i){const e=i.length;let t=0,s=0;for(;s<e;){let r=i.charCodeAt(s++);if(r&4294967168)if(!(r&4294965248))t+=2;else{if(r>=55296&&r<=56319&&s<e){const n=i.charCodeAt(s);(n&64512)===56320&&(++s,r=((r&1023)<<10)+(n&1023)+65536)}r&4294901760?t+=4:t+=3}else{t++;continue}}return t}function sd(i,e,t){const s=i.length;let r=t,n=0;for(;n<s;){let o=i.charCodeAt(n++);if(o&4294967168)if(!(o&4294965248))e[r++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&n<s){const a=i.charCodeAt(n);(a&64512)===56320&&(++n,o=((o&1023)<<10)+(a&1023)+65536)}o&4294901760?(e[r++]=o>>18&7|240,e[r++]=o>>12&63|128,e[r++]=o>>6&63|128):(e[r++]=o>>12&15|224,e[r++]=o>>6&63|128)}else{e[r++]=o;continue}e[r++]=o&63|128}}const rd=new TextEncoder,nd=50;function od(i,e,t){rd.encodeInto(i,e.subarray(t))}function ad(i,e,t){i.length>nd?od(i,e,t):sd(i,e,t)}const cd=4096;function Rc(i,e,t){let s=e;const r=s+t,n=[];let o="";for(;s<r;){const a=i[s++];if(!(a&128))n.push(a);else if((a&224)===192){const c=i[s++]&63;n.push((a&31)<<6|c)}else if((a&240)===224){const c=i[s++]&63,h=i[s++]&63;n.push((a&31)<<12|c<<6|h)}else if((a&248)===240){const c=i[s++]&63,h=i[s++]&63,l=i[s++]&63;let u=(a&7)<<18|c<<12|h<<6|l;u>65535&&(u-=65536,n.push(u>>>10&1023|55296),u=56320|u&1023),n.push(u)}else n.push(a);n.length>=cd&&(o+=String.fromCharCode(...n),n.length=0)}return n.length>0&&(o+=String.fromCharCode(...n)),o}const hd=new TextDecoder,ld=200;function ud(i,e,t){const s=i.subarray(e,e+t);return hd.decode(s)}function dd(i,e,t){return t>ld?ud(i,e,t):Rc(i,e,t)}class $s{constructor(e,t){this.type=e,this.data=t}}class Le extends Error{constructor(e){super(e);const t=Object.create(Le.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:Le.name})}}const zi=4294967295;function fd(i,e,t){const s=t/4294967296,r=t;i.setUint32(e,s),i.setUint32(e+4,r)}function Uc(i,e,t){const s=Math.floor(t/4294967296),r=t;i.setUint32(e,s),i.setUint32(e+4,r)}function Cc(i,e){const t=i.getInt32(e),s=i.getUint32(e+4);return t*4294967296+s}function pd(i,e){const t=i.getUint32(e),s=i.getUint32(e+4);return t*4294967296+s}const gd=-1,yd=4294967296-1,md=17179869184-1;function wd({sec:i,nsec:e}){if(i>=0&&e>=0&&i<=md)if(e===0&&i<=yd){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,i),t}else{const t=i/4294967296,s=i&4294967295,r=new Uint8Array(8),n=new DataView(r.buffer);return n.setUint32(0,e<<2|t&3),n.setUint32(4,s),r}else{const t=new Uint8Array(12),s=new DataView(t.buffer);return s.setUint32(0,e),Uc(s,4,i),t}}function bd(i){const e=i.getTime(),t=Math.floor(e/1e3),s=(e-t*1e3)*1e6,r=Math.floor(s/1e9);return{sec:t+r,nsec:s-r*1e9}}function vd(i){if(i instanceof Date){const e=bd(i);return wd(e)}else return null}function Ed(i){const e=new DataView(i.buffer,i.byteOffset,i.byteLength);switch(i.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{const t=e.getUint32(0),s=e.getUint32(4),r=(t&3)*4294967296+s,n=t>>>2;return{sec:r,nsec:n}}case 12:{const t=Cc(e,4),s=e.getUint32(0);return{sec:t,nsec:s}}default:throw new Le(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${i.length}`)}}function Id(i){const e=Ed(i);return new Date(e.sec*1e3+e.nsec/1e6)}const xd={type:gd,encode:vd,decode:Id};class Ys{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(xd)}register({type:e,encode:t,decode:s}){if(e>=0)this.encoders[e]=t,this.decoders[e]=s;else{const r=-1-e;this.builtInEncoders[r]=t,this.builtInDecoders[r]=s}}tryToEncode(e,t){for(let s=0;s<this.builtInEncoders.length;s++){const r=this.builtInEncoders[s];if(r!=null){const n=r(e,t);if(n!=null){const o=-1-s;return new $s(o,n)}}}for(let s=0;s<this.encoders.length;s++){const r=this.encoders[s];if(r!=null){const n=r(e,t);if(n!=null){const o=s;return new $s(o,n)}}}return e instanceof $s?e:null}decode(e,t,s){const r=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return r?r(e,t,s):new $s(t,e)}}Ys.defaultCodec=new Ys;function _d(i){return i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer}function Jr(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):_d(i)?new Uint8Array(i):Uint8Array.from(i)}const Pd=100,$d=2048;class Bn{constructor(e){this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Ys.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.maxDepth=(e==null?void 0:e.maxDepth)??Pd,this.initialBufferSize=(e==null?void 0:e.initialBufferSize)??$d,this.sortKeys=(e==null?void 0:e.sortKeys)??!1,this.forceFloat32=(e==null?void 0:e.forceFloat32)??!1,this.ignoreUndefined=(e==null?void 0:e.ignoreUndefined)??!1,this.forceIntegerToFloat=(e==null?void 0:e.forceIntegerToFloat)??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new Bn({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){const t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){const t=new ArrayBuffer(e),s=new Uint8Array(t),r=new DataView(t);s.set(this.bytes),this.view=r,this.bytes=s}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){const s=id(e);this.ensureBufferSizeToWrite(5+s),this.writeStringHeader(s),ad(e,this.bytes,this.pos),this.pos+=s}encodeObject(e,t){const s=this.extensionCodec.tryToEncode(e,this.context);if(s!=null)this.encodeExtension(s);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){const t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);const s=Jr(e);this.writeU8a(s)}encodeArray(e,t){const s=e.length;if(s<16)this.writeU8(144+s);else if(s<65536)this.writeU8(220),this.writeU16(s);else if(s<4294967296)this.writeU8(221),this.writeU32(s);else throw new Error(`Too large array: ${s}`);for(const r of e)this.doEncode(r,t+1)}countWithoutUndefined(e,t){let s=0;for(const r of t)e[r]!==void 0&&s++;return s}encodeMap(e,t){const s=Object.keys(e);this.sortKeys&&s.sort();const r=this.ignoreUndefined?this.countWithoutUndefined(e,s):s.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else if(r<4294967296)this.writeU8(223),this.writeU32(r);else throw new Error(`Too large map object: ${r}`);for(const n of s){const o=e[n];this.ignoreUndefined&&o===void 0||(this.encodeString(n),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){const s=e.data(this.pos+6),r=s.length;if(r>=4294967296)throw new Error(`Too large extension object: ${r}`);this.writeU8(201),this.writeU32(r),this.writeI8(e.type),this.writeU8a(s);return}const t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){const t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),fd(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),Uc(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}}function Sd(i,e){return new Bn(e).encodeSharedRef(i)}function br(i){return`${i<0?"-":""}0x${Math.abs(i).toString(16).padStart(2,"0")}`}const Ad=16,Od=16;class Td{constructor(e=Ad,t=Od){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let s=0;s<this.maxKeyLength;s++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,s){const r=this.caches[s-1];e:for(const n of r){const o=n.bytes;for(let a=0;a<s;a++)if(o[a]!==e[t+a])continue e;return n.str}return null}store(e,t){const s=this.caches[e.length-1],r={bytes:e,str:t};s.length>=this.maxLengthPerKey?s[Math.random()*s.length|0]=r:s.push(r)}decode(e,t,s){const r=this.find(e,t,s);if(r!=null)return this.hit++,r;this.miss++;const n=Rc(e,t,s),o=Uint8Array.prototype.slice.call(e,t,t+s);return this.store(o,n),n}}const Yr="array",rs="map_key",Nc="map_value",Rd=i=>{if(typeof i=="string"||typeof i=="number")return i;throw new Le("The type of key must be string or number but "+typeof i)};class Ud{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){const t=this.getUninitializedStateFromPool();t.type=Yr,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){const t=this.getUninitializedStateFromPool();t.type=rs,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){const e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===Yr){const s=e;s.size=0,s.array=void 0,s.position=0,s.type=void 0}if(e.type===rs||e.type===Nc){const s=e;s.size=0,s.map=void 0,s.readCount=0,s.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}const Hi=-1,kn=new DataView(new ArrayBuffer(0)),Cd=new Uint8Array(kn.buffer);try{kn.getInt8(0)}catch(i){if(!(i instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}const bo=new RangeError("Insufficient data"),Nd=new Td;class Dn{constructor(e){this.totalPos=0,this.pos=0,this.view=kn,this.bytes=Cd,this.headByte=Hi,this.stack=new Ud,this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Ys.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.rawStrings=(e==null?void 0:e.rawStrings)??!1,this.maxStrLength=(e==null?void 0:e.maxStrLength)??zi,this.maxBinLength=(e==null?void 0:e.maxBinLength)??zi,this.maxArrayLength=(e==null?void 0:e.maxArrayLength)??zi,this.maxMapLength=(e==null?void 0:e.maxMapLength)??zi,this.maxExtLength=(e==null?void 0:e.maxExtLength)??zi,this.keyDecoder=(e==null?void 0:e.keyDecoder)!==void 0?e.keyDecoder:Nd,this.mapKeyConverter=(e==null?void 0:e.mapKeyConverter)??Rd}clone(){return new Dn({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=Hi,this.stack.reset()}setBuffer(e){const t=Jr(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===Hi&&!this.hasRemaining(1))this.setBuffer(e);else{const t=this.bytes.subarray(this.pos),s=Jr(e),r=new Uint8Array(t.length+s.length);r.set(t),r.set(s,t.length),this.setBuffer(r)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){const{view:t,pos:s}=this;return new RangeError(`Extra ${t.byteLength-s} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);const t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,s;for await(const a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{s=this.doDecodeSync(),t=!0}catch(c){if(!(c instanceof RangeError))throw c}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return s}const{headByte:r,pos:n,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${br(r)} at ${o} (${n} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let s=t,r=-1;for await(const n of e){if(t&&r===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(n),s&&(r=this.readArraySize(),s=!1,this.complete());try{for(;yield this.doDecodeSync(),--r!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){const e=this.readHeadByte();let t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){const r=e-128;if(r!==0){this.pushMapState(r),this.complete();continue e}else t={}}else if(e<160){const r=e-144;if(r!==0){this.pushArrayState(r),this.complete();continue e}else t=[]}else{const r=e-160;t=this.decodeString(r,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){const r=this.lookU8();t=this.decodeString(r,1)}else if(e===218){const r=this.lookU16();t=this.decodeString(r,2)}else if(e===219){const r=this.lookU32();t=this.decodeString(r,4)}else if(e===220){const r=this.readU16();if(r!==0){this.pushArrayState(r),this.complete();continue e}else t=[]}else if(e===221){const r=this.readU32();if(r!==0){this.pushArrayState(r),this.complete();continue e}else t=[]}else if(e===222){const r=this.readU16();if(r!==0){this.pushMapState(r),this.complete();continue e}else t={}}else if(e===223){const r=this.readU32();if(r!==0){this.pushMapState(r),this.complete();continue e}else t={}}else if(e===196){const r=this.lookU8();t=this.decodeBinary(r,1)}else if(e===197){const r=this.lookU16();t=this.decodeBinary(r,2)}else if(e===198){const r=this.lookU32();t=this.decodeBinary(r,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){const r=this.lookU8();t=this.decodeExtension(r,1)}else if(e===200){const r=this.lookU16();t=this.decodeExtension(r,2)}else if(e===201){const r=this.lookU32();t=this.decodeExtension(r,4)}else throw new Le(`Unrecognized type byte: ${br(e)}`);this.complete();const s=this.stack;for(;s.length>0;){const r=s.top();if(r.type===Yr)if(r.array[r.position]=t,r.position++,r.position===r.size)t=r.array,s.release(r);else continue e;else if(r.type===rs){if(t==="__proto__")throw new Le("The key __proto__ is not allowed");r.key=this.mapKeyConverter(t),r.type=Nc;continue e}else if(r.map[r.key]=t,r.readCount++,r.readCount===r.size)t=r.map,s.release(r);else{r.key=null,r.type=rs;continue e}}return t}}readHeadByte(){return this.headByte===Hi&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=Hi}readArraySize(){const e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new Le(`Unrecognized array type byte: ${br(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new Le(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new Le(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){var n;if(e>this.maxStrLength)throw new Le(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw bo;const s=this.pos+t;let r;return this.stateIsMapKey()&&((n=this.keyDecoder)!=null&&n.canBeCached(e))?r=this.keyDecoder.decode(this.bytes,s,e):r=dd(this.bytes,s,e),this.pos+=t+e,r}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===rs:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new Le(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw bo;const s=this.pos+t,r=this.bytes.subarray(s,s+e);return this.pos+=t+e,r}decodeExtension(e,t){if(e>this.maxExtLength)throw new Le(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);const s=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,s,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){const e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){const e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){const e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){const e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){const e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){const e=pd(this.view,this.pos);return this.pos+=8,e}readI64(){const e=Cc(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){const e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){const e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){const e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){const e=this.view.getFloat64(this.pos);return this.pos+=8,e}}function Bd(i,e){return new Dn(e).decode(i)}function qn(i){return globalThis.Buffer!=null?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):i}function Bc(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?qn(globalThis.Buffer.allocUnsafe(i)):new Uint8Array(i)}function ns(i,e){e||(e=i.reduce((r,n)=>r+n.length,0));const t=Bc(e);let s=0;for(const r of i)t.set(r,s),s+=r.length;return qn(t)}function kc(i,e,t,s){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:s}}}const vo=kc("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),vr=kc("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);const e=Bc(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),Dc={utf8:vo,"utf-8":vo,hex:no.base16,latin1:vr,ascii:vr,binary:vr,...no};function Je(i,e="utf8"){const t=Dc[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?qn(globalThis.Buffer.from(i,"utf-8")):t.decoder.decode(`${t.prefix}${i}`)}function De(i,e="utf8"){const t=Dc[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i.buffer,i.byteOffset,i.byteLength).toString("utf8"):t.encoder.encode(i).substring(1)}const kd="Input must be an string, Buffer or Uint8Array";function Dd(i){let e;if(i instanceof Uint8Array)e=i;else if(typeof i=="string")e=new TextEncoder().encode(i);else throw new Error(kd);return e}function qd(i){return Array.prototype.map.call(i,function(e){return(e<16?"0":"")+e.toString(16)}).join("")}function Ss(i){return(4294967296+i).toString(16).substring(1)}function jd(i,e,t){let s=`
`+i+" = ";for(let r=0;r<e.length;r+=2){if(t===32)s+=Ss(e[r]).toUpperCase(),s+=" ",s+=Ss(e[r+1]).toUpperCase();else if(t===64)s+=Ss(e[r+1]).toUpperCase(),s+=Ss(e[r]).toUpperCase();else throw new Error("Invalid size "+t);r%6===4?s+=`
`+new Array(i.length+4).join(" "):r<e.length-2&&(s+=" ")}console.log(s)}function Ld(i,e,t){let s=new Date().getTime();const r=new Uint8Array(e);for(let o=0;o<e;o++)r[o]=o%256;const n=new Date().getTime();console.log("Generated random input in "+(n-s)+"ms"),s=n;for(let o=0;o<t;o++){const a=i(r),c=new Date().getTime(),h=c-s;s=c,console.log("Hashed in "+h+"ms: "+a.substring(0,20)+"..."),console.log(Math.round(e/(1<<20)/(h/1e3)*100)/100+" MB PER SECOND")}}var qc={normalizeInput:Dd,toHex:qd,debugPrint:jd,testSpeed:Ld};const Ms=qc;function As(i,e,t){const s=i[e]+i[t];let r=i[e+1]+i[t+1];s>=4294967296&&r++,i[e]=s,i[e+1]=r}function Eo(i,e,t,s){let r=i[e]+t;t<0&&(r+=4294967296);let n=i[e+1]+s;r>=4294967296&&n++,i[e]=r,i[e+1]=n}function jc(i,e){return i[e]^i[e+1]<<8^i[e+2]<<16^i[e+3]<<24}function At(i,e,t,s,r,n){const o=Xi[r],a=Xi[r+1],c=Xi[n],h=Xi[n+1];As(V,i,e),Eo(V,i,o,a);let l=V[s]^V[i],u=V[s+1]^V[i+1];V[s]=u,V[s+1]=l,As(V,t,s),l=V[e]^V[t],u=V[e+1]^V[t+1],V[e]=l>>>24^u<<8,V[e+1]=u>>>24^l<<8,As(V,i,e),Eo(V,i,c,h),l=V[s]^V[i],u=V[s+1]^V[i+1],V[s]=l>>>16^u<<16,V[s+1]=u>>>16^l<<16,As(V,t,s),l=V[e]^V[t],u=V[e+1]^V[t+1],V[e]=u>>>31^l<<1,V[e+1]=l>>>31^u<<1}const Lc=new Uint32Array([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),Md=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3],Ie=new Uint8Array(Md.map(function(i){return i*2})),V=new Uint32Array(32),Xi=new Uint32Array(32);function Mc(i,e){let t=0;for(t=0;t<16;t++)V[t]=i.h[t],V[t+16]=Lc[t];for(V[24]=V[24]^i.t,V[25]=V[25]^i.t/4294967296,e&&(V[28]=~V[28],V[29]=~V[29]),t=0;t<32;t++)Xi[t]=jc(i.b,4*t);for(t=0;t<12;t++)At(0,8,16,24,Ie[t*16+0],Ie[t*16+1]),At(2,10,18,26,Ie[t*16+2],Ie[t*16+3]),At(4,12,20,28,Ie[t*16+4],Ie[t*16+5]),At(6,14,22,30,Ie[t*16+6],Ie[t*16+7]),At(0,10,20,30,Ie[t*16+8],Ie[t*16+9]),At(2,12,22,24,Ie[t*16+10],Ie[t*16+11]),At(4,14,16,26,Ie[t*16+12],Ie[t*16+13]),At(6,8,18,28,Ie[t*16+14],Ie[t*16+15]);for(t=0;t<16;t++)i.h[t]=i.h[t]^V[t]^V[t+16]}const Ot=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);function zc(i,e,t,s){if(i===0||i>64)throw new Error("Illegal output length, expected 0 < length <= 64");if(e&&e.length>64)throw new Error("Illegal key, expected Uint8Array with 0 < length <= 64");if(t&&t.length!==16)throw new Error("Illegal salt, expected Uint8Array with length is 16");if(s&&s.length!==16)throw new Error("Illegal personal, expected Uint8Array with length is 16");const r={b:new Uint8Array(128),h:new Uint32Array(16),t:0,c:0,outlen:i};Ot.fill(0),Ot[0]=i,e&&(Ot[1]=e.length),Ot[2]=1,Ot[3]=1,t&&Ot.set(t,32),s&&Ot.set(s,48);for(let n=0;n<16;n++)r.h[n]=Lc[n]^jc(Ot,n*4);return e&&(jn(r,e),r.c=128),r}function jn(i,e){for(let t=0;t<e.length;t++)i.c===128&&(i.t+=i.c,Mc(i,!1),i.c=0),i.b[i.c++]=e[t]}function Hc(i){for(i.t+=i.c;i.c<128;)i.b[i.c++]=0;Mc(i,!0);const e=new Uint8Array(i.outlen);for(let t=0;t<i.outlen;t++)e[t]=i.h[t>>2]>>8*(t&3);return e}function Fc(i,e,t,s,r){t=t||64,i=Ms.normalizeInput(i),s&&(s=Ms.normalizeInput(s)),r&&(r=Ms.normalizeInput(r));const n=zc(t,e,s,r);return jn(n,i),Hc(n)}function zd(i,e,t,s,r){const n=Fc(i,e,t,s,r);return Ms.toHex(n)}var Hd={blake2b:Fc,blake2bHex:zd,blake2bInit:zc,blake2bUpdate:jn,blake2bFinal:Hc};const Vc=qc;function Fd(i,e){return i[e]^i[e+1]<<8^i[e+2]<<16^i[e+3]<<24}function Tt(i,e,t,s,r,n){Z[i]=Z[i]+Z[e]+r,Z[s]=Os(Z[s]^Z[i],16),Z[t]=Z[t]+Z[s],Z[e]=Os(Z[e]^Z[t],12),Z[i]=Z[i]+Z[e]+n,Z[s]=Os(Z[s]^Z[i],8),Z[t]=Z[t]+Z[s],Z[e]=Os(Z[e]^Z[t],7)}function Os(i,e){return i>>>e^i<<32-e}const Kc=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),xe=new Uint8Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0]),Z=new Uint32Array(16),ye=new Uint32Array(16);function Gc(i,e){let t=0;for(t=0;t<8;t++)Z[t]=i.h[t],Z[t+8]=Kc[t];for(Z[12]^=i.t,Z[13]^=i.t/4294967296,e&&(Z[14]=~Z[14]),t=0;t<16;t++)ye[t]=Fd(i.b,4*t);for(t=0;t<10;t++)Tt(0,4,8,12,ye[xe[t*16+0]],ye[xe[t*16+1]]),Tt(1,5,9,13,ye[xe[t*16+2]],ye[xe[t*16+3]]),Tt(2,6,10,14,ye[xe[t*16+4]],ye[xe[t*16+5]]),Tt(3,7,11,15,ye[xe[t*16+6]],ye[xe[t*16+7]]),Tt(0,5,10,15,ye[xe[t*16+8]],ye[xe[t*16+9]]),Tt(1,6,11,12,ye[xe[t*16+10]],ye[xe[t*16+11]]),Tt(2,7,8,13,ye[xe[t*16+12]],ye[xe[t*16+13]]),Tt(3,4,9,14,ye[xe[t*16+14]],ye[xe[t*16+15]]);for(t=0;t<8;t++)i.h[t]^=Z[t]^Z[t+8]}function Wc(i,e){if(!(i>0&&i<=32))throw new Error("Incorrect output length, should be in [1, 32]");const t=e?e.length:0;if(e&&!(t>0&&t<=32))throw new Error("Incorrect key length, should be in [1, 32]");const s={h:new Uint32Array(Kc),b:new Uint8Array(64),c:0,t:0,outlen:i};return s.h[0]^=16842752^t<<8^i,t>0&&(Ln(s,e),s.c=64),s}function Ln(i,e){for(let t=0;t<e.length;t++)i.c===64&&(i.t+=i.c,Gc(i,!1),i.c=0),i.b[i.c++]=e[t]}function Jc(i){for(i.t+=i.c;i.c<64;)i.b[i.c++]=0;Gc(i,!0);const e=new Uint8Array(i.outlen);for(let t=0;t<i.outlen;t++)e[t]=i.h[t>>2]>>8*(t&3)&255;return e}function Yc(i,e,t){t=t||32,i=Vc.normalizeInput(i);const s=Wc(t,e);return Ln(s,i),Jc(s)}function Vd(i,e,t){const s=Yc(i,e,t);return Vc.toHex(s)}var Kd={blake2s:Yc,blake2sHex:Vd,blake2sInit:Wc,blake2sUpdate:Ln,blake2sFinal:Jc};const Fi=Hd,Vi=Kd;var Gd={blake2b:Fi.blake2b,blake2bHex:Fi.blake2bHex,blake2bInit:Fi.blake2bInit,blake2bUpdate:Fi.blake2bUpdate,blake2bFinal:Fi.blake2bFinal,blake2s:Vi.blake2s,blake2sHex:Vi.blake2sHex,blake2sInit:Vi.blake2sInit,blake2sUpdate:Vi.blake2sUpdate,blake2sFinal:Vi.blake2sFinal},Wd={};const Jd=":";function Ai(i){const[e,t]=i.split(Jd);return{namespace:e,reference:t}}function Zc(i,e){return i.includes(":")?[i]:e.chains||[]}var Yd=Object.defineProperty,Zd=Object.defineProperties,Qd=Object.getOwnPropertyDescriptors,Io=Object.getOwnPropertySymbols,Xd=Object.prototype.hasOwnProperty,ef=Object.prototype.propertyIsEnumerable,Zr=(i,e,t)=>e in i?Yd(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,xo=(i,e)=>{for(var t in e||(e={}))Xd.call(e,t)&&Zr(i,t,e[t]);if(Io)for(var t of Io(e))ef.call(e,t)&&Zr(i,t,e[t]);return i},tf=(i,e)=>Zd(i,Qd(e)),_o=(i,e,t)=>Zr(i,typeof e!="symbol"?e+"":e,t);const sf="ReactNative",Me={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"},rf="js";function Zs(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function Kt(){return!Oi()&&!!pc()&&navigator.product===sf}function nf(){return Kt()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="android"}function of(){return Kt()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="ios"}function ki(){return!Zs()&&!!pc()&&!!Oi()}function bs(){return Kt()?Me.reactNative:Zs()?Me.node:ki()?Me.browser:Me.unknown}function Po(){var i;try{return Kt()&&typeof global<"u"&&typeof(global==null?void 0:global.Application)<"u"?(i=global.Application)==null?void 0:i.applicationId:void 0}catch{return}}function af(i,e){const t=new URLSearchParams(i);for(const s of Object.keys(e).sort())if(e.hasOwnProperty(s)){const r=e[s];r!==void 0&&t.set(s,r)}return t.toString()}function cf(i){var e,t;const s=Qc();try{return i!=null&&i.url&&s.url&&new URL(i.url).host!==new URL(s.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${i.url} differs from the actual page url:${s.url}. This is probably unintended and can lead to issues.`),i.url=s.url),(e=i==null?void 0:i.icons)!=null&&e.length&&i.icons.length>0&&(i.icons=i.icons.filter(r=>r!=="")),tf(xo(xo({},s),i),{url:(i==null?void 0:i.url)||s.url,name:(i==null?void 0:i.name)||s.name,description:(i==null?void 0:i.description)||s.description,icons:(t=i==null?void 0:i.icons)!=null&&t.length&&i.icons.length>0?i.icons:s.icons})}catch(r){return console.warn("Error populating app metadata",r),i||s}}function Qc(){return Sl()||{name:"",description:"",url:"",icons:[""]}}function hf(){if(bs()===Me.reactNative&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"){const{OS:t,Version:s}=global.Platform;return[t,s].join("-")}const i=Ol();if(i===null)return"unknown";const e=i.os?i.os.replace(" ","").toLowerCase():"unknown";return i.type==="browser"?[e,i.name,i.version].join("-"):[e,i.version].join("-")}function lf(){var i;const e=bs();return e===Me.browser?[e,((i=Tl())==null?void 0:i.host)||"unknown"].join(":"):e}function Xc(i,e,t){const s=hf(),r=lf();return[[i,e].join("-"),[rf,t].join("-"),s,r].join("/")}function uf({protocol:i,version:e,relayUrl:t,sdkVersion:s,auth:r,projectId:n,useOnCloseEvent:o,bundleId:a,packageName:c}){const h=t.split("?"),l=Xc(i,e,s),u={auth:r,ua:l,projectId:n,useOnCloseEvent:o,packageName:c||void 0,bundleId:a||void 0},d=af(h[1]||"",u);return h[0]+"?"+d}function Xt(i,e){return i.filter(t=>e.includes(t)).length===i.length}function Qr(i){return Object.fromEntries(i.entries())}function Xr(i){return new Map(Object.entries(i))}function Jt(i=N.FIVE_MINUTES,e){const t=N.toMiliseconds(i||N.FIVE_MINUTES);let s,r,n,o;return{resolve:a=>{n&&s&&(clearTimeout(n),s(a),o=Promise.resolve(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,c)=>{if(o)return a(o);n=setTimeout(()=>{const h=new Error(e);o=Promise.reject(h),c(h)},t),s=a,r=c})}}function zt(i,e,t){return new Promise(async(s,r)=>{const n=setTimeout(()=>r(new Error(t)),e);try{const o=await i;s(o)}catch(o){r(o)}clearTimeout(n)})}function eh(i,e){if(typeof e=="string"&&e.startsWith(`${i}:`))return e;if(i.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(i.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${i}`)}function df(i){return eh("topic",i)}function ff(i){return eh("id",i)}function th(i){const[e,t]=i.split(":"),s={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")s.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))s.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return s}function de(i,e){return N.fromMiliseconds(Date.now()+N.toMiliseconds(i))}function Dt(i){return Date.now()>=N.toMiliseconds(i)}function X(i,e){return`${i}${e?`:${e}`:""}`}function pt(i=[],e=[]){return[...new Set([...i,...e])]}async function pf({id:i,topic:e,wcDeepLink:t}){var s;try{if(!t)return;const r=typeof t=="string"?JSON.parse(t):t,n=r==null?void 0:r.href;if(typeof n!="string")return;const o=gf(n,i,e),a=bs();if(a===Me.browser){if(!((s=Oi())!=null&&s.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}yf(o)}else a===Me.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(o)}catch(r){console.error(r)}}function gf(i,e,t){const s=`requestId=${e}&sessionTopic=${t}`;i.endsWith("/")&&(i=i.slice(0,-1));let r=`${i}`;if(i.startsWith("https://t.me")){const n=i.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${vf(s,!0)}`}else r=`${r}/wc?${s}`;return r}function yf(i){let e="_self";bf()?e="_top":(wf()||i.startsWith("https://")||i.startsWith("http://"))&&(e="_blank"),window.open(i,e,"noreferrer noopener")}async function mf(i,e){let t="";try{if(ki()&&(t=localStorage.getItem(e),t))return t;t=await i.getItem(e)}catch(s){console.error(s)}return t}function $o(i,e){if(!i.includes(e))return null;const t=i.split(/([&,?,=])/),s=t.indexOf(e);return t[s+2]}function So(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,i=>{const e=Math.random()*16|0;return(i==="x"?e:e&3|8).toString(16)})}function Mn(){return typeof process<"u"&&Wd.IS_VITEST==="true"}function wf(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function bf(){try{return window.self!==window.top}catch{return!1}}function vf(i,e=!1){const t=Buffer.from(i).toString("base64");return e?t.replace(/[=]/g,""):t}function ih(i){return Buffer.from(i,"base64").toString("utf-8")}function Ef(i){return new Promise(e=>setTimeout(e,i))}let If=class{constructor({limit:e}){_o(this,"limit"),_o(this,"set"),this.limit=e,this.set=new Set}add(e){if(!this.set.has(e)){if(this.set.size>=this.limit){const t=this.set.values().next().value;t&&this.set.delete(t)}this.set.add(e)}}has(e){return this.set.has(e)}};const Ts=BigInt(2**32-1),Ao=BigInt(32);function sh(i,e=!1){return e?{h:Number(i&Ts),l:Number(i>>Ao&Ts)}:{h:Number(i>>Ao&Ts)|0,l:Number(i&Ts)|0}}function rh(i,e=!1){const t=i.length;let s=new Uint32Array(t),r=new Uint32Array(t);for(let n=0;n<t;n++){const{h:o,l:a}=sh(i[n],e);[s[n],r[n]]=[o,a]}return[s,r]}const Oo=(i,e,t)=>i>>>t,To=(i,e,t)=>i<<32-t|e>>>t,qt=(i,e,t)=>i>>>t|e<<32-t,jt=(i,e,t)=>i<<32-t|e>>>t,es=(i,e,t)=>i<<64-t|e>>>t-32,ts=(i,e,t)=>i>>>t-32|e<<64-t,xf=(i,e)=>e,_f=(i,e)=>i,Pf=(i,e,t)=>i<<t|e>>>32-t,$f=(i,e,t)=>e<<t|i>>>32-t,Sf=(i,e,t)=>e<<t-32|i>>>64-t,Af=(i,e,t)=>i<<t-32|e>>>64-t;function rt(i,e,t,s){const r=(e>>>0)+(s>>>0);return{h:i+t+(r/2**32|0)|0,l:r|0}}const zn=(i,e,t)=>(i>>>0)+(e>>>0)+(t>>>0),Hn=(i,e,t,s)=>e+t+s+(i/2**32|0)|0,Of=(i,e,t,s)=>(i>>>0)+(e>>>0)+(t>>>0)+(s>>>0),Tf=(i,e,t,s,r)=>e+t+s+r+(i/2**32|0)|0,Rf=(i,e,t,s,r)=>(i>>>0)+(e>>>0)+(t>>>0)+(s>>>0)+(r>>>0),Uf=(i,e,t,s,r,n)=>e+t+s+r+n+(i/2**32|0)|0,hi=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function Fn(i){return i instanceof Uint8Array||ArrayBuffer.isView(i)&&i.constructor.name==="Uint8Array"}function $t(i){if(!Number.isSafeInteger(i)||i<0)throw new Error("positive integer expected, got "+i)}function Ye(i,...e){if(!Fn(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error("Uint8Array expected of length "+e+", got length="+i.length)}function Vn(i){if(typeof i!="function"||typeof i.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");$t(i.outputLen),$t(i.blockLen)}function Ft(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function Kn(i,e){Ye(i);const t=e.outputLen;if(i.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ps(i){return new Uint32Array(i.buffer,i.byteOffset,Math.floor(i.byteLength/4))}function Ze(...i){for(let e=0;e<i.length;e++)i[e].fill(0)}function Er(i){return new DataView(i.buffer,i.byteOffset,i.byteLength)}function ct(i,e){return i<<32-e|i>>>e}const nh=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function oh(i){return i<<24&4278190080|i<<8&16711680|i>>>8&65280|i>>>24&255}const Et=nh?i=>i:i=>oh(i);function Cf(i){for(let e=0;e<i.length;e++)i[e]=oh(i[e]);return i}const Lt=nh?i=>i:Cf,ah=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Nf=Array.from({length:256},(i,e)=>e.toString(16).padStart(2,"0"));function gs(i){if(Ye(i),ah)return i.toHex();let e="";for(let t=0;t<i.length;t++)e+=Nf[i[t]];return e}const bt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Ro(i){if(i>=bt._0&&i<=bt._9)return i-bt._0;if(i>=bt.A&&i<=bt.F)return i-(bt.A-10);if(i>=bt.a&&i<=bt.f)return i-(bt.a-10)}function Gn(i){if(typeof i!="string")throw new Error("hex string expected, got "+typeof i);if(ah)return Uint8Array.fromHex(i);const e=i.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const s=new Uint8Array(t);for(let r=0,n=0;r<t;r++,n+=2){const o=Ro(i.charCodeAt(n)),a=Ro(i.charCodeAt(n+1));if(o===void 0||a===void 0){const c=i[n]+i[n+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+n)}s[r]=o*16+a}return s}function Bf(i){if(typeof i!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(i))}function ot(i){return typeof i=="string"&&(i=Bf(i)),Ye(i),i}function ei(...i){let e=0;for(let s=0;s<i.length;s++){const r=i[s];Ye(r),e+=r.length}const t=new Uint8Array(e);for(let s=0,r=0;s<i.length;s++){const n=i[s];t.set(n,r),r+=n.length}return t}let nr=class{};function vs(i){const e=s=>i().update(ot(s)).digest(),t=i();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>i(),e}function kf(i){const e=(s,r)=>i(r).update(ot(s)).digest(),t=i({});return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=s=>i(s),e}function Di(i=32){if(hi&&typeof hi.getRandomValues=="function")return hi.getRandomValues(new Uint8Array(i));if(hi&&typeof hi.randomBytes=="function")return Uint8Array.from(hi.randomBytes(i));throw new Error("crypto.getRandomValues must be defined")}const Df=BigInt(0),Ki=BigInt(1),qf=BigInt(2),jf=BigInt(7),Lf=BigInt(256),Mf=BigInt(113),ch=[],hh=[],lh=[];for(let i=0,e=Ki,t=1,s=0;i<24;i++){[t,s]=[s,(2*t+3*s)%5],ch.push(2*(5*s+t)),hh.push((i+1)*(i+2)/2%64);let r=Df;for(let n=0;n<7;n++)e=(e<<Ki^(e>>jf)*Mf)%Lf,e&qf&&(r^=Ki<<(Ki<<BigInt(n))-Ki);lh.push(r)}const uh=rh(lh,!0),zf=uh[0],Hf=uh[1],Uo=(i,e,t)=>t>32?Sf(i,e,t):Pf(i,e,t),Co=(i,e,t)=>t>32?Af(i,e,t):$f(i,e,t);function Ff(i,e=24){const t=new Uint32Array(10);for(let s=24-e;s<24;s++){for(let o=0;o<10;o++)t[o]=i[o]^i[o+10]^i[o+20]^i[o+30]^i[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,h=t[c],l=t[c+1],u=Uo(h,l,1)^t[a],d=Co(h,l,1)^t[a+1];for(let p=0;p<50;p+=10)i[o+p]^=u,i[o+p+1]^=d}let r=i[2],n=i[3];for(let o=0;o<24;o++){const a=hh[o],c=Uo(r,n,a),h=Co(r,n,a),l=ch[o];r=i[l],n=i[l+1],i[l]=c,i[l+1]=h}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=i[o+a];for(let a=0;a<10;a++)i[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}i[0]^=zf[s],i[1]^=Hf[s]}Ze(t)}let Vf=class dh extends nr{constructor(e,t,s,r=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=t,this.outputLen=s,this.enableXOF=r,this.rounds=n,$t(s),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=ps(this.state)}clone(){return this._cloneInto()}keccak(){Lt(this.state32),Ff(this.state32,this.rounds),Lt(this.state32),this.posOut=0,this.pos=0}update(e){Ft(this),e=ot(e),Ye(e);const{blockLen:t,state:s}=this,r=e.length;for(let n=0;n<r;){const o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)s[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:t,pos:s,blockLen:r}=this;e[s]^=t,t&128&&s===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){Ft(this,!1),Ye(e),this.finish();const t=this.state,{blockLen:s}=this;for(let r=0,n=e.length;r<n;){this.posOut>=s&&this.keccak();const o=Math.min(s-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return $t(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(Kn(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,Ze(this.state)}_cloneInto(e){const{blockLen:t,suffix:s,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new dh(t,s,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=s,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}};const Kf=(i,e,t)=>vs(()=>new Vf(e,i,t)),Gf=Kf(1,136,256/8);function Wf(i,e,t,s){if(typeof i.setBigUint64=="function")return i.setBigUint64(e,t,s);const r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=s?4:0,h=s?0:4;i.setUint32(e+c,o,s),i.setUint32(e+h,a,s)}function Jf(i,e,t){return i&e^~i&t}function Yf(i,e,t){return i&e^i&t^e&t}let fh=class extends nr{constructor(e,t,s,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=s,this.isLE=r,this.buffer=new Uint8Array(e),this.view=Er(this.buffer)}update(e){Ft(this),e=ot(e),Ye(e);const{view:t,buffer:s,blockLen:r}=this,n=e.length;for(let o=0;o<n;){const a=Math.min(r-this.pos,n-o);if(a===r){const c=Er(e);for(;r<=n-o;o+=r)this.process(c,o);continue}s.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ft(this),Kn(e,this),this.finished=!0;const{buffer:t,view:s,blockLen:r,isLE:n}=this;let{pos:o}=this;t[o++]=128,Ze(this.buffer.subarray(o)),this.padOffset>r-o&&(this.process(s,0),o=0);for(let u=o;u<r;u++)t[u]=0;Wf(s,r-8,BigInt(this.length*8),n),this.process(s,0);const a=Er(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const h=c/4,l=this.get();if(h>l.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<h;u++)a.setUint32(4*u,l[u],n)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:s,length:r,finished:n,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=n,e.length=r,e.pos=a,r%t&&e.buffer.set(s),e}clone(){return this._cloneInto()}};const Rt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),_e=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]),Pe=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Zf=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ut=new Uint32Array(64);let Qf=class extends fh{constructor(e=32){super(64,e,8,!1),this.A=Rt[0]|0,this.B=Rt[1]|0,this.C=Rt[2]|0,this.D=Rt[3]|0,this.E=Rt[4]|0,this.F=Rt[5]|0,this.G=Rt[6]|0,this.H=Rt[7]|0}get(){const{A:e,B:t,C:s,D:r,E:n,F:o,G:a,H:c}=this;return[e,t,s,r,n,o,a,c]}set(e,t,s,r,n,o,a,c){this.A=e|0,this.B=t|0,this.C=s|0,this.D=r|0,this.E=n|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)Ut[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){const d=Ut[u-15],p=Ut[u-2],m=ct(d,7)^ct(d,18)^d>>>3,g=ct(p,17)^ct(p,19)^p>>>10;Ut[u]=g+Ut[u-7]+m+Ut[u-16]|0}let{A:s,B:r,C:n,D:o,E:a,F:c,G:h,H:l}=this;for(let u=0;u<64;u++){const d=ct(a,6)^ct(a,11)^ct(a,25),p=l+d+Jf(a,c,h)+Zf[u]+Ut[u]|0,m=(ct(s,2)^ct(s,13)^ct(s,22))+Yf(s,r,n)|0;l=h,h=c,c=a,a=o+p|0,o=n,n=r,r=s,s=p+m|0}s=s+this.A|0,r=r+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,h=h+this.G|0,l=l+this.H|0,this.set(s,r,n,o,a,c,h,l)}roundClean(){Ze(Ut)}destroy(){this.set(0,0,0,0,0,0,0,0),Ze(this.buffer)}};const ph=rh(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(i=>BigInt(i))),Xf=ph[0],ep=ph[1],Ct=new Uint32Array(80),Nt=new Uint32Array(80);let Wn=class extends fh{constructor(e=64){super(128,e,16,!1),this.Ah=Pe[0]|0,this.Al=Pe[1]|0,this.Bh=Pe[2]|0,this.Bl=Pe[3]|0,this.Ch=Pe[4]|0,this.Cl=Pe[5]|0,this.Dh=Pe[6]|0,this.Dl=Pe[7]|0,this.Eh=Pe[8]|0,this.El=Pe[9]|0,this.Fh=Pe[10]|0,this.Fl=Pe[11]|0,this.Gh=Pe[12]|0,this.Gl=Pe[13]|0,this.Hh=Pe[14]|0,this.Hl=Pe[15]|0}get(){const{Ah:e,Al:t,Bh:s,Bl:r,Ch:n,Cl:o,Dh:a,Dl:c,Eh:h,El:l,Fh:u,Fl:d,Gh:p,Gl:m,Hh:g,Hl:b}=this;return[e,t,s,r,n,o,a,c,h,l,u,d,p,m,g,b]}set(e,t,s,r,n,o,a,c,h,l,u,d,p,m,g,b){this.Ah=e|0,this.Al=t|0,this.Bh=s|0,this.Bl=r|0,this.Ch=n|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=h|0,this.El=l|0,this.Fh=u|0,this.Fl=d|0,this.Gh=p|0,this.Gl=m|0,this.Hh=g|0,this.Hl=b|0}process(e,t){for(let D=0;D<16;D++,t+=4)Ct[D]=e.getUint32(t),Nt[D]=e.getUint32(t+=4);for(let D=16;D<80;D++){const M=Ct[D-15]|0,R=Nt[D-15]|0,j=qt(M,R,1)^qt(M,R,8)^Oo(M,R,7),L=jt(M,R,1)^jt(M,R,8)^To(M,R,7),q=Ct[D-2]|0,y=Nt[D-2]|0,_=qt(q,y,19)^es(q,y,61)^Oo(q,y,6),E=jt(q,y,19)^ts(q,y,61)^To(q,y,6),v=Of(L,E,Nt[D-7],Nt[D-16]),P=Tf(v,j,_,Ct[D-7],Ct[D-16]);Ct[D]=P|0,Nt[D]=v|0}let{Ah:s,Al:r,Bh:n,Bl:o,Ch:a,Cl:c,Dh:h,Dl:l,Eh:u,El:d,Fh:p,Fl:m,Gh:g,Gl:b,Hh:T,Hl:$}=this;for(let D=0;D<80;D++){const M=qt(u,d,14)^qt(u,d,18)^es(u,d,41),R=jt(u,d,14)^jt(u,d,18)^ts(u,d,41),j=u&p^~u&g,L=d&m^~d&b,q=Rf($,R,L,ep[D],Nt[D]),y=Uf(q,T,M,j,Xf[D],Ct[D]),_=q|0,E=qt(s,r,28)^es(s,r,34)^es(s,r,39),v=jt(s,r,28)^ts(s,r,34)^ts(s,r,39),P=s&n^s&a^n&a,U=r&o^r&c^o&c;T=g|0,$=b|0,g=p|0,b=m|0,p=u|0,m=d|0,{h:u,l:d}=rt(h|0,l|0,y|0,_|0),h=a|0,l=c|0,a=n|0,c=o|0,n=s|0,o=r|0;const f=zn(_,v,U);s=Hn(f,y,E,P),r=f|0}({h:s,l:r}=rt(this.Ah|0,this.Al|0,s|0,r|0)),{h:n,l:o}=rt(this.Bh|0,this.Bl|0,n|0,o|0),{h:a,l:c}=rt(this.Ch|0,this.Cl|0,a|0,c|0),{h,l}=rt(this.Dh|0,this.Dl|0,h|0,l|0),{h:u,l:d}=rt(this.Eh|0,this.El|0,u|0,d|0),{h:p,l:m}=rt(this.Fh|0,this.Fl|0,p|0,m|0),{h:g,l:b}=rt(this.Gh|0,this.Gl|0,g|0,b|0),{h:T,l:$}=rt(this.Hh|0,this.Hl|0,T|0,$|0),this.set(s,r,n,o,a,c,h,l,u,d,p,m,g,b,T,$)}roundClean(){Ze(Ct,Nt)}destroy(){Ze(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},tp=class extends Wn{constructor(){super(48),this.Ah=_e[0]|0,this.Al=_e[1]|0,this.Bh=_e[2]|0,this.Bl=_e[3]|0,this.Ch=_e[4]|0,this.Cl=_e[5]|0,this.Dh=_e[6]|0,this.Dl=_e[7]|0,this.Eh=_e[8]|0,this.El=_e[9]|0,this.Fh=_e[10]|0,this.Fl=_e[11]|0,this.Gh=_e[12]|0,this.Gl=_e[13]|0,this.Hh=_e[14]|0,this.Hl=_e[15]|0}};const $e=Uint32Array.from([573645204,4230739756,2673172387,3360449730,596883563,1867755857,2520282905,1497426621,2519219938,2827943907,3193839141,1401305490,721525244,746961066,246885852,2177182882]);class ip extends Wn{constructor(){super(32),this.Ah=$e[0]|0,this.Al=$e[1]|0,this.Bh=$e[2]|0,this.Bl=$e[3]|0,this.Ch=$e[4]|0,this.Cl=$e[5]|0,this.Dh=$e[6]|0,this.Dl=$e[7]|0,this.Eh=$e[8]|0,this.El=$e[9]|0,this.Fh=$e[10]|0,this.Fl=$e[11]|0,this.Gh=$e[12]|0,this.Gl=$e[13]|0,this.Hh=$e[14]|0,this.Hl=$e[15]|0}}const or=vs(()=>new Qf),sp=vs(()=>new Wn),rp=vs(()=>new tp),np=vs(()=>new ip),op=Uint8Array.from([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9]),ue=Uint32Array.from([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),B=new Uint32Array(32);function Bt(i,e,t,s,r,n){const o=r[n],a=r[n+1];let c=B[2*i],h=B[2*i+1],l=B[2*e],u=B[2*e+1],d=B[2*t],p=B[2*t+1],m=B[2*s],g=B[2*s+1],b=zn(c,l,o);h=Hn(b,h,u,a),c=b|0,{Dh:g,Dl:m}={Dh:g^h,Dl:m^c},{Dh:g,Dl:m}={Dh:xf(g,m),Dl:_f(g)},{h:p,l:d}=rt(p,d,g,m),{Bh:u,Bl:l}={Bh:u^p,Bl:l^d},{Bh:u,Bl:l}={Bh:qt(u,l,24),Bl:jt(u,l,24)},B[2*i]=c,B[2*i+1]=h,B[2*e]=l,B[2*e+1]=u,B[2*t]=d,B[2*t+1]=p,B[2*s]=m,B[2*s+1]=g}function kt(i,e,t,s,r,n){const o=r[n],a=r[n+1];let c=B[2*i],h=B[2*i+1],l=B[2*e],u=B[2*e+1],d=B[2*t],p=B[2*t+1],m=B[2*s],g=B[2*s+1],b=zn(c,l,o);h=Hn(b,h,u,a),c=b|0,{Dh:g,Dl:m}={Dh:g^h,Dl:m^c},{Dh:g,Dl:m}={Dh:qt(g,m,16),Dl:jt(g,m,16)},{h:p,l:d}=rt(p,d,g,m),{Bh:u,Bl:l}={Bh:u^p,Bl:l^d},{Bh:u,Bl:l}={Bh:es(u,l,63),Bl:ts(u,l,63)},B[2*i]=c,B[2*i+1]=h,B[2*e]=l,B[2*e+1]=u,B[2*t]=d,B[2*t+1]=p,B[2*s]=m,B[2*s+1]=g}function ap(i,e={},t,s,r){if($t(t),i<0||i>t)throw new Error("outputLen bigger than keyLen");const{key:n,salt:o,personalization:a}=e;if(n!==void 0&&(n.length<1||n.length>t))throw new Error("key length must be undefined or 1.."+t);if(o!==void 0&&o.length!==s)throw new Error("salt must be undefined or "+s);if(a!==void 0&&a.length!==r)throw new Error("personalization must be undefined or "+r)}class cp extends nr{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,this.length=0,this.pos=0,$t(e),$t(t),this.blockLen=e,this.outputLen=t,this.buffer=new Uint8Array(e),this.buffer32=ps(this.buffer)}update(e){Ft(this),e=ot(e),Ye(e);const{blockLen:t,buffer:s,buffer32:r}=this,n=e.length,o=e.byteOffset,a=e.buffer;for(let c=0;c<n;){this.pos===t&&(Lt(r),this.compress(r,0,!1),Lt(r),this.pos=0);const h=Math.min(t-this.pos,n-c),l=o+c;if(h===t&&!(l%4)&&c+h<n){const u=new Uint32Array(a,l,Math.floor((n-c)/4));Lt(u);for(let d=0;c+t<n;d+=r.length,c+=t)this.length+=t,this.compress(u,d,!1);Lt(u);continue}s.set(e.subarray(c,c+h),this.pos),this.pos+=h,this.length+=h,c+=h}return this}digestInto(e){Ft(this),Kn(e,this);const{pos:t,buffer32:s}=this;this.finished=!0,Ze(this.buffer.subarray(t)),Lt(s),this.compress(s,0,!0),Lt(s);const r=ps(e);this.get().forEach((n,o)=>r[o]=Et(n))}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}_cloneInto(e){const{buffer:t,length:s,finished:r,destroyed:n,outputLen:o,pos:a}=this;return e||(e=new this.constructor({dkLen:o})),e.set(...this.get()),e.buffer.set(t),e.destroyed=n,e.finished=r,e.length=s,e.pos=a,e.outputLen=o,e}clone(){return this._cloneInto()}}class hp extends cp{constructor(e={}){const t=e.dkLen===void 0?64:e.dkLen;super(128,t),this.v0l=ue[0]|0,this.v0h=ue[1]|0,this.v1l=ue[2]|0,this.v1h=ue[3]|0,this.v2l=ue[4]|0,this.v2h=ue[5]|0,this.v3l=ue[6]|0,this.v3h=ue[7]|0,this.v4l=ue[8]|0,this.v4h=ue[9]|0,this.v5l=ue[10]|0,this.v5h=ue[11]|0,this.v6l=ue[12]|0,this.v6h=ue[13]|0,this.v7l=ue[14]|0,this.v7h=ue[15]|0,ap(t,e,64,16,16);let{key:s,personalization:r,salt:n}=e,o=0;if(s!==void 0&&(s=ot(s),o=s.length),this.v0l^=this.outputLen|o<<8|65536|1<<24,n!==void 0){n=ot(n);const a=ps(n);this.v4l^=Et(a[0]),this.v4h^=Et(a[1]),this.v5l^=Et(a[2]),this.v5h^=Et(a[3])}if(r!==void 0){r=ot(r);const a=ps(r);this.v6l^=Et(a[0]),this.v6h^=Et(a[1]),this.v7l^=Et(a[2]),this.v7h^=Et(a[3])}if(s!==void 0){const a=new Uint8Array(this.blockLen);a.set(s),this.update(a)}}get(){let{v0l:e,v0h:t,v1l:s,v1h:r,v2l:n,v2h:o,v3l:a,v3h:c,v4l:h,v4h:l,v5l:u,v5h:d,v6l:p,v6h:m,v7l:g,v7h:b}=this;return[e,t,s,r,n,o,a,c,h,l,u,d,p,m,g,b]}set(e,t,s,r,n,o,a,c,h,l,u,d,p,m,g,b){this.v0l=e|0,this.v0h=t|0,this.v1l=s|0,this.v1h=r|0,this.v2l=n|0,this.v2h=o|0,this.v3l=a|0,this.v3h=c|0,this.v4l=h|0,this.v4h=l|0,this.v5l=u|0,this.v5h=d|0,this.v6l=p|0,this.v6h=m|0,this.v7l=g|0,this.v7h=b|0}compress(e,t,s){this.get().forEach((c,h)=>B[h]=c),B.set(ue,16);let{h:r,l:n}=sh(BigInt(this.length));B[24]=ue[8]^n,B[25]=ue[9]^r,s&&(B[28]=~B[28],B[29]=~B[29]);let o=0;const a=op;for(let c=0;c<12;c++)Bt(0,4,8,12,e,t+2*a[o++]),kt(0,4,8,12,e,t+2*a[o++]),Bt(1,5,9,13,e,t+2*a[o++]),kt(1,5,9,13,e,t+2*a[o++]),Bt(2,6,10,14,e,t+2*a[o++]),kt(2,6,10,14,e,t+2*a[o++]),Bt(3,7,11,15,e,t+2*a[o++]),kt(3,7,11,15,e,t+2*a[o++]),Bt(0,5,10,15,e,t+2*a[o++]),kt(0,5,10,15,e,t+2*a[o++]),Bt(1,6,11,12,e,t+2*a[o++]),kt(1,6,11,12,e,t+2*a[o++]),Bt(2,7,8,13,e,t+2*a[o++]),kt(2,7,8,13,e,t+2*a[o++]),Bt(3,4,9,14,e,t+2*a[o++]),kt(3,4,9,14,e,t+2*a[o++]);this.v0l^=B[0]^B[16],this.v0h^=B[1]^B[17],this.v1l^=B[2]^B[18],this.v1h^=B[3]^B[19],this.v2l^=B[4]^B[20],this.v2h^=B[5]^B[21],this.v3l^=B[6]^B[22],this.v3h^=B[7]^B[23],this.v4l^=B[8]^B[24],this.v4h^=B[9]^B[25],this.v5l^=B[10]^B[26],this.v5h^=B[11]^B[27],this.v6l^=B[12]^B[28],this.v6h^=B[13]^B[29],this.v7l^=B[14]^B[30],this.v7h^=B[15]^B[31],Ze(B)}destroy(){this.destroyed=!0,Ze(this.buffer32),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const lp=kf(i=>new hp(i)),up="https://rpc.walletconnect.org/v1";function gh(i){const e=`Ethereum Signed Message:
${i.length}`,t=new TextEncoder().encode(e+i);return"0x"+Buffer.from(Gf(t)).toString("hex")}async function dp(i,e,t,s,r,n){switch(t.t){case"eip191":return await fp(i,e,t.s);case"eip1271":return await pp(i,e,t.s,s,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}async function fp(i,e,t){return(await td({hash:gh(e),signature:t})).toLowerCase()===i.toLowerCase()}async function pp(i,e,t,s,r,n){const o=Ai(s);if(!o.namespace||!o.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${s}`);try{const a="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",h=t.substring(2),l=(h.length/2).toString(16).padStart(64,"0"),u=(e.startsWith("0x")?e:gh(e)).substring(2),d=a+u+c+l+h,p=await fetch(`${n||up}/?chainId=${s}&projectId=${r}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({id:gp(),jsonrpc:"2.0",method:"eth_call",params:[{to:i,data:d},"latest"]})}),{result:m}=await p.json();return m?m.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function gp(){return Date.now()+Math.floor(Math.random()*1e3)}function yp(i){const e=atob(i),t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);const s=t[0];if(s===0)throw new Error("No signatures found");const r=1+s*64;if(t.length<r)throw new Error("Transaction data too short for claimed signature count");if(t.length<100)throw new Error("Transaction too short");const n=Buffer.from(i,"base64").slice(1,65);return ws.encode(n)}function mp(i){const e=new Uint8Array(Buffer.from(i,"base64")),t=Array.from("TransactionData::").map(n=>n.charCodeAt(0)),s=new Uint8Array(t.length+e.length);s.set(t),s.set(e,t.length);const r=lp(s,{dkLen:32});return ws.encode(r)}function No(i){const e=new Uint8Array(or(wp(i)));return ws.encode(e)}function wp(i){if(i instanceof Uint8Array)return i;if(Array.isArray(i))return new Uint8Array(i);if(typeof i=="object"&&i!=null&&i.data)return new Uint8Array(Object.values(i.data));if(typeof i=="object"&&i)return new Uint8Array(Object.values(i));throw new Error("getNearUint8ArrayFromBytes: Unexpected result type from bytes array")}function Bo(i){const e=Buffer.from(i,"base64"),t=Bd(e).txn;if(!t)throw new Error("Invalid signed transaction: missing 'txn' field");const s=Sd(t),r=Buffer.from("TX"),n=Buffer.concat([r,Buffer.from(s)]),o=np(n);return Kl.encode(o).replace(/=+$/,"")}function Ir(i){const e=[];let t=BigInt(i);for(;t>=BigInt(128);)e.push(Number(t&BigInt(127)|BigInt(128))),t>>=BigInt(7);return e.push(Number(t)),Buffer.from(e)}function bp(i){const e=Buffer.from(i.signed.bodyBytes,"base64"),t=Buffer.from(i.signed.authInfoBytes,"base64"),s=Buffer.from(i.signature.signature,"base64"),r=[];r.push(Buffer.from([10])),r.push(Ir(e.length)),r.push(e),r.push(Buffer.from([18])),r.push(Ir(t.length)),r.push(t),r.push(Buffer.from([26])),r.push(Ir(s.length)),r.push(s);const n=Buffer.concat(r),o=or(n);return Buffer.from(o).toString("hex").toUpperCase()}var vp=Object.defineProperty,Ep=Object.defineProperties,Ip=Object.getOwnPropertyDescriptors,ko=Object.getOwnPropertySymbols,xp=Object.prototype.hasOwnProperty,_p=Object.prototype.propertyIsEnumerable,Do=(i,e,t)=>e in i?vp(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Pp=(i,e)=>{for(var t in e||(e={}))xp.call(e,t)&&Do(i,t,e[t]);if(ko)for(var t of ko(e))_p.call(e,t)&&Do(i,t,e[t]);return i},$p=(i,e)=>Ep(i,Ip(e));const Sp="did:pkh:",Jn=i=>i==null?void 0:i.split(":"),Ap=i=>{const e=i&&Jn(i);if(e)return i.includes(Sp)?e[3]:e[1]},en=i=>{const e=i&&Jn(i);if(e)return e[2]+":"+e[3]},Qs=i=>{const e=i&&Jn(i);if(e)return e.pop()};async function qo(i){const{cacao:e,projectId:t}=i,{s,p:r}=e,n=yh(r,r.iss),o=Qs(r.iss);return await dp(o,n,s,en(r.iss),t)}const yh=(i,e)=>{const t=`${i.domain} wants you to sign in with your Ethereum account:`,s=Qs(e);if(!i.aud&&!i.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let r=i.statement||void 0;const n=`URI: ${i.aud||i.uri}`,o=`Version: ${i.version}`,a=`Chain ID: ${Ap(e)}`,c=`Nonce: ${i.nonce}`,h=`Issued At: ${i.iat}`,l=i.exp?`Expiration Time: ${i.exp}`:void 0,u=i.nbf?`Not Before: ${i.nbf}`:void 0,d=i.requestId?`Request ID: ${i.requestId}`:void 0,p=i.resources?`Resources:${i.resources.map(g=>`
- ${g}`).join("")}`:void 0,m=zs(i.resources);if(m){const g=ys(m);r=Dp(r,g)}return[t,s,"",r,"",n,o,a,c,h,l,u,d,p].filter(g=>g!=null).join(`
`)};function Op(i){return Buffer.from(JSON.stringify(i)).toString("base64")}function Tp(i){return JSON.parse(Buffer.from(i,"base64").toString("utf-8"))}function ri(i){if(!i)throw new Error("No recap provided, value is undefined");if(!i.att)throw new Error("No `att` property found");const e=Object.keys(i.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(t=>{const s=i.att[t];if(Array.isArray(s))throw new Error(`Resource must be an object: ${t}`);if(typeof s!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(s).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(s).forEach(r=>{const n=s[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(o=>{if(typeof o!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${o}`)})})})}function Rp(i,e,t,s={}){return t==null||t.sort((r,n)=>r.localeCompare(n)),{att:{[i]:Up(e,t,s)}}}function Up(i,e,t={}){e=e==null?void 0:e.sort((r,n)=>r.localeCompare(n));const s=e.map(r=>({[`${i}/${r}`]:[t]}));return Object.assign({},...s)}function mh(i){return ri(i),`urn:recap:${Op(i).replace(/=/g,"")}`}function ys(i){const e=Tp(i.replace("urn:recap:",""));return ri(e),e}function Cp(i,e,t){const s=Rp(i,e,t);return mh(s)}function Np(i){return i&&i.includes("urn:recap:")}function Bp(i,e){const t=ys(i),s=ys(e),r=kp(t,s);return mh(r)}function kp(i,e){ri(i),ri(e);const t=Object.keys(i.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),s={att:{}};return t.forEach(r=>{var n,o;Object.keys(((n=i.att)==null?void 0:n[r])||{}).concat(Object.keys(((o=e.att)==null?void 0:o[r])||{})).sort((a,c)=>a.localeCompare(c)).forEach(a=>{var c,h;s.att[r]=$p(Pp({},s.att[r]),{[a]:((c=i.att[r])==null?void 0:c[a])||((h=e.att[r])==null?void 0:h[a])})})}),s}function Dp(i="",e){ri(e);const t="I further authorize the stated URI to perform the following actions on my behalf: ";if(i.includes(t))return i;const s=[];let r=0;Object.keys(e.att).forEach(a=>{const c=Object.keys(e.att[a]).map(u=>({ability:u.split("/")[0],action:u.split("/")[1]}));c.sort((u,d)=>u.action.localeCompare(d.action));const h={};c.forEach(u=>{h[u.ability]||(h[u.ability]=[]),h[u.ability].push(u.action)});const l=Object.keys(h).map(u=>(r++,`(${r}) '${u}': '${h[u].join("', '")}' for '${a}'.`));s.push(l.join(", ").replace(".,","."))});const n=s.join(" "),o=`${t}${n}`;return`${i?i+" ":""}${o}`}function jo(i){var e;const t=ys(i);ri(t);const s=(e=t.att)==null?void 0:e.eip155;return s?Object.keys(s).map(r=>r.split("/")[1]):[]}function Lo(i){const e=ys(i);ri(e);const t=[];return Object.values(e.att).forEach(s=>{Object.values(s).forEach(r=>{var n;(n=r==null?void 0:r[0])!=null&&n.chains&&t.push(r[0].chains)})}),[...new Set(t.flat())]}function zs(i){if(!i)return;const e=i==null?void 0:i[i.length-1];return Np(e)?e:void 0}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function wh(i){return i instanceof Uint8Array||ArrayBuffer.isView(i)&&i.constructor.name==="Uint8Array"}function tn(i){if(typeof i!="boolean")throw new Error(`boolean expected, not ${i}`)}function xr(i){if(!Number.isSafeInteger(i)||i<0)throw new Error("positive integer expected, got "+i)}function Be(i,...e){if(!wh(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error("Uint8Array expected of length "+e+", got length="+i.length)}function Mo(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function qp(i,e){Be(i);const t=e.outputLen;if(i.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ht(i){return new Uint32Array(i.buffer,i.byteOffset,Math.floor(i.byteLength/4))}function Ti(...i){for(let e=0;e<i.length;e++)i[e].fill(0)}function jp(i){return new DataView(i.buffer,i.byteOffset,i.byteLength)}const Lp=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Mp(i){if(typeof i!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(i))}function sn(i){if(typeof i=="string")i=Mp(i);else if(wh(i))i=rn(i);else throw new Error("Uint8Array expected, got "+typeof i);return i}function zp(i,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(i,e)}function Hp(i,e){if(i.length!==e.length)return!1;let t=0;for(let s=0;s<i.length;s++)t|=i[s]^e[s];return t===0}const Fp=(i,e)=>{function t(s,...r){if(Be(s),!Lp)throw new Error("Non little-endian hardware is not yet supported");if(i.nonceLength!==void 0){const h=r[0];if(!h)throw new Error("nonce / iv required");i.varSizeNonce?Be(h):Be(h,i.nonceLength)}const n=i.tagLength;n&&r[1]!==void 0&&Be(r[1]);const o=e(s,...r),a=(h,l)=>{if(l!==void 0){if(h!==2)throw new Error("cipher output not supported");Be(l)}};let c=!1;return{encrypt(h,l){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Be(h),a(o.encrypt.length,l),o.encrypt(h,l)},decrypt(h,l){if(Be(h),n&&h.length<n)throw new Error("invalid ciphertext length: smaller than tagLength="+n);return a(o.decrypt.length,l),o.decrypt(h,l)}}}return Object.assign(t,i),t};function zo(i,e,t=!0){if(e===void 0)return new Uint8Array(i);if(e.length!==i)throw new Error("invalid output length, expected "+i+", got: "+e.length);if(t&&!Kp(e))throw new Error("invalid output, must be aligned");return e}function Ho(i,e,t,s){if(typeof i.setBigUint64=="function")return i.setBigUint64(e,t,s);const r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n);i.setUint32(e+4,o,s),i.setUint32(e+0,a,s)}function Vp(i,e,t){tn(t);const s=new Uint8Array(16),r=jp(s);return Ho(r,0,BigInt(e),t),Ho(r,8,BigInt(i),t),s}function Kp(i){return i.byteOffset%4===0}function rn(i){return Uint8Array.from(i)}const bh=i=>Uint8Array.from(i.split("").map(e=>e.charCodeAt(0))),Gp=bh("expand 16-byte k"),Wp=bh("expand 32-byte k"),Jp=Ht(Gp),Yp=Ht(Wp);function J(i,e){return i<<e|i>>>32-e}function nn(i){return i.byteOffset%4===0}const Rs=64,Zp=16,vh=2**32-1,Fo=new Uint32Array;function Qp(i,e,t,s,r,n,o,a){const c=r.length,h=new Uint8Array(Rs),l=Ht(h),u=nn(r)&&nn(n),d=u?Ht(r):Fo,p=u?Ht(n):Fo;for(let m=0;m<c;o++){if(i(e,t,s,l,o,a),o>=vh)throw new Error("arx: counter overflow");const g=Math.min(Rs,c-m);if(u&&g===Rs){const b=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let T=0,$;T<Zp;T++)$=b+T,p[$]=d[$]^l[T];m+=Rs;continue}for(let b=0,T;b<g;b++)T=m+b,n[T]=r[T]^h[b];m+=g}}function Xp(i,e){const{allowShortKeys:t,extendNonceFn:s,counterLength:r,counterRight:n,rounds:o}=zp({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof i!="function")throw new Error("core must be a function");return xr(r),xr(o),tn(n),tn(t),(a,c,h,l,u=0)=>{Be(a),Be(c),Be(h);const d=h.length;if(l===void 0&&(l=new Uint8Array(d)),Be(l),xr(u),u<0||u>=vh)throw new Error("arx: counter overflow");if(l.length<d)throw new Error(`arx: output (${l.length}) is shorter than data (${d})`);const p=[];let m=a.length,g,b;if(m===32)p.push(g=rn(a)),b=Yp;else if(m===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),b=Jp,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);nn(c)||p.push(c=rn(c));const T=Ht(g);if(s){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");s(b,T,Ht(c.subarray(0,16)),T),c=c.subarray(16)}const $=16-r;if($!==c.length)throw new Error(`arx: nonce must be ${$} or 16 bytes`);if($!==12){const M=new Uint8Array(12);M.set(c,n?0:12-c.length),c=M,p.push(c)}const D=Ht(c);return Qp(i,b,T,D,h,l,u,o),Ti(...p),l}}const me=(i,e)=>i[e++]&255|(i[e++]&255)<<8;class eg{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=sn(e),Be(e,32);const t=me(e,0),s=me(e,2),r=me(e,4),n=me(e,6),o=me(e,8),a=me(e,10),c=me(e,12),h=me(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|s<<3)&8191,this.r[2]=(s>>>10|r<<6)&7939,this.r[3]=(r>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|h<<8)&8191,this.r[9]=h>>>5&127;for(let l=0;l<8;l++)this.pad[l]=me(e,16+2*l)}process(e,t,s=!1){const r=s?0:2048,{h:n,r:o}=this,a=o[0],c=o[1],h=o[2],l=o[3],u=o[4],d=o[5],p=o[6],m=o[7],g=o[8],b=o[9],T=me(e,t+0),$=me(e,t+2),D=me(e,t+4),M=me(e,t+6),R=me(e,t+8),j=me(e,t+10),L=me(e,t+12),q=me(e,t+14);let y=n[0]+(T&8191),_=n[1]+((T>>>13|$<<3)&8191),E=n[2]+(($>>>10|D<<6)&8191),v=n[3]+((D>>>7|M<<9)&8191),P=n[4]+((M>>>4|R<<12)&8191),U=n[5]+(R>>>1&8191),f=n[6]+((R>>>14|j<<2)&8191),w=n[7]+((j>>>11|L<<5)&8191),I=n[8]+((L>>>8|q<<8)&8191),S=n[9]+(q>>>5|r),x=0,A=x+y*a+_*(5*b)+E*(5*g)+v*(5*m)+P*(5*p);x=A>>>13,A&=8191,A+=U*(5*d)+f*(5*u)+w*(5*l)+I*(5*h)+S*(5*c),x+=A>>>13,A&=8191;let k=x+y*c+_*a+E*(5*b)+v*(5*g)+P*(5*m);x=k>>>13,k&=8191,k+=U*(5*p)+f*(5*d)+w*(5*u)+I*(5*l)+S*(5*h),x+=k>>>13,k&=8191;let H=x+y*h+_*c+E*a+v*(5*b)+P*(5*g);x=H>>>13,H&=8191,H+=U*(5*m)+f*(5*p)+w*(5*d)+I*(5*u)+S*(5*l),x+=H>>>13,H&=8191;let K=x+y*l+_*h+E*c+v*a+P*(5*b);x=K>>>13,K&=8191,K+=U*(5*g)+f*(5*m)+w*(5*p)+I*(5*d)+S*(5*u),x+=K>>>13,K&=8191;let z=x+y*u+_*l+E*h+v*c+P*a;x=z>>>13,z&=8191,z+=U*(5*b)+f*(5*g)+w*(5*m)+I*(5*p)+S*(5*d),x+=z>>>13,z&=8191;let F=x+y*d+_*u+E*l+v*h+P*c;x=F>>>13,F&=8191,F+=U*a+f*(5*b)+w*(5*g)+I*(5*m)+S*(5*p),x+=F>>>13,F&=8191;let ee=x+y*p+_*d+E*u+v*l+P*h;x=ee>>>13,ee&=8191,ee+=U*c+f*a+w*(5*b)+I*(5*g)+S*(5*m),x+=ee>>>13,ee&=8191;let ce=x+y*m+_*p+E*d+v*u+P*l;x=ce>>>13,ce&=8191,ce+=U*h+f*c+w*a+I*(5*b)+S*(5*g),x+=ce>>>13,ce&=8191;let ae=x+y*g+_*m+E*p+v*d+P*u;x=ae>>>13,ae&=8191,ae+=U*l+f*h+w*c+I*a+S*(5*b),x+=ae>>>13,ae&=8191;let oe=x+y*b+_*g+E*m+v*p+P*d;x=oe>>>13,oe&=8191,oe+=U*u+f*l+w*h+I*c+S*a,x+=oe>>>13,oe&=8191,x=(x<<2)+x|0,x=x+A|0,A=x&8191,x=x>>>13,k+=x,n[0]=A,n[1]=k,n[2]=H,n[3]=K,n[4]=z,n[5]=F,n[6]=ee,n[7]=ce,n[8]=ae,n[9]=oe}finalize(){const{h:e,pad:t}=this,s=new Uint16Array(10);let r=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=r,r=e[a]>>>13,e[a]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,s[0]=e[0]+5,r=s[0]>>>13,s[0]&=8191;for(let a=1;a<10;a++)s[a]=e[a]+r,r=s[a]>>>13,s[a]&=8191;s[9]-=8192;let n=(r^1)-1;for(let a=0;a<10;a++)s[a]&=n;n=~n;for(let a=0;a<10;a++)e[a]=e[a]&n|s[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Ti(s)}update(e){Mo(this),e=sn(e),Be(e);const{buffer:t,blockLen:s}=this,r=e.length;for(let n=0;n<r;){const o=Math.min(s-this.pos,r-n);if(o===s){for(;s<=r-n;n+=s)this.process(e,n);continue}t.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===s&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Ti(this.h,this.r,this.buffer,this.pad)}digestInto(e){Mo(this),qp(e,this),this.finished=!0;const{buffer:t,h:s}=this;let{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let n=0;for(let o=0;o<8;o++)e[n++]=s[o]>>>0,e[n++]=s[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}}function tg(i){const e=(s,r)=>i(r).update(sn(s)).digest(),t=i(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=s=>i(s),e}const ig=tg(i=>new eg(i));function sg(i,e,t,s,r,n=20){let o=i[0],a=i[1],c=i[2],h=i[3],l=e[0],u=e[1],d=e[2],p=e[3],m=e[4],g=e[5],b=e[6],T=e[7],$=r,D=t[0],M=t[1],R=t[2],j=o,L=a,q=c,y=h,_=l,E=u,v=d,P=p,U=m,f=g,w=b,I=T,S=$,x=D,A=M,k=R;for(let K=0;K<n;K+=2)j=j+_|0,S=J(S^j,16),U=U+S|0,_=J(_^U,12),j=j+_|0,S=J(S^j,8),U=U+S|0,_=J(_^U,7),L=L+E|0,x=J(x^L,16),f=f+x|0,E=J(E^f,12),L=L+E|0,x=J(x^L,8),f=f+x|0,E=J(E^f,7),q=q+v|0,A=J(A^q,16),w=w+A|0,v=J(v^w,12),q=q+v|0,A=J(A^q,8),w=w+A|0,v=J(v^w,7),y=y+P|0,k=J(k^y,16),I=I+k|0,P=J(P^I,12),y=y+P|0,k=J(k^y,8),I=I+k|0,P=J(P^I,7),j=j+E|0,k=J(k^j,16),w=w+k|0,E=J(E^w,12),j=j+E|0,k=J(k^j,8),w=w+k|0,E=J(E^w,7),L=L+v|0,S=J(S^L,16),I=I+S|0,v=J(v^I,12),L=L+v|0,S=J(S^L,8),I=I+S|0,v=J(v^I,7),q=q+P|0,x=J(x^q,16),U=U+x|0,P=J(P^U,12),q=q+P|0,x=J(x^q,8),U=U+x|0,P=J(P^U,7),y=y+_|0,A=J(A^y,16),f=f+A|0,_=J(_^f,12),y=y+_|0,A=J(A^y,8),f=f+A|0,_=J(_^f,7);let H=0;s[H++]=o+j|0,s[H++]=a+L|0,s[H++]=c+q|0,s[H++]=h+y|0,s[H++]=l+_|0,s[H++]=u+E|0,s[H++]=d+v|0,s[H++]=p+P|0,s[H++]=m+U|0,s[H++]=g+f|0,s[H++]=b+w|0,s[H++]=T+I|0,s[H++]=$+S|0,s[H++]=D+x|0,s[H++]=M+A|0,s[H++]=R+k|0}const rg=Xp(sg,{counterRight:!1,counterLength:4,allowShortKeys:!1}),ng=new Uint8Array(16),Vo=(i,e)=>{i.update(e);const t=e.length%16;t&&i.update(ng.subarray(t))},og=new Uint8Array(32);function Ko(i,e,t,s,r){const n=i(e,t,og),o=ig.create(n);r&&Vo(o,r),Vo(o,s);const a=Vp(s.length,r?r.length:0,!0);o.update(a);const c=o.digest();return Ti(n,a),c}const ag=i=>(e,t,s)=>({encrypt(r,n){const o=r.length;n=zo(o+16,n,!1),n.set(r);const a=n.subarray(0,-16);i(e,t,a,a,1);const c=Ko(i,e,t,a,s);return n.set(c,o),Ti(c),n},decrypt(r,n){n=zo(r.length-16,n,!1);const o=r.subarray(0,-16),a=r.subarray(-16),c=Ko(i,e,t,o,s);if(!Hp(a,c))throw new Error("invalid tag");return n.set(r.subarray(0,-16)),i(e,t,n,n,1),Ti(c),n}}),Eh=Fp({blockSize:64,nonceLength:12,tagLength:16},ag(rg));let Ih=class extends nr{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Vn(e);const s=ot(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,n=new Uint8Array(r);n.set(s.length>r?e.create().update(s).digest():s);for(let o=0;o<n.length;o++)n[o]^=54;this.iHash.update(n),this.oHash=e.create();for(let o=0;o<n.length;o++)n[o]^=106;this.oHash.update(n),Ze(n)}update(e){return Ft(this),this.iHash.update(e),this}digestInto(e){Ft(this),Ye(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:s,finished:r,destroyed:n,blockLen:o,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const ar=(i,e,t)=>new Ih(i,e).update(t).digest();ar.create=(i,e)=>new Ih(i,e);function cg(i,e,t){return Vn(i),t===void 0&&(t=new Uint8Array(i.outputLen)),ar(i,ot(t),ot(e))}const _r=Uint8Array.from([0]),Go=Uint8Array.of();function hg(i,e,t,s=32){Vn(i),$t(s);const r=i.outputLen;if(s>255*r)throw new Error("Length should be <= 255*HashLen");const n=Math.ceil(s/r);t===void 0&&(t=Go);const o=new Uint8Array(n*r),a=ar.create(i,e),c=a._cloneInto(),h=new Uint8Array(a.outputLen);for(let l=0;l<n;l++)_r[0]=l+1,c.update(l===0?Go:h).update(t).update(_r).digestInto(h),o.set(h,r*l),a._cloneInto(c);return a.destroy(),c.destroy(),Ze(h,_r),o.slice(0,s)}const lg=(i,e,t,s,r)=>hg(i,cg(i,e,t),s,r),cr=or,Yn=BigInt(0),on=BigInt(1);function Xs(i,e){if(typeof e!="boolean")throw new Error(i+" boolean expected, got "+e)}function Us(i){const e=i.toString(16);return e.length&1?"0"+e:e}function xh(i){if(typeof i!="string")throw new Error("hex string expected, got "+typeof i);return i===""?Yn:BigInt("0x"+i)}function hr(i){return xh(gs(i))}function er(i){return Ye(i),xh(gs(Uint8Array.from(i).reverse()))}function Zn(i,e){return Gn(i.toString(16).padStart(e*2,"0"))}function Qn(i,e){return Zn(i,e).reverse()}function Ne(i,e,t){let s;if(typeof e=="string")try{s=Gn(e)}catch(n){throw new Error(i+" must be hex string or Uint8Array, cause: "+n)}else if(Fn(e))s=Uint8Array.from(e);else throw new Error(i+" must be hex string or Uint8Array");const r=s.length;if(typeof t=="number"&&r!==t)throw new Error(i+" of length "+t+" expected, got "+r);return s}const Pr=i=>typeof i=="bigint"&&Yn<=i;function ug(i,e,t){return Pr(i)&&Pr(e)&&Pr(t)&&e<=i&&i<t}function an(i,e,t,s){if(!ug(e,t,s))throw new Error("expected valid "+i+": "+t+" <= n < "+s+", got "+e)}function dg(i){let e;for(e=0;i>Yn;i>>=on,e+=1);return e}const lr=i=>(on<<BigInt(i))-on;function fg(i,e,t){if(typeof i!="number"||i<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const s=d=>new Uint8Array(d),r=d=>Uint8Array.of(d);let n=s(i),o=s(i),a=0;const c=()=>{n.fill(1),o.fill(0),a=0},h=(...d)=>t(o,n,...d),l=(d=s(0))=>{o=h(r(0),d),n=h(),d.length!==0&&(o=h(r(1),d),n=h())},u=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const p=[];for(;d<e;){n=h();const m=n.slice();p.push(m),d+=n.length}return ei(...p)};return(d,p)=>{c(),l(d);let m;for(;!(m=p(u()));)l();return c(),m}}function ur(i,e,t={}){if(!i||typeof i!="object")throw new Error("expected valid options object");function s(r,n,o){const a=i[r];if(o&&a===void 0)return;const c=typeof a;if(c!==n||a===null)throw new Error(`param "${r}" is invalid: expected ${n}, got ${c}`)}Object.entries(e).forEach(([r,n])=>s(r,n,!1)),Object.entries(t).forEach(([r,n])=>s(r,n,!0))}function Wo(i){const e=new WeakMap;return(t,...s)=>{const r=e.get(t);if(r!==void 0)return r;const n=i(t,...s);return e.set(t,n),n}}const ke=BigInt(0),Ae=BigInt(1),ti=BigInt(2),pg=BigInt(3),_h=BigInt(4),Ph=BigInt(5),$h=BigInt(8);function We(i,e){const t=i%e;return t>=ke?t:e+t}function st(i,e,t){let s=i;for(;e-- >ke;)s*=s,s%=t;return s}function Jo(i,e){if(i===ke)throw new Error("invert: expected non-zero number");if(e<=ke)throw new Error("invert: expected positive modulus, got "+e);let t=We(i,e),s=e,r=ke,n=Ae;for(;t!==ke;){const o=s/t,a=s%t,c=r-n*o;s=t,t=a,r=n,n=c}if(s!==Ae)throw new Error("invert: does not exist");return We(r,e)}function Sh(i,e){const t=(i.ORDER+Ae)/_h,s=i.pow(e,t);if(!i.eql(i.sqr(s),e))throw new Error("Cannot find square root");return s}function gg(i,e){const t=(i.ORDER-Ph)/$h,s=i.mul(e,ti),r=i.pow(s,t),n=i.mul(e,r),o=i.mul(i.mul(n,ti),r),a=i.mul(n,i.sub(o,i.ONE));if(!i.eql(i.sqr(a),e))throw new Error("Cannot find square root");return a}function yg(i){if(i<BigInt(3))throw new Error("sqrt is not defined for small field");let e=i-Ae,t=0;for(;e%ti===ke;)e/=ti,t++;let s=ti;const r=qi(i);for(;Yo(r,s)===1;)if(s++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return Sh;let n=r.pow(s,e);const o=(e+Ae)/ti;return function(a,c){if(a.is0(c))return c;if(Yo(a,c)!==1)throw new Error("Cannot find square root");let h=t,l=a.mul(a.ONE,n),u=a.pow(c,e),d=a.pow(c,o);for(;!a.eql(u,a.ONE);){if(a.is0(u))return a.ZERO;let p=1,m=a.sqr(u);for(;!a.eql(m,a.ONE);)if(p++,m=a.sqr(m),p===h)throw new Error("Cannot find square root");const g=Ae<<BigInt(h-p-1),b=a.pow(l,g);h=p,l=a.sqr(b),u=a.mul(u,l),d=a.mul(d,b)}return d}}function mg(i){return i%_h===pg?Sh:i%$h===Ph?gg:yg(i)}const wg=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function bg(i){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=wg.reduce((s,r)=>(s[r]="function",s),e);return ur(i,t),i}function vg(i,e,t){if(t<ke)throw new Error("invalid exponent, negatives unsupported");if(t===ke)return i.ONE;if(t===Ae)return e;let s=i.ONE,r=e;for(;t>ke;)t&Ae&&(s=i.mul(s,r)),r=i.sqr(r),t>>=Ae;return s}function Ah(i,e,t=!1){const s=new Array(e.length).fill(t?i.ZERO:void 0),r=e.reduce((o,a,c)=>i.is0(a)?o:(s[c]=o,i.mul(o,a)),i.ONE),n=i.inv(r);return e.reduceRight((o,a,c)=>i.is0(a)?o:(s[c]=i.mul(o,s[c]),i.mul(o,a)),n),s}function Yo(i,e){const t=(i.ORDER-Ae)/ti,s=i.pow(e,t),r=i.eql(s,i.ONE),n=i.eql(s,i.ZERO),o=i.eql(s,i.neg(i.ONE));if(!r&&!n&&!o)throw new Error("invalid Legendre symbol result");return r?1:n?0:-1}function Eg(i,e){e!==void 0&&$t(e);const t=e!==void 0?e:i.toString(2).length,s=Math.ceil(t/8);return{nBitLength:t,nByteLength:s}}function qi(i,e,t=!1,s={}){if(i<=ke)throw new Error("invalid field: expected ORDER > 0, got "+i);let r,n;if(typeof e=="object"&&e!=null){if(s.sqrt||t)throw new Error("cannot specify opts in two arguments");const l=e;l.BITS&&(r=l.BITS),l.sqrt&&(n=l.sqrt),typeof l.isLE=="boolean"&&(t=l.isLE)}else typeof e=="number"&&(r=e),s.sqrt&&(n=s.sqrt);const{nBitLength:o,nByteLength:a}=Eg(i,r);if(a>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let c;const h=Object.freeze({ORDER:i,isLE:t,BITS:o,BYTES:a,MASK:lr(o),ZERO:ke,ONE:Ae,create:l=>We(l,i),isValid:l=>{if(typeof l!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof l);return ke<=l&&l<i},is0:l=>l===ke,isValidNot0:l=>!h.is0(l)&&h.isValid(l),isOdd:l=>(l&Ae)===Ae,neg:l=>We(-l,i),eql:(l,u)=>l===u,sqr:l=>We(l*l,i),add:(l,u)=>We(l+u,i),sub:(l,u)=>We(l-u,i),mul:(l,u)=>We(l*u,i),pow:(l,u)=>vg(h,l,u),div:(l,u)=>We(l*Jo(u,i),i),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>Jo(l,i),sqrt:n||(l=>(c||(c=mg(i)),c(h,l))),toBytes:l=>t?Qn(l,a):Zn(l,a),fromBytes:l=>{if(l.length!==a)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+l.length);return t?er(l):hr(l)},invertBatch:l=>Ah(h,l),cmov:(l,u,d)=>d?u:l});return Object.freeze(h)}function Oh(i){if(typeof i!="bigint")throw new Error("field order must be bigint");const e=i.toString(2).length;return Math.ceil(e/8)}function Th(i){const e=Oh(i);return e+Math.ceil(e/2)}function Ig(i,e,t=!1){const s=i.length,r=Oh(e),n=Th(e);if(s<16||s<n||s>1024)throw new Error("expected "+n+"-1024 bytes of input, got "+s);const o=t?er(i):hr(i),a=We(o,e-Ae)+Ae;return t?Qn(a,r):Zn(a,r)}const Ri=BigInt(0),ii=BigInt(1);function os(i,e){const t=e.negate();return i?t:e}function xg(i,e,t){const s=n=>n.pz,r=Ah(i.Fp,t.map(s));return t.map((n,o)=>n.toAffine(r[o])).map(i.fromAffine)}function Rh(i,e){if(!Number.isSafeInteger(i)||i<=0||i>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+i)}function $r(i,e){Rh(i,e);const t=Math.ceil(e/i)+1,s=2**(i-1),r=2**i,n=lr(i),o=BigInt(i);return{windows:t,windowSize:s,mask:n,maxNumber:r,shiftBy:o}}function Zo(i,e,t){const{windowSize:s,mask:r,maxNumber:n,shiftBy:o}=t;let a=Number(i&r),c=i>>o;a>s&&(a-=n,c+=ii);const h=e*s,l=h+Math.abs(a)-1,u=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:l,isZero:u,isNeg:d,isNegF:p,offsetF:h}}function _g(i,e){if(!Array.isArray(i))throw new Error("array expected");i.forEach((t,s)=>{if(!(t instanceof e))throw new Error("invalid point at index "+s)})}function Pg(i,e){if(!Array.isArray(i))throw new Error("array of scalars expected");i.forEach((t,s)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+s)})}const Sr=new WeakMap,Uh=new WeakMap;function Ar(i){return Uh.get(i)||1}function Qo(i){if(i!==Ri)throw new Error("invalid wNAF")}function $g(i,e){return{constTimeNegate:os,hasPrecomputes(t){return Ar(t)!==1},unsafeLadder(t,s,r=i.ZERO){let n=t;for(;s>Ri;)s&ii&&(r=r.add(n)),n=n.double(),s>>=ii;return r},precomputeWindow(t,s){const{windows:r,windowSize:n}=$r(s,e),o=[];let a=t,c=a;for(let h=0;h<r;h++){c=a,o.push(c);for(let l=1;l<n;l++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,s,r){let n=i.ZERO,o=i.BASE;const a=$r(t,e);for(let c=0;c<a.windows;c++){const{nextN:h,offset:l,isZero:u,isNeg:d,isNegF:p,offsetF:m}=Zo(r,c,a);r=h,u?o=o.add(os(p,s[m])):n=n.add(os(d,s[l]))}return Qo(r),{p:n,f:o}},wNAFUnsafe(t,s,r,n=i.ZERO){const o=$r(t,e);for(let a=0;a<o.windows&&r!==Ri;a++){const{nextN:c,offset:h,isZero:l,isNeg:u}=Zo(r,a,o);if(r=c,!l){const d=s[h];n=n.add(u?d.negate():d)}}return Qo(r),n},getPrecomputes(t,s,r){let n=Sr.get(s);return n||(n=this.precomputeWindow(s,t),t!==1&&(typeof r=="function"&&(n=r(n)),Sr.set(s,n))),n},wNAFCached(t,s,r){const n=Ar(t);return this.wNAF(n,this.getPrecomputes(n,t,r),s)},wNAFCachedUnsafe(t,s,r,n){const o=Ar(t);return o===1?this.unsafeLadder(t,s,n):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),s,n)},setWindowSize(t,s){Rh(s,e),Uh.set(t,s),Sr.delete(t)}}}function Sg(i,e,t,s){let r=e,n=i.ZERO,o=i.ZERO;for(;t>Ri||s>Ri;)t&ii&&(n=n.add(r)),s&ii&&(o=o.add(r)),r=r.double(),t>>=ii,s>>=ii;return{p1:n,p2:o}}function Ag(i,e,t,s){_g(t,i),Pg(s,e);const r=t.length,n=s.length;if(r!==n)throw new Error("arrays of points and scalars must have equal length");const o=i.ZERO,a=dg(BigInt(r));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const h=lr(c),l=new Array(Number(h)+1).fill(o),u=Math.floor((e.BITS-1)/c)*c;let d=o;for(let p=u;p>=0;p-=c){l.fill(o);for(let g=0;g<n;g++){const b=s[g],T=Number(b>>BigInt(p)&h);l[T]=l[T].add(t[g])}let m=o;for(let g=l.length-1,b=o;g>0;g--)b=b.add(l[g]),m=m.add(b);if(d=d.add(m),p!==0)for(let g=0;g<c;g++)d=d.double()}return d}function Xo(i,e){if(e){if(e.ORDER!==i)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return bg(e),e}else return qi(i)}function Og(i,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${i} CURVE object`);for(const o of["p","n","h"]){const a=e[o];if(!(typeof a=="bigint"&&a>Ri))throw new Error(`CURVE.${o} must be positive bigint`)}const s=Xo(e.p,t.Fp),r=Xo(e.n,t.Fn),n=["Gx","Gy","a","b"];for(const o of n)if(!s.isValid(e[o]))throw new Error(`CURVE.${o} must be valid field element of CURVE.Fp`);return{Fp:s,Fn:r}}BigInt(0),BigInt(1),BigInt(2),BigInt(8);const Gi=BigInt(0),li=BigInt(1),Cs=BigInt(2);function Tg(i){return ur(i,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...i})}function Rg(i){const e=Tg(i),{P:t,type:s,adjustScalarBytes:r,powPminus2:n,randomBytes:o}=e,a=s==="x25519";if(!a&&s!=="x448")throw new Error("invalid type");const c=o||Di,h=a?255:448,l=a?32:56,u=BigInt(a?9:5),d=BigInt(a?121665:39081),p=a?Cs**BigInt(254):Cs**BigInt(447),m=a?BigInt(8)*Cs**BigInt(251)-li:BigInt(4)*Cs**BigInt(445)-li,g=p+m+li,b=y=>We(y,t),T=$(u);function $(y){return Qn(b(y),l)}function D(y){const _=Ne("u coordinate",y,l);return a&&(_[31]&=127),b(er(_))}function M(y){return er(r(Ne("scalar",y,l)))}function R(y,_){const E=q(D(_),M(y));if(E===Gi)throw new Error("invalid private or public key received");return $(E)}function j(y){return R(y,T)}function L(y,_,E){const v=b(y*(_-E));return _=b(_-v),E=b(E+v),{x_2:_,x_3:E}}function q(y,_){an("u",y,Gi,t),an("scalar",_,p,g);const E=_,v=y;let P=li,U=Gi,f=y,w=li,I=Gi;for(let x=BigInt(h-1);x>=Gi;x--){const A=E>>x&li;I^=A,{x_2:P,x_3:f}=L(I,P,f),{x_2:U,x_3:w}=L(I,U,w),I=A;const k=P+U,H=b(k*k),K=P-U,z=b(K*K),F=H-z,ee=f+w,ce=f-w,ae=b(ce*k),oe=b(ee*K),Fe=ae+oe,mt=ae-oe;f=b(Fe*Fe),w=b(v*b(mt*mt)),P=b(H*z),U=b(F*(H+b(d*F)))}({x_2:P,x_3:f}=L(I,P,f)),{x_2:U,x_3:w}=L(I,U,w);const S=n(U);return b(P*S)}return{scalarMult:R,scalarMultBase:j,getSharedSecret:(y,_)=>R(y,_),getPublicKey:y=>j(y),utils:{randomPrivateKey:()=>c(l)},GuBytes:T.slice()}}BigInt(0);const Ug=BigInt(1),ea=BigInt(2),Cg=BigInt(3),Ng=BigInt(5);BigInt(8);const Ch={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Bg(i){const e=BigInt(10),t=BigInt(20),s=BigInt(40),r=BigInt(80),n=Ch.p,o=i*i%n*i%n,a=st(o,ea,n)*o%n,c=st(a,Ug,n)*i%n,h=st(c,Ng,n)*c%n,l=st(h,e,n)*h%n,u=st(l,t,n)*l%n,d=st(u,s,n)*u%n,p=st(d,r,n)*d%n,m=st(p,r,n)*d%n,g=st(m,e,n)*h%n;return{pow_p_5_8:st(g,ea,n)*i%n,b2:o}}function kg(i){return i[0]&=248,i[31]&=127,i[31]|=64,i}const cn=(()=>{const i=Ch.p;return Rg({P:i,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:s}=Bg(e);return We(st(t,Cg,i)*s,i)},adjustScalarBytes:kg})})();function ta(i){i.lowS!==void 0&&Xs("lowS",i.lowS),i.prehash!==void 0&&Xs("prehash",i.prehash)}class Dg extends Error{constructor(e=""){super(e)}}const xt={Err:Dg,_tlv:{encode:(i,e)=>{const{Err:t}=xt;if(i<0||i>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const s=e.length/2,r=Us(s);if(r.length/2&128)throw new t("tlv.encode: long form length too big");const n=s>127?Us(r.length/2|128):"";return Us(i)+n+r+e},decode(i,e){const{Err:t}=xt;let s=0;if(i<0||i>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[s++]!==i)throw new t("tlv.decode: wrong tlv");const r=e[s++],n=!!(r&128);let o=0;if(!n)o=r;else{const c=r&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const h=e.subarray(s,s+c);if(h.length!==c)throw new t("tlv.decode: length bytes not complete");if(h[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const l of h)o=o<<8|l;if(s+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(s,s+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(s+o)}}},_int:{encode(i){const{Err:e}=xt;if(i<as)throw new e("integer: negative integers are not allowed");let t=Us(i);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(i){const{Err:e}=xt;if(i[0]&128)throw new e("invalid signature integer: negative");if(i[0]===0&&!(i[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return hr(i)}},toSig(i){const{Err:e,_int:t,_tlv:s}=xt,r=Ne("signature",i),{v:n,l:o}=s.decode(48,r);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=s.decode(2,n),{v:h,l}=s.decode(2,c);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(h)}},hexFromSig(i){const{_tlv:e,_int:t}=xt,s=e.encode(2,t.encode(i.r)),r=e.encode(2,t.encode(i.s)),n=s+r;return e.encode(48,n)}},as=BigInt(0),cs=BigInt(1),qg=BigInt(2),Ns=BigInt(3),jg=BigInt(4);function Lg(i,e,t){function s(r){const n=i.sqr(r),o=i.mul(n,r);return i.add(i.add(o,i.mul(r,e)),t)}return s}function Nh(i,e,t){const{BYTES:s}=i;function r(n){let o;if(typeof n=="bigint")o=n;else{let a=Ne("private key",n);if(e){if(!e.includes(a.length*2))throw new Error("invalid private key");const c=new Uint8Array(s);c.set(a,c.length-a.length),a=c}try{o=i.fromBytes(a)}catch{throw new Error(`invalid private key: expected ui8a of size ${s}, got ${typeof n}`)}}if(t&&(o=i.create(o)),!i.isValidNot0(o))throw new Error("invalid private key: out of range [1..N-1]");return o}return r}function Mg(i,e={}){const{Fp:t,Fn:s}=Og("weierstrass",i,e),{h:r,n}=i;ur(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:o}=e;if(o&&(!t.is0(i.a)||typeof o.beta!="bigint"||typeof o.splitScalar!="function"))throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(q,y,_){const{x:E,y:v}=y.toAffine(),P=t.toBytes(E);if(Xs("isCompressed",_),_){a();const U=!t.isOdd(v);return ei(Bh(U),P)}else return ei(Uint8Array.of(4),P,t.toBytes(v))}function h(q){Ye(q);const y=t.BYTES,_=y+1,E=2*y+1,v=q.length,P=q[0],U=q.subarray(1);if(v===_&&(P===2||P===3)){const f=t.fromBytes(U);if(!t.isValid(f))throw new Error("bad point: is not on curve, wrong x");const w=d(f);let I;try{I=t.sqrt(w)}catch(x){const A=x instanceof Error?": "+x.message:"";throw new Error("bad point: is not on curve, sqrt error"+A)}a();const S=t.isOdd(I);return(P&1)===1!==S&&(I=t.neg(I)),{x:f,y:I}}else if(v===E&&P===4){const f=t.fromBytes(U.subarray(y*0,y*1)),w=t.fromBytes(U.subarray(y*1,y*2));if(!p(f,w))throw new Error("bad point: is not on curve");return{x:f,y:w}}else throw new Error(`bad point: got length ${v}, expected compressed=${_} or uncompressed=${E}`)}const l=e.toBytes||c,u=e.fromBytes||h,d=Lg(t,i.a,i.b);function p(q,y){const _=t.sqr(y),E=d(q);return t.eql(_,E)}if(!p(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const m=t.mul(t.pow(i.a,Ns),jg),g=t.mul(t.sqr(i.b),BigInt(27));if(t.is0(t.add(m,g)))throw new Error("bad curve params: a or b");function b(q,y,_=!1){if(!t.isValid(y)||_&&t.is0(y))throw new Error(`bad point coordinate ${q}`);return y}function T(q){if(!(q instanceof R))throw new Error("ProjectivePoint expected")}const $=Wo((q,y)=>{const{px:_,py:E,pz:v}=q;if(t.eql(v,t.ONE))return{x:_,y:E};const P=q.is0();y==null&&(y=P?t.ONE:t.inv(v));const U=t.mul(_,y),f=t.mul(E,y),w=t.mul(v,y);if(P)return{x:t.ZERO,y:t.ZERO};if(!t.eql(w,t.ONE))throw new Error("invZ was invalid");return{x:U,y:f}}),D=Wo(q=>{if(q.is0()){if(e.allowInfinityPoint&&!t.is0(q.py))return;throw new Error("bad point: ZERO")}const{x:y,y:_}=q.toAffine();if(!t.isValid(y)||!t.isValid(_))throw new Error("bad point: x or y not field elements");if(!p(y,_))throw new Error("bad point: equation left != right");if(!q.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function M(q,y,_,E,v){return _=new R(t.mul(_.px,q),_.py,_.pz),y=os(E,y),_=os(v,_),y.add(_)}class R{constructor(y,_,E){this.px=b("x",y),this.py=b("y",_,!0),this.pz=b("z",E),Object.freeze(this)}static fromAffine(y){const{x:_,y:E}=y||{};if(!y||!t.isValid(_)||!t.isValid(E))throw new Error("invalid affine point");if(y instanceof R)throw new Error("projective point not allowed");return t.is0(_)&&t.is0(E)?R.ZERO:new R(_,E,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(y){return xg(R,"pz",y)}static fromBytes(y){return Ye(y),R.fromHex(y)}static fromHex(y){const _=R.fromAffine(u(Ne("pointHex",y)));return _.assertValidity(),_}static fromPrivateKey(y){const _=Nh(s,e.allowedPrivateKeyLengths,e.wrapPrivateKey);return R.BASE.multiply(_(y))}static msm(y,_){return Ag(R,s,y,_)}precompute(y=8,_=!0){return L.setWindowSize(this,y),_||this.multiply(Ns),this}_setWindowSize(y){this.precompute(y)}assertValidity(){D(this)}hasEvenY(){const{y}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(y)}equals(y){T(y);const{px:_,py:E,pz:v}=this,{px:P,py:U,pz:f}=y,w=t.eql(t.mul(_,f),t.mul(P,v)),I=t.eql(t.mul(E,f),t.mul(U,v));return w&&I}negate(){return new R(this.px,t.neg(this.py),this.pz)}double(){const{a:y,b:_}=i,E=t.mul(_,Ns),{px:v,py:P,pz:U}=this;let f=t.ZERO,w=t.ZERO,I=t.ZERO,S=t.mul(v,v),x=t.mul(P,P),A=t.mul(U,U),k=t.mul(v,P);return k=t.add(k,k),I=t.mul(v,U),I=t.add(I,I),f=t.mul(y,I),w=t.mul(E,A),w=t.add(f,w),f=t.sub(x,w),w=t.add(x,w),w=t.mul(f,w),f=t.mul(k,f),I=t.mul(E,I),A=t.mul(y,A),k=t.sub(S,A),k=t.mul(y,k),k=t.add(k,I),I=t.add(S,S),S=t.add(I,S),S=t.add(S,A),S=t.mul(S,k),w=t.add(w,S),A=t.mul(P,U),A=t.add(A,A),S=t.mul(A,k),f=t.sub(f,S),I=t.mul(A,x),I=t.add(I,I),I=t.add(I,I),new R(f,w,I)}add(y){T(y);const{px:_,py:E,pz:v}=this,{px:P,py:U,pz:f}=y;let w=t.ZERO,I=t.ZERO,S=t.ZERO;const x=i.a,A=t.mul(i.b,Ns);let k=t.mul(_,P),H=t.mul(E,U),K=t.mul(v,f),z=t.add(_,E),F=t.add(P,U);z=t.mul(z,F),F=t.add(k,H),z=t.sub(z,F),F=t.add(_,v);let ee=t.add(P,f);return F=t.mul(F,ee),ee=t.add(k,K),F=t.sub(F,ee),ee=t.add(E,v),w=t.add(U,f),ee=t.mul(ee,w),w=t.add(H,K),ee=t.sub(ee,w),S=t.mul(x,F),w=t.mul(A,K),S=t.add(w,S),w=t.sub(H,S),S=t.add(H,S),I=t.mul(w,S),H=t.add(k,k),H=t.add(H,k),K=t.mul(x,K),F=t.mul(A,F),H=t.add(H,K),K=t.sub(k,K),K=t.mul(x,K),F=t.add(F,K),k=t.mul(H,F),I=t.add(I,k),k=t.mul(ee,F),w=t.mul(z,w),w=t.sub(w,k),k=t.mul(z,H),S=t.mul(ee,S),S=t.add(S,k),new R(w,I,S)}subtract(y){return this.add(y.negate())}is0(){return this.equals(R.ZERO)}multiply(y){const{endo:_}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let E,v;const P=U=>L.wNAFCached(this,U,R.normalizeZ);if(_){const{k1neg:U,k1:f,k2neg:w,k2:I}=_.splitScalar(y),{p:S,f:x}=P(f),{p:A,f:k}=P(I);v=x.add(k),E=M(_.beta,S,A,U,w)}else{const{p:U,f}=P(y);E=U,v=f}return R.normalizeZ([E,v])[0]}multiplyUnsafe(y){const{endo:_}=e,E=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===as||E.is0())return R.ZERO;if(y===cs)return E;if(L.hasPrecomputes(this))return this.multiply(y);if(_){const{k1neg:v,k1:P,k2neg:U,k2:f}=_.splitScalar(y),{p1:w,p2:I}=Sg(R,E,P,f);return M(_.beta,w,I,v,U)}else return L.wNAFCachedUnsafe(E,y)}multiplyAndAddUnsafe(y,_,E){const v=this.multiplyUnsafe(_).add(y.multiplyUnsafe(E));return v.is0()?void 0:v}toAffine(y){return $(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return r===cs?!0:y?y(R,this):L.wNAFCachedUnsafe(this,n).is0()}clearCofactor(){const{clearCofactor:y}=e;return r===cs?this:y?y(R,this):this.multiplyUnsafe(r)}toBytes(y=!0){return Xs("isCompressed",y),this.assertValidity(),l(R,this,y)}toRawBytes(y=!0){return this.toBytes(y)}toHex(y=!0){return gs(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}R.BASE=new R(i.Gx,i.Gy,t.ONE),R.ZERO=new R(t.ZERO,t.ONE,t.ZERO),R.Fp=t,R.Fn=s;const j=s.BITS,L=$g(R,e.endo?Math.ceil(j/2):j);return R}function Bh(i){return Uint8Array.of(i?2:3)}function zg(i,e,t={}){ur(e,{hash:"function"},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const s=e.randomBytes||Di,r=e.hmac||((E,...v)=>ar(e.hash,E,ei(...v))),{Fp:n,Fn:o}=i,{ORDER:a,BITS:c}=o;function h(E){const v=a>>cs;return E>v}function l(E){return h(E)?o.neg(E):E}function u(E,v){if(!o.isValidNot0(v))throw new Error(`invalid signature ${E}: out of range 1..CURVE.n`)}class d{constructor(v,P,U){u("r",v),u("s",P),this.r=v,this.s=P,U!=null&&(this.recovery=U),Object.freeze(this)}static fromCompact(v){const P=o.BYTES,U=Ne("compactSignature",v,P*2);return new d(o.fromBytes(U.subarray(0,P)),o.fromBytes(U.subarray(P,P*2)))}static fromDER(v){const{r:P,s:U}=xt.toSig(Ne("DER",v));return new d(P,U)}assertValidity(){}addRecoveryBit(v){return new d(this.r,this.s,v)}recoverPublicKey(v){const P=n.ORDER,{r:U,s:f,recovery:w}=this;if(w==null||![0,1,2,3].includes(w))throw new Error("recovery id invalid");if(a*qg<P&&w>1)throw new Error("recovery id is ambiguous for h>1 curve");const I=w===2||w===3?U+a:U;if(!n.isValid(I))throw new Error("recovery id 2 or 3 invalid");const S=n.toBytes(I),x=i.fromHex(ei(Bh((w&1)===0),S)),A=o.inv(I),k=D(Ne("msgHash",v)),H=o.create(-k*A),K=o.create(f*A),z=i.BASE.multiplyUnsafe(H).add(x.multiplyUnsafe(K));if(z.is0())throw new Error("point at infinify");return z.assertValidity(),z}hasHighS(){return h(this.s)}normalizeS(){return this.hasHighS()?new d(this.r,o.neg(this.s),this.recovery):this}toBytes(v){if(v==="compact")return ei(o.toBytes(this.r),o.toBytes(this.s));if(v==="der")return Gn(xt.hexFromSig(this));throw new Error("invalid format")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return gs(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return gs(this.toBytes("compact"))}}const p=Nh(o,t.allowedPrivateKeyLengths,t.wrapPrivateKey),m={isValidPrivateKey(E){try{return p(E),!0}catch{return!1}},normPrivateKeyToScalar:p,randomPrivateKey:()=>{const E=a;return Ig(s(Th(E)),E)},precompute(E=8,v=i.BASE){return v.precompute(E,!1)}};function g(E,v=!0){return i.fromPrivateKey(E).toBytes(v)}function b(E){if(typeof E=="bigint")return!1;if(E instanceof i)return!0;const v=Ne("key",E).length,P=n.BYTES,U=P+1,f=2*P+1;if(!(t.allowedPrivateKeyLengths||o.BYTES===U))return v===U||v===f}function T(E,v,P=!0){if(b(E)===!0)throw new Error("first arg must be private key");if(b(v)===!1)throw new Error("second arg must be public key");return i.fromHex(v).multiply(p(E)).toBytes(P)}const $=e.bits2int||function(E){if(E.length>8192)throw new Error("input is too large");const v=hr(E),P=E.length*8-c;return P>0?v>>BigInt(P):v},D=e.bits2int_modN||function(E){return o.create($(E))},M=lr(c);function R(E){return an("num < 2^"+c,E,as,M),o.toBytes(E)}function j(E,v,P=L){if(["recovered","canonical"].some(z=>z in P))throw new Error("sign() legacy options not supported");const{hash:U}=e;let{lowS:f,prehash:w,extraEntropy:I}=P;f==null&&(f=!0),E=Ne("msgHash",E),ta(P),w&&(E=Ne("prehashed msgHash",U(E)));const S=D(E),x=p(v),A=[R(x),R(S)];if(I!=null&&I!==!1){const z=I===!0?s(n.BYTES):I;A.push(Ne("extraEntropy",z))}const k=ei(...A),H=S;function K(z){const F=$(z);if(!o.isValidNot0(F))return;const ee=o.inv(F),ce=i.BASE.multiply(F).toAffine(),ae=o.create(ce.x);if(ae===as)return;const oe=o.create(ee*o.create(H+ae*x));if(oe===as)return;let Fe=(ce.x===ae?0:2)|Number(ce.y&cs),mt=oe;return f&&h(oe)&&(mt=l(oe),Fe^=1),new d(ae,mt,Fe)}return{seed:k,k2sig:K}}const L={lowS:e.lowS,prehash:!1},q={lowS:e.lowS,prehash:!1};function y(E,v,P=L){const{seed:U,k2sig:f}=j(E,v,P);return fg(e.hash.outputLen,o.BYTES,r)(U,f)}i.BASE.precompute(8);function _(E,v,P,U=q){const f=E;v=Ne("msgHash",v),P=Ne("publicKey",P),ta(U);const{lowS:w,prehash:I,format:S}=U;if("strict"in U)throw new Error("options.strict was renamed to lowS");if(S!==void 0&&!["compact","der","js"].includes(S))throw new Error('format must be "compact", "der" or "js"');const x=typeof f=="string"||Fn(f),A=!x&&!S&&typeof f=="object"&&f!==null&&typeof f.r=="bigint"&&typeof f.s=="bigint";if(!x&&!A)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let k,H;try{if(A)if(S===void 0||S==="js")k=new d(f.r,f.s);else throw new Error("invalid format");if(x){try{S!=="compact"&&(k=d.fromDER(f))}catch(Fe){if(!(Fe instanceof xt.Err))throw Fe}!k&&S!=="der"&&(k=d.fromCompact(f))}H=i.fromHex(P)}catch{return!1}if(!k||w&&k.hasHighS())return!1;I&&(v=e.hash(v));const{r:K,s:z}=k,F=D(v),ee=o.inv(z),ce=o.create(F*ee),ae=o.create(K*ee),oe=i.BASE.multiplyUnsafe(ce).add(H.multiplyUnsafe(ae));return oe.is0()?!1:o.create(oe.x)===K}return Object.freeze({getPublicKey:g,getSharedSecret:T,sign:y,verify:_,utils:m,Point:i,Signature:d})}function Hg(i){const e={a:i.a,b:i.b,p:i.Fp.ORDER,n:i.n,h:i.h,Gx:i.Gx,Gy:i.Gy},t=i.Fp,s=qi(e.n,i.nBitLength),r={Fp:t,Fn:s,allowedPrivateKeyLengths:i.allowedPrivateKeyLengths,allowInfinityPoint:i.allowInfinityPoint,endo:i.endo,wrapPrivateKey:i.wrapPrivateKey,isTorsionFree:i.isTorsionFree,clearCofactor:i.clearCofactor,fromBytes:i.fromBytes,toBytes:i.toBytes};return{CURVE:e,curveOpts:r}}function Fg(i){const{CURVE:e,curveOpts:t}=Hg(i),s={hash:i.hash,hmac:i.hmac,randomBytes:i.randomBytes,lowS:i.lowS,bits2int:i.bits2int,bits2int_modN:i.bits2int_modN};return{CURVE:e,curveOpts:t,ecdsaOpts:s}}function Vg(i,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:i})}function Kg(i){const{CURVE:e,curveOpts:t,ecdsaOpts:s}=Fg(i),r=Mg(e,t),n=zg(r,s,t);return Vg(i,n)}function hn(i,e){const t=s=>Kg({...i,hash:s});return{...t(e),create:t}}const kh={p:BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),h:BigInt(1),a:BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),b:BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5")},Dh={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000ffffffff"),n:BigInt("0xffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973"),h:BigInt(1),a:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000fffffffc"),b:BigInt("0xb3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef"),Gx:BigInt("0xaa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7"),Gy:BigInt("0x3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f")},qh={p:BigInt("0x1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),n:BigInt("0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409"),h:BigInt(1),a:BigInt("0x1fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc"),b:BigInt("0x0051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00"),Gx:BigInt("0x00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66"),Gy:BigInt("0x011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650")},Gg=qi(kh.p),Wg=qi(Dh.p),Jg=qi(qh.p),Yg=hn({...kh,Fp:Gg,lowS:!1},or);hn({...Dh,Fp:Wg,lowS:!1},rp),hn({...qh,Fp:Jg,lowS:!1,allowedPrivateKeyLengths:[130,131,132]},sp);const Zg=Yg,jh="base10",Oe="base16",nt="base64pad",Mt="base64url",Es="utf8",Lh=0,_t=1,Is=2,Qg=0,ia=1,hs=12,Xn=32;function Xg(){const i=cn.utils.randomPrivateKey(),e=cn.getPublicKey(i);return{privateKey:De(i,Oe),publicKey:De(e,Oe)}}function ln(){const i=Di(Xn);return De(i,Oe)}function ey(i,e){const t=cn.getSharedSecret(Je(i,Oe),Je(e,Oe)),s=lg(cr,t,void 0,void 0,Xn);return De(s,Oe)}function Hs(i){const e=cr(Je(i,Oe));return De(e,Oe)}function ft(i){const e=cr(Je(i,Es));return De(e,Oe)}function Mh(i){return Je(`${i}`,jh)}function ni(i){return Number(De(i,jh))}function zh(i){return i.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Hh(i){const e=i.replace(/-/g,"+").replace(/_/g,"/"),t=(4-e.length%4)%4;return e+"=".repeat(t)}function ty(i){const e=Mh(typeof i.type<"u"?i.type:Lh);if(ni(e)===_t&&typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");const t=typeof i.senderPublicKey<"u"?Je(i.senderPublicKey,Oe):void 0,s=typeof i.iv<"u"?Je(i.iv,Oe):Di(hs),r=Je(i.symKey,Oe),n=Eh(r,s).encrypt(Je(i.message,Es)),o=Fh({type:e,sealed:n,iv:s,senderPublicKey:t});return i.encoding===Mt?zh(o):o}function iy(i){const e=Je(i.symKey,Oe),{sealed:t,iv:s}=ms({encoded:i.encoded,encoding:i.encoding}),r=Eh(e,s).decrypt(t);if(r===null)throw new Error("Failed to decrypt");return De(r,Es)}function sy(i,e){const t=Mh(Is),s=Di(hs),r=Je(i,Es),n=Fh({type:t,sealed:r,iv:s});return e===Mt?zh(n):n}function ry(i,e){const{sealed:t}=ms({encoded:i,encoding:e});return De(t,Es)}function Fh(i){if(ni(i.type)===Is)return De(ns([i.type,i.sealed]),nt);if(ni(i.type)===_t){if(typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return De(ns([i.type,i.senderPublicKey,i.iv,i.sealed]),nt)}return De(ns([i.type,i.iv,i.sealed]),nt)}function ms(i){const e=(i.encoding||nt)===Mt?Hh(i.encoded):i.encoded,t=Je(e,nt),s=t.slice(Qg,ia),r=ia;if(ni(s)===_t){const c=r+Xn,h=c+hs,l=t.slice(r,c),u=t.slice(c,h),d=t.slice(h);return{type:s,sealed:d,iv:u,senderPublicKey:l}}if(ni(s)===Is){const c=t.slice(r),h=Di(hs);return{type:s,sealed:c,iv:h}}const n=r+hs,o=t.slice(r,n),a=t.slice(n);return{type:s,sealed:a,iv:o}}function ny(i,e){const t=ms({encoded:i,encoding:e==null?void 0:e.encoding});return Vh({type:ni(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?De(t.senderPublicKey,Oe):void 0,receiverPublicKey:e==null?void 0:e.receiverPublicKey})}function Vh(i){const e=(i==null?void 0:i.type)||Lh;if(e===_t){if(typeof(i==null?void 0:i.senderPublicKey)>"u")throw new Error("missing sender public key");if(typeof(i==null?void 0:i.receiverPublicKey)>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:i==null?void 0:i.senderPublicKey,receiverPublicKey:i==null?void 0:i.receiverPublicKey}}function sa(i){return i.type===_t&&typeof i.senderPublicKey=="string"&&typeof i.receiverPublicKey=="string"}function ra(i){return i.type===Is}function oy(i){const e=Buffer.from(i.x,"base64"),t=Buffer.from(i.y,"base64");return ns([new Uint8Array([4]),e,t])}function ay(i,e){const[t,s,r]=i.split("."),n=Buffer.from(Hh(r),"base64");if(n.length!==64)throw new Error("Invalid signature length");const o=n.slice(0,32),a=n.slice(32,64),c=`${t}.${s}`,h=cr(c),l=oy(e);if(!Zg.verify(ns([o,a]),h,l))throw new Error("Invalid signature");return zr(i).payload}const cy="irn";function tr(i){return(i==null?void 0:i.relay)||{protocol:cy}}function is(i){const e=Al[i];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${i}`);return e}function hy(i,e="-"){const t={},s="relay"+e;return Object.keys(i).forEach(r=>{if(r.startsWith(s)){const n=r.replace(s,""),o=i[r];t[n]=o}}),t}function na(i){if(!i.includes("wc:")){const h=ih(i);h!=null&&h.includes("wc:")&&(i=h)}i=i.includes("wc://")?i.replace("wc://",""):i,i=i.includes("wc:")?i.replace("wc:",""):i;const e=i.indexOf(":"),t=i.indexOf("?")!==-1?i.indexOf("?"):void 0,s=i.substring(0,e),r=i.substring(e+1,t).split("@"),n=typeof t<"u"?i.substring(t):"",o=new URLSearchParams(n),a={};o.forEach((h,l)=>{a[l]=h});const c=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:s,topic:ly(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:hy(a),methods:c,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function ly(i){return i.startsWith("//")?i.substring(2):i}function uy(i,e="-"){const t="relay",s={};return Object.keys(i).forEach(r=>{const n=r,o=t+e+n;i[n]&&(s[o]=i[n])}),s}function oa(i){const e=new URLSearchParams,t=uy(i.relay);Object.keys(t).sort().forEach(r=>{e.set(r,t[r])}),e.set("symKey",i.symKey),i.expiryTimestamp&&e.set("expiryTimestamp",i.expiryTimestamp.toString()),i.methods&&e.set("methods",i.methods.join(","));const s=e.toString();return`${i.protocol}:${i.topic}@${i.version}?${s}`}function Bs(i,e,t){return`${i}?wc_ev=${t}&topic=${e}`}var dy=Object.defineProperty,fy=Object.defineProperties,py=Object.getOwnPropertyDescriptors,aa=Object.getOwnPropertySymbols,gy=Object.prototype.hasOwnProperty,yy=Object.prototype.propertyIsEnumerable,ca=(i,e,t)=>e in i?dy(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,my=(i,e)=>{for(var t in e||(e={}))gy.call(e,t)&&ca(i,t,e[t]);if(aa)for(var t of aa(e))yy.call(e,t)&&ca(i,t,e[t]);return i},wy=(i,e)=>fy(i,py(e));function ji(i){const e=[];return i.forEach(t=>{const[s,r]=t.split(":");e.push(`${s}:${r}`)}),e}function by(i){const e=[];return Object.values(i).forEach(t=>{e.push(...ji(t.accounts))}),e}function vy(i,e){const t=[];return Object.values(i).forEach(s=>{ji(s.accounts).includes(e)&&t.push(...s.methods)}),t}function Ey(i,e){const t=[];return Object.values(i).forEach(s=>{ji(s.accounts).includes(e)&&t.push(...s.events)}),t}function dr(i){return i.includes(":")}function $i(i){return dr(i)?i.split(":")[0]:i}function ha(i){var e,t,s;const r={};if(!gt(i))return r;for(const[n,o]of Object.entries(i)){const a=dr(n)?[n]:o.chains,c=o.methods||[],h=o.events||[],l=$i(n);r[l]=wy(my({},r[l]),{chains:pt(a,(e=r[l])==null?void 0:e.chains),methods:pt(c,(t=r[l])==null?void 0:t.methods),events:pt(h,(s=r[l])==null?void 0:s.events)})}return r}function Iy(i){const e={};return i==null||i.forEach(t=>{var s;const[r,n]=t.split(":");e[r]||(e[r]={accounts:[],chains:[],events:[],methods:[]}),e[r].accounts.push(t),(s=e[r].chains)==null||s.push(`${r}:${n}`)}),e}function la(i,e){e=e.map(s=>s.replace("did:pkh:",""));const t=Iy(e);for(const[s,r]of Object.entries(t))r.methods?r.methods=pt(r.methods,i):r.methods=i,r.events=["chainChanged","accountsChanged"];return t}function xy(i,e){var t,s,r,n,o,a;const c=ha(i),h=ha(e),l={},u=Object.keys(c).concat(Object.keys(h));for(const d of u)l[d]={chains:pt((t=c[d])==null?void 0:t.chains,(s=h[d])==null?void 0:s.chains),methods:pt((r=c[d])==null?void 0:r.methods,(n=h[d])==null?void 0:n.methods),events:pt((o=c[d])==null?void 0:o.events,(a=h[d])==null?void 0:a.events)};return l}const _y={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Py={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function C(i,e){const{message:t,code:s}=Py[i];return{message:e?`${t} ${e}`:t,code:s}}function ne(i,e){const{message:t,code:s}=_y[i];return{message:e?`${t} ${e}`:t,code:s}}function Pt(i,e){return!!Array.isArray(i)}function gt(i){return Object.getPrototypeOf(i)===Object.prototype&&Object.keys(i).length}function ve(i){return typeof i>"u"}function le(i,e){return e&&ve(i)?!0:typeof i=="string"&&!!i.trim().length}function eo(i,e){return e&&ve(i)?!0:typeof i=="number"&&!isNaN(i)}function $y(i,e){const{requiredNamespaces:t}=e,s=Object.keys(i.namespaces),r=Object.keys(t);let n=!0;return Xt(r,s)?(s.forEach(o=>{const{accounts:a,methods:c,events:h}=i.namespaces[o],l=ji(a),u=t[o];(!Xt(Zc(o,u),l)||!Xt(u.methods,c)||!Xt(u.events,h))&&(n=!1)}),n):!1}function ir(i){return le(i,!1)&&i.includes(":")?i.split(":").length===2:!1}function Sy(i){if(le(i,!1)&&i.includes(":")){const e=i.split(":");if(e.length===3){const t=e[0]+":"+e[1];return!!e[2]&&ir(t)}}return!1}function Ay(i){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(le(i,!1)){if(e(i))return!0;const t=ih(i);return e(t)}}catch{}return!1}function Oy(i){var e;return(e=i==null?void 0:i.proposer)==null?void 0:e.publicKey}function Ty(i){return i==null?void 0:i.topic}function Ry(i,e){let t=null;return le(i==null?void 0:i.publicKey,!1)||(t=C("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function ua(i){let e=!0;return Pt(i)?i.length&&(e=i.every(t=>le(t,!1))):e=!1,e}function Uy(i,e,t){let s=null;return Pt(e)&&e.length?e.forEach(r=>{s||ir(r)||(s=ne("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):ir(i)||(s=ne("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),s}function Cy(i,e,t){let s=null;return Object.entries(i).forEach(([r,n])=>{if(s)return;const o=Uy(r,Zc(r,n),`${e} ${t}`);o&&(s=o)}),s}function Ny(i,e){let t=null;return Pt(i)?i.forEach(s=>{t||Sy(s)||(t=ne("UNSUPPORTED_ACCOUNTS",`${e}, account ${s} should be a string and conform to "namespace:chainId:address" format`))}):t=ne("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function By(i,e){let t=null;return Object.values(i).forEach(s=>{if(t)return;const r=Ny(s==null?void 0:s.accounts,`${e} namespace`);r&&(t=r)}),t}function ky(i,e){let t=null;return ua(i==null?void 0:i.methods)?ua(i==null?void 0:i.events)||(t=ne("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=ne("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function Kh(i,e){let t=null;return Object.values(i).forEach(s=>{if(t)return;const r=ky(s,`${e}, namespace`);r&&(t=r)}),t}function Dy(i,e,t){let s=null;if(i&&gt(i)){const r=Kh(i,e);r&&(s=r);const n=Cy(i,e,t);n&&(s=n)}else s=C("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return s}function Or(i,e){let t=null;if(i&&gt(i)){const s=Kh(i,e);s&&(t=s);const r=By(i,e);r&&(t=r)}else t=C("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function Gh(i){return le(i.protocol,!0)}function qy(i,e){let t=!1;return i?i&&Pt(i)&&i.length&&i.forEach(s=>{t=Gh(s)}):t=!0,t}function jy(i){return typeof i=="number"}function Ce(i){return typeof i<"u"&&typeof i!==null}function Ly(i){return!(!i||typeof i!="object"||!i.code||!eo(i.code,!1)||!i.message||!le(i.message,!1))}function My(i){return!(ve(i)||!le(i.method,!1))}function zy(i){return!(ve(i)||ve(i.result)&&ve(i.error)||!eo(i.id,!1)||!le(i.jsonrpc,!1))}function Hy(i){return!(ve(i)||!le(i.name,!1))}function da(i,e){return!(!ir(e)||!by(i).includes(e))}function Fy(i,e,t){return le(t,!1)?vy(i,e).includes(t):!1}function Vy(i,e,t){return le(t,!1)?Ey(i,e).includes(t):!1}function fa(i,e,t){let s=null;const r=Ky(i),n=Gy(e),o=Object.keys(r),a=Object.keys(n),c=pa(Object.keys(i)),h=pa(Object.keys(e)),l=c.filter(u=>!h.includes(u));return l.length&&(s=C("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${l.toString()}
      Received: ${Object.keys(e).toString()}`)),Xt(o,a)||(s=C("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${o.toString()}
      Approved: ${a.toString()}`)),Object.keys(e).forEach(u=>{if(!u.includes(":")||s)return;const d=ji(e[u].accounts);d.includes(u)||(s=C("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${u}
        Required: ${u}
        Approved: ${d.toString()}`))}),o.forEach(u=>{s||(Xt(r[u].methods,n[u].methods)?Xt(r[u].events,n[u].events)||(s=C("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${u}`)):s=C("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${u}`))}),s}function Ky(i){const e={};return Object.keys(i).forEach(t=>{var s;t.includes(":")?e[t]=i[t]:(s=i[t].chains)==null||s.forEach(r=>{e[r]={methods:i[t].methods,events:i[t].events}})}),e}function pa(i){return[...new Set(i.map(e=>e.includes(":")?e.split(":")[0]:e))]}function Gy(i){const e={};return Object.keys(i).forEach(t=>{if(t.includes(":"))e[t]=i[t];else{const s=ji(i[t].accounts);s==null||s.forEach(r=>{e[r]={accounts:i[t].accounts.filter(n=>n.includes(`${r}:`)),methods:i[t].methods,events:i[t].events}})}}),e}function Wy(i,e){return eo(i,!1)&&i<=e.max&&i>=e.min}function ga(){const i=bs();return new Promise(e=>{switch(i){case Me.browser:e(Jy());break;case Me.reactNative:e(Yy());break;case Me.node:e(Zy());break;default:e(!0)}})}function Jy(){return ki()&&(navigator==null?void 0:navigator.onLine)}async function Yy(){if(Kt()&&typeof global<"u"&&global!=null&&global.NetInfo){const i=await(global==null?void 0:global.NetInfo.fetch());return i==null?void 0:i.isConnected}return!0}function Zy(){return!0}function Qy(i){switch(bs()){case Me.browser:Xy(i);break;case Me.reactNative:em(i);break}}function Xy(i){!Kt()&&ki()&&(window.addEventListener("online",()=>i(!0)),window.addEventListener("offline",()=>i(!1)))}function em(i){Kt()&&typeof global<"u"&&global!=null&&global.NetInfo&&(global==null||global.NetInfo.addEventListener(e=>i(e==null?void 0:e.isConnected)))}function tm(){var i;return ki()&&Oi()?((i=Oi())==null?void 0:i.visibilityState)==="visible":!0}const Tr={};class Wi{static get(e){return Tr[e]}static set(e,t){Tr[e]=t}static delete(e){delete Tr[e]}}function im(i){const e=ws.decode(i);if(e.length<33)throw new Error("Too short to contain a public key");return e.slice(1,33)}function sm({publicKey:i,signature:e,payload:t}){var s;const r=un(t.method),n=128|parseInt(((s=t.version)==null?void 0:s.toString())||"4"),o=om(t.address),a=t.era==="00"?new Uint8Array([0]):un(t.era);if(a.length!==1&&a.length!==2)throw new Error("Invalid era length");const c=parseInt(t.nonce,16),h=new Uint8Array([c&255,c>>8&255]),l=BigInt(`0x${nm(t.tip)}`),u=cm(l),d=new Uint8Array([0,...i,o,...e,...a,...h,...u,...r]),p=am(d.length+1);return new Uint8Array([...p,n,...d])}function rm(i){const e=un(i),t=Gd.blake2b(e,void 0,32);return"0x"+Buffer.from(t).toString("hex")}function un(i){return new Uint8Array(i.replace(/^0x/,"").match(/.{1,2}/g).map(e=>parseInt(e,16)))}function nm(i){return i.startsWith("0x")?i.slice(2):i}function om(i){const e=ws.decode(i)[0];return e===42?0:e===60?2:1}function am(i){if(i<64)return new Uint8Array([i<<2]);if(i<16384){const e=i<<2|1;return new Uint8Array([e&255,e>>8&255])}else if(i<1<<30){const e=i<<2|2;return new Uint8Array([e&255,e>>8&255,e>>16&255,e>>24&255])}else throw new Error("Compact encoding > 2^30 not supported")}function cm(i){if(i<BigInt(1)<<BigInt(6))return new Uint8Array([Number(i<<BigInt(2))]);if(i<BigInt(1)<<BigInt(14)){const e=i<<BigInt(2)|BigInt(1);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255))])}else if(i<BigInt(1)<<BigInt(30)){const e=i<<BigInt(2)|BigInt(2);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255)),Number(e>>BigInt(16)&BigInt(255)),Number(e>>BigInt(24)&BigInt(255))])}else throw new Error("BigInt compact encoding not supported > 2^30")}function hm(i){const e=Uint8Array.from(Buffer.from(i.signature,"hex")),t=im(i.transaction.address),s=sm({publicKey:t,signature:e,payload:i.transaction}),r=Buffer.from(s).toString("hex");return rm(r)}var lm={};const Wh="wc",Jh=2,dn="core",yt=`${Wh}@2:${dn}:`,um={logger:"error"},dm={database:":memory:"},fm="crypto",ya="client_ed25519_seed",pm=N.ONE_DAY,gm="keychain",ym="0.3",mm="messages",wm="0.3",ma=N.SIX_HOURS,bm="publisher",Yh="irn",vm="error",Zh="wss://relay.walletconnect.org",Em="relayer",ge={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Im="_subscription",Ve={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},xm=.1,fn="2.21.4",re={link_mode:"link_mode",relay:"relay"},Fs={inbound:"inbound",outbound:"outbound"},_m="0.3",Pm="WALLETCONNECT_CLIENT_ID",wa="WALLETCONNECT_LINK_MODE_APPS",je={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},$m="subscription",Sm="0.3",Am="pairing",Om="0.3",Ji={wc_pairingDelete:{req:{ttl:N.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:N.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:N.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:N.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:N.ONE_DAY,prompt:!1,tag:0},res:{ttl:N.ONE_DAY,prompt:!1,tag:0}}},Yt={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},et={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Tm="history",Rm="0.3",Um="expirer",Ge={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Cm="0.3",Nm="verify-api",Bm="https://verify.walletconnect.com",Qh="https://verify.walletconnect.org",ls=Qh,km=`${ls}/v3`,Dm=[Bm,Qh],qm="echo",jm="https://echo.walletconnect.com",ut={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},It={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},tt={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},Gt={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},Wt={authenticated_session_approve_started:"authenticated_session_approve_started",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve"},Yi={no_internet_connection:"no_internet_connection",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},Lm=.1,Mm="event-client",zm=86400,Hm="https://pulse.walletconnect.org/batch";function Fm(i,e){if(i.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var r=0;r<i.length;r++){var n=i.charAt(r),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=r}var a=i.length,c=i.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var g=0,b=0,T=0,$=m.length;T!==$&&m[T]===0;)T++,g++;for(var D=($-T)*l+1>>>0,M=new Uint8Array(D);T!==$;){for(var R=m[T],j=0,L=D-1;(R!==0||j<b)&&L!==-1;L--,j++)R+=256*M[L]>>>0,M[L]=R%a>>>0,R=R/a>>>0;if(R!==0)throw new Error("Non-zero carry");b=j,T++}for(var q=D-b;q!==D&&M[q]===0;)q++;for(var y=c.repeat(g);q<D;++q)y+=i.charAt(M[q]);return y}function d(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var g=0;if(m[g]!==" "){for(var b=0,T=0;m[g]===c;)b++,g++;for(var $=(m.length-g)*h+1>>>0,D=new Uint8Array($);m[g];){var M=t[m.charCodeAt(g)];if(M===255)return;for(var R=0,j=$-1;(M!==0||R<T)&&j!==-1;j--,R++)M+=a*D[j]>>>0,D[j]=M%256>>>0,M=M/256>>>0;if(M!==0)throw new Error("Non-zero carry");T=R,g++}if(m[g]!==" "){for(var L=$-T;L!==$&&D[L]===0;)L++;for(var q=new Uint8Array(b+($-L)),y=b;L!==$;)q[y++]=D[L++];return q}}}function p(m){var g=d(m);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:d,decode:p}}var Vm=Fm,Km=Vm;const Xh=i=>{if(i instanceof Uint8Array&&i.constructor.name==="Uint8Array")return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(ArrayBuffer.isView(i))return new Uint8Array(i.buffer,i.byteOffset,i.byteLength);throw new Error("Unknown type, must be binary type")},Gm=i=>new TextEncoder().encode(i),Wm=i=>new TextDecoder().decode(i);class Jm{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Ym{constructor(e,t,s){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=s}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return el(this,e)}}class Zm{constructor(e){this.decoders=e}or(e){return el(this,e)}decode(e){const t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const el=(i,e)=>new Zm({...i.decoders||{[i.prefix]:i},...e.decoders||{[e.prefix]:e}});class Qm{constructor(e,t,s,r){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=r,this.encoder=new Jm(e,t,s),this.decoder=new Ym(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const fr=({name:i,prefix:e,encode:t,decode:s})=>new Qm(i,e,t,s),xs=({prefix:i,name:e,alphabet:t})=>{const{encode:s,decode:r}=Km(t,e);return fr({prefix:i,name:e,encode:s,decode:n=>Xh(r(n))})},Xm=(i,e,t,s)=>{const r={};for(let l=0;l<e.length;++l)r[e[l]]=l;let n=i.length;for(;i[n-1]==="=";)--n;const o=new Uint8Array(n*t/8|0);let a=0,c=0,h=0;for(let l=0;l<n;++l){const u=r[i[l]];if(u===void 0)throw new SyntaxError(`Non-${s} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},ew=(i,e,t)=>{const s=e[e.length-1]==="=",r=(1<<t)-1;let n="",o=0,a=0;for(let c=0;c<i.length;++c)for(a=a<<8|i[c],o+=8;o>t;)o-=t,n+=e[r&a>>o];if(o&&(n+=e[r&a<<t-o]),s)for(;n.length*t&7;)n+="=";return n},Ee=({name:i,prefix:e,bitsPerChar:t,alphabet:s})=>fr({prefix:e,name:i,encode(r){return ew(r,s,t)},decode(r){return Xm(r,s,t,i)}}),tw=fr({prefix:"\0",name:"identity",encode:i=>Wm(i),decode:i=>Gm(i)});var iw=Object.freeze({__proto__:null,identity:tw});const sw=Ee({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var rw=Object.freeze({__proto__:null,base2:sw});const nw=Ee({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var ow=Object.freeze({__proto__:null,base8:nw});const aw=xs({prefix:"9",name:"base10",alphabet:"0123456789"});var cw=Object.freeze({__proto__:null,base10:aw});const hw=Ee({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),lw=Ee({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var uw=Object.freeze({__proto__:null,base16:hw,base16upper:lw});const dw=Ee({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),fw=Ee({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),pw=Ee({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),gw=Ee({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),yw=Ee({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),mw=Ee({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ww=Ee({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),bw=Ee({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),vw=Ee({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Ew=Object.freeze({__proto__:null,base32:dw,base32upper:fw,base32pad:pw,base32padupper:gw,base32hex:yw,base32hexupper:mw,base32hexpad:ww,base32hexpadupper:bw,base32z:vw});const Iw=xs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),xw=xs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var _w=Object.freeze({__proto__:null,base36:Iw,base36upper:xw});const Pw=xs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),$w=xs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Sw=Object.freeze({__proto__:null,base58btc:Pw,base58flickr:$w});const Aw=Ee({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ow=Ee({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Tw=Ee({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Rw=Ee({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Uw=Object.freeze({__proto__:null,base64:Aw,base64pad:Ow,base64url:Tw,base64urlpad:Rw});const tl=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),Cw=tl.reduce((i,e,t)=>(i[t]=e,i),[]),Nw=tl.reduce((i,e,t)=>(i[e.codePointAt(0)]=t,i),[]);function Bw(i){return i.reduce((e,t)=>(e+=Cw[t],e),"")}function kw(i){const e=[];for(const t of i){const s=Nw[t.codePointAt(0)];if(s===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const Dw=fr({prefix:"🚀",name:"base256emoji",encode:Bw,decode:kw});var qw=Object.freeze({__proto__:null,base256emoji:Dw}),jw=il,ba=128,Lw=-128,Mw=Math.pow(2,31);function il(i,e,t){e=e||[],t=t||0;for(var s=t;i>=Mw;)e[t++]=i&255|ba,i/=128;for(;i&Lw;)e[t++]=i&255|ba,i>>>=7;return e[t]=i|0,il.bytes=t-s+1,e}var zw=pn,Hw=128,va=127;function pn(i,s){var t=0,s=s||0,r=0,n=s,o,a=i.length;do{if(n>=a)throw pn.bytes=0,new RangeError("Could not decode varint");o=i[n++],t+=r<28?(o&va)<<r:(o&va)*Math.pow(2,r),r+=7}while(o>=Hw);return pn.bytes=n-s,t}var Fw=Math.pow(2,7),Vw=Math.pow(2,14),Kw=Math.pow(2,21),Gw=Math.pow(2,28),Ww=Math.pow(2,35),Jw=Math.pow(2,42),Yw=Math.pow(2,49),Zw=Math.pow(2,56),Qw=Math.pow(2,63),Xw=function(i){return i<Fw?1:i<Vw?2:i<Kw?3:i<Gw?4:i<Ww?5:i<Jw?6:i<Yw?7:i<Zw?8:i<Qw?9:10},e0={encode:jw,decode:zw,encodingLength:Xw},sl=e0;const Ea=(i,e,t=0)=>(sl.encode(i,e,t),e),Ia=i=>sl.encodingLength(i),gn=(i,e)=>{const t=e.byteLength,s=Ia(i),r=s+Ia(t),n=new Uint8Array(r+t);return Ea(i,n,0),Ea(t,n,s),n.set(e,r),new t0(i,t,e,n)};class t0{constructor(e,t,s,r){this.code=e,this.size=t,this.digest=s,this.bytes=r}}const rl=({name:i,code:e,encode:t})=>new i0(i,e,t);class i0{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?gn(this.code,t):t.then(s=>gn(this.code,s))}else throw Error("Unknown type, must be binary type")}}const nl=i=>async e=>new Uint8Array(await crypto.subtle.digest(i,e)),s0=rl({name:"sha2-256",code:18,encode:nl("SHA-256")}),r0=rl({name:"sha2-512",code:19,encode:nl("SHA-512")});var n0=Object.freeze({__proto__:null,sha256:s0,sha512:r0});const ol=0,o0="identity",al=Xh,a0=i=>gn(ol,al(i)),c0={code:ol,name:o0,encode:al,digest:a0};var h0=Object.freeze({__proto__:null,identity:c0});new TextEncoder,new TextDecoder;const xa={...iw,...rw,...ow,...cw,...uw,...Ew,..._w,...Sw,...Uw,...qw};({...n0,...h0});function cl(i){return globalThis.Buffer!=null?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):i}function l0(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?cl(globalThis.Buffer.allocUnsafe(i)):new Uint8Array(i)}function hl(i,e,t,s){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:s}}}const _a=hl("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),Rr=hl("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);const e=l0(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),u0={utf8:_a,"utf-8":_a,hex:xa.base16,latin1:Rr,ascii:Rr,binary:Rr,...xa};function d0(i,e="utf8"){const t=u0[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?cl(globalThis.Buffer.from(i,"utf-8")):t.decoder.decode(`${t.prefix}${i}`)}var f0=Object.defineProperty,p0=(i,e,t)=>e in i?f0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ht=(i,e,t)=>p0(i,typeof e!="symbol"?e+"":e,t);class g0{constructor(e,t){this.core=e,this.logger=t,ht(this,"keychain",new Map),ht(this,"name",gm),ht(this,"version",ym),ht(this,"initialized",!1),ht(this,"storagePrefix",yt),ht(this,"init",async()=>{if(!this.initialized){const s=await this.getKeyChain();typeof s<"u"&&(this.keychain=s),this.initialized=!0}}),ht(this,"has",s=>(this.isInitialized(),this.keychain.has(s))),ht(this,"set",async(s,r)=>{this.isInitialized(),this.keychain.set(s,r),await this.persist()}),ht(this,"get",s=>{this.isInitialized();const r=this.keychain.get(s);if(typeof r>"u"){const{message:n}=C("NO_MATCHING_KEY",`${this.name}: ${s}`);throw new Error(n)}return r}),ht(this,"del",async s=>{this.isInitialized(),this.keychain.delete(s),await this.persist()}),this.core=e,this.logger=Te(t,this.name)}get context(){return He(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,Qr(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Xr(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}}var y0=Object.defineProperty,m0=(i,e,t)=>e in i?y0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,we=(i,e,t)=>m0(i,typeof e!="symbol"?e+"":e,t);class w0{constructor(e,t,s){this.core=e,this.logger=t,we(this,"name",fm),we(this,"keychain"),we(this,"randomSessionIdentifier",ln()),we(this,"initialized",!1),we(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),we(this,"hasKeys",r=>(this.isInitialized(),this.keychain.has(r))),we(this,"getClientId",async()=>{this.isInitialized();const r=await this.getClientSeed(),n=oo(r);return Bl(n.publicKey)}),we(this,"generateKeyPair",()=>{this.isInitialized();const r=Xg();return this.setPrivateKey(r.publicKey,r.privateKey)}),we(this,"signJWT",async r=>{this.isInitialized();const n=await this.getClientSeed(),o=oo(n),a=this.randomSessionIdentifier;return await kl(a,r,pm,o)}),we(this,"generateSharedKey",(r,n,o)=>{this.isInitialized();const a=this.getPrivateKey(r),c=ey(a,n);return this.setSymKey(c,o)}),we(this,"setSymKey",async(r,n)=>{this.isInitialized();const o=n||Hs(r);return await this.keychain.set(o,r),o}),we(this,"deleteKeyPair",async r=>{this.isInitialized(),await this.keychain.del(r)}),we(this,"deleteSymKey",async r=>{this.isInitialized(),await this.keychain.del(r)}),we(this,"encode",async(r,n,o)=>{this.isInitialized();const a=Vh(o),c=Hr(n);if(ra(a))return sy(c,o==null?void 0:o.encoding);if(sa(a)){const d=a.senderPublicKey,p=a.receiverPublicKey;r=await this.generateSharedKey(d,p)}const h=this.getSymKey(r),{type:l,senderPublicKey:u}=a;return ty({type:l,symKey:h,message:c,senderPublicKey:u,encoding:o==null?void 0:o.encoding})}),we(this,"decode",async(r,n,o)=>{this.isInitialized();const a=ny(n,o);if(ra(a)){const c=ry(n,o==null?void 0:o.encoding);return Fr(c)}if(sa(a)){const c=a.receiverPublicKey,h=a.senderPublicKey;r=await this.generateSharedKey(c,h)}try{const c=this.getSymKey(r),h=iy({symKey:c,encoded:n,encoding:o==null?void 0:o.encoding});return Fr(h)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}}),we(this,"getPayloadType",(r,n=nt)=>{const o=ms({encoded:r,encoding:n});return ni(o.type)}),we(this,"getPayloadSenderPublicKey",(r,n=nt)=>{const o=ms({encoded:r,encoding:n});return o.senderPublicKey?De(o.senderPublicKey,Oe):void 0}),this.core=e,this.logger=Te(t,this.name),this.keychain=s||new g0(this.core,this.logger)}get context(){return He(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(ya)}catch{e=ln(),await this.keychain.set(ya,e)}return d0(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}}var b0=Object.defineProperty,v0=Object.defineProperties,E0=Object.getOwnPropertyDescriptors,Pa=Object.getOwnPropertySymbols,I0=Object.prototype.hasOwnProperty,x0=Object.prototype.propertyIsEnumerable,yn=(i,e,t)=>e in i?b0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,_0=(i,e)=>{for(var t in e||(e={}))I0.call(e,t)&&yn(i,t,e[t]);if(Pa)for(var t of Pa(e))x0.call(e,t)&&yn(i,t,e[t]);return i},P0=(i,e)=>v0(i,E0(e)),qe=(i,e,t)=>yn(i,typeof e!="symbol"?e+"":e,t);class $0 extends eu{constructor(e,t){super(e,t),this.logger=e,this.core=t,qe(this,"messages",new Map),qe(this,"messagesWithoutClientAck",new Map),qe(this,"name",mm),qe(this,"version",wm),qe(this,"initialized",!1),qe(this,"storagePrefix",yt),qe(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const s=await this.getRelayerMessages();typeof s<"u"&&(this.messages=s);const r=await this.getRelayerMessagesWithoutClientAck();typeof r<"u"&&(this.messagesWithoutClientAck=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(s){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(s)}finally{this.initialized=!0}}}),qe(this,"set",async(s,r,n)=>{this.isInitialized();const o=ft(r);let a=this.messages.get(s);if(typeof a>"u"&&(a={}),typeof a[o]<"u")return o;if(a[o]=r,this.messages.set(s,a),n===Fs.inbound){const c=this.messagesWithoutClientAck.get(s)||{};this.messagesWithoutClientAck.set(s,P0(_0({},c),{[o]:r}))}return await this.persist(),o}),qe(this,"get",s=>{this.isInitialized();let r=this.messages.get(s);return typeof r>"u"&&(r={}),r}),qe(this,"getWithoutAck",s=>{this.isInitialized();const r={};for(const n of s){const o=this.messagesWithoutClientAck.get(n)||{};r[n]=Object.values(o)}return r}),qe(this,"has",(s,r)=>{this.isInitialized();const n=this.get(s),o=ft(r);return typeof n[o]<"u"}),qe(this,"ack",async(s,r)=>{this.isInitialized();const n=this.messagesWithoutClientAck.get(s);if(typeof n>"u")return;const o=ft(r);delete n[o],Object.keys(n).length===0?this.messagesWithoutClientAck.delete(s):this.messagesWithoutClientAck.set(s,n),await this.persist()}),qe(this,"del",async s=>{this.isInitialized(),this.messages.delete(s),this.messagesWithoutClientAck.delete(s),await this.persist()}),this.logger=Te(e,this.name),this.core=t}get context(){return He(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,Qr(e))}async setRelayerMessagesWithoutClientAck(e){await this.core.storage.setItem(this.storageKeyWithoutClientAck,Qr(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Xr(e):void 0}async getRelayerMessagesWithoutClientAck(){const e=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return typeof e<"u"?Xr(e):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}}var S0=Object.defineProperty,A0=Object.defineProperties,O0=Object.getOwnPropertyDescriptors,$a=Object.getOwnPropertySymbols,T0=Object.prototype.hasOwnProperty,R0=Object.prototype.propertyIsEnumerable,mn=(i,e,t)=>e in i?S0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ks=(i,e)=>{for(var t in e||(e={}))T0.call(e,t)&&mn(i,t,e[t]);if($a)for(var t of $a(e))R0.call(e,t)&&mn(i,t,e[t]);return i},Ur=(i,e)=>A0(i,O0(e)),it=(i,e,t)=>mn(i,typeof e!="symbol"?e+"":e,t);class U0 extends tu{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,it(this,"events",new Vt.EventEmitter),it(this,"name",bm),it(this,"queue",new Map),it(this,"publishTimeout",N.toMiliseconds(N.ONE_MINUTE)),it(this,"initialPublishTimeout",N.toMiliseconds(N.ONE_SECOND*15)),it(this,"needsTransportRestart",!1),it(this,"publish",async(s,r,n)=>{var o;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:s,message:r,opts:n}});const a=(n==null?void 0:n.ttl)||ma,c=tr(n),h=(n==null?void 0:n.prompt)||!1,l=(n==null?void 0:n.tag)||0,u=(n==null?void 0:n.id)||Pi().toString(),d={topic:s,message:r,opts:{ttl:a,relay:c,prompt:h,tag:l,id:u,attestation:n==null?void 0:n.attestation,tvf:n==null?void 0:n.tvf}},p=`Failed to publish payload, please try again. id:${u} tag:${l}`;try{const m=new Promise(async g=>{const b=({id:$})=>{d.opts.id===$&&(this.removeRequestFromQueue($),this.relayer.events.removeListener(ge.publish,b),g(d))};this.relayer.events.on(ge.publish,b);const T=zt(new Promise(($,D)=>{this.rpcPublish({topic:s,message:r,ttl:a,prompt:h,tag:l,id:u,attestation:n==null?void 0:n.attestation,tvf:n==null?void 0:n.tvf}).then($).catch(M=>{this.logger.warn(M,M==null?void 0:M.message),D(M)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${u} tag:${l}`);try{await T,this.events.removeListener(ge.publish,b)}catch($){this.queue.set(u,Ur(ks({},d),{attempt:1})),this.logger.warn($,$==null?void 0:$.message)}});this.logger.trace({type:"method",method:"publish",params:{id:u,topic:s,message:r,opts:n}}),await zt(m,this.publishTimeout,p)}catch(m){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(m),(o=n==null?void 0:n.internal)!=null&&o.throwOnFailedPublish)throw m}finally{this.queue.delete(u)}}),it(this,"on",(s,r)=>{this.events.on(s,r)}),it(this,"once",(s,r)=>{this.events.once(s,r)}),it(this,"off",(s,r)=>{this.events.off(s,r)}),it(this,"removeListener",(s,r)=>{this.events.removeListener(s,r)}),this.relayer=e,this.logger=Te(t,this.name),this.registerEventListeners()}get context(){return He(this.logger)}async rpcPublish(e){var t,s,r,n;const{topic:o,message:a,ttl:c=ma,prompt:h,tag:l,id:u,attestation:d,tvf:p}=e,m={method:is(tr().protocol).publish,params:ks({topic:o,message:a,ttl:c,prompt:h,tag:l,attestation:d},p),id:u};ve((t=m.params)==null?void 0:t.prompt)&&((s=m.params)==null||delete s.prompt),ve((r=m.params)==null?void 0:r.tag)&&((n=m.params)==null||delete n.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:m});const g=await this.relayer.request(m);return this.relayer.events.emit(ge.publish,e),this.logger.debug("Successfully Published Payload"),g}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,t)=>{const s=e.attempt+1;this.queue.set(t,Ur(ks({},e),{attempt:s}));const{topic:r,message:n,opts:o,attestation:a}=e;this.logger.warn({},`Publisher: queue->publishing: ${e.opts.id}, tag: ${e.opts.tag}, attempt: ${s}`),await this.rpcPublish(Ur(ks({},e),{topic:r,message:n,ttl:o.ttl,prompt:o.prompt,tag:o.tag,id:o.id,attestation:a,tvf:o.tvf})),this.logger.warn({},`Publisher: queue->published: ${e.opts.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(Ci.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(ge.connection_stalled);return}this.checkQueue()}),this.relayer.on(ge.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}}var C0=Object.defineProperty,N0=(i,e,t)=>e in i?C0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ui=(i,e,t)=>N0(i,typeof e!="symbol"?e+"":e,t);class B0{constructor(){ui(this,"map",new Map),ui(this,"set",(e,t)=>{const s=this.get(e);this.exists(e,t)||this.map.set(e,[...s,t])}),ui(this,"get",e=>this.map.get(e)||[]),ui(this,"exists",(e,t)=>this.get(e).includes(t)),ui(this,"delete",(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const s=this.get(e);if(!this.exists(e,t))return;const r=s.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)}),ui(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}}var k0=Object.defineProperty,D0=Object.defineProperties,q0=Object.getOwnPropertyDescriptors,Sa=Object.getOwnPropertySymbols,j0=Object.prototype.hasOwnProperty,L0=Object.prototype.propertyIsEnumerable,wn=(i,e,t)=>e in i?k0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Zi=(i,e)=>{for(var t in e||(e={}))j0.call(e,t)&&wn(i,t,e[t]);if(Sa)for(var t of Sa(e))L0.call(e,t)&&wn(i,t,e[t]);return i},Cr=(i,e)=>D0(i,q0(e)),te=(i,e,t)=>wn(i,typeof e!="symbol"?e+"":e,t);class M0 extends ru{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,te(this,"subscriptions",new Map),te(this,"topicMap",new B0),te(this,"events",new Vt.EventEmitter),te(this,"name",$m),te(this,"version",Sm),te(this,"pending",new Map),te(this,"cached",[]),te(this,"initialized",!1),te(this,"storagePrefix",yt),te(this,"subscribeTimeout",N.toMiliseconds(N.ONE_MINUTE)),te(this,"initialSubscribeTimeout",N.toMiliseconds(N.ONE_SECOND*15)),te(this,"clientId"),te(this,"batchSubscribeTopicsLimit",500),te(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),te(this,"subscribe",async(s,r)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}});try{const n=tr(r),o={topic:s,relay:n,transportType:r==null?void 0:r.transportType};this.pending.set(s,o);const a=await this.rpcSubscribe(s,n,r);return typeof a=="string"&&(this.onSubscribe(a,o),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}})),a}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}}),te(this,"unsubscribe",async(s,r)=>{this.isInitialized(),typeof(r==null?void 0:r.id)<"u"?await this.unsubscribeById(s,r.id,r):await this.unsubscribeByTopic(s,r)}),te(this,"isSubscribed",s=>new Promise(r=>{r(this.topicMap.topics.includes(s))})),te(this,"isKnownTopic",s=>new Promise(r=>{r(this.topicMap.topics.includes(s)||this.pending.has(s)||this.cached.some(n=>n.topic===s))})),te(this,"on",(s,r)=>{this.events.on(s,r)}),te(this,"once",(s,r)=>{this.events.once(s,r)}),te(this,"off",(s,r)=>{this.events.off(s,r)}),te(this,"removeListener",(s,r)=>{this.events.removeListener(s,r)}),te(this,"start",async()=>{await this.onConnect()}),te(this,"stop",async()=>{await this.onDisconnect()}),te(this,"restart",async()=>{await this.restore(),await this.onRestart()}),te(this,"checkPending",async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;const s=[];this.pending.forEach(r=>{s.push(r)}),await this.batchSubscribe(s)}),te(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(Ci.pulse,async()=>{await this.checkPending()}),this.events.on(je.created,async s=>{const r=je.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:s}),await this.persist()}),this.events.on(je.deleted,async s=>{const r=je.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:s}),await this.persist()})}),this.relayer=e,this.logger=Te(t,this.name),this.clientId=""}get context(){return He(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(e,t){let s=!1;try{s=this.getSubscription(e).topic===t}catch{}return s}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const s=this.topicMap.get(e);await Promise.all(s.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,s){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}});try{const r=tr(s);await this.restartToComplete({topic:e,id:t,relay:r}),await this.rpcUnsubscribe(e,t,r);const n=ne("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,s){var r;(!s||(s==null?void 0:s.transportType)===re.relay)&&await this.restartToComplete({topic:e,id:e,relay:t});const n={method:is(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});const o=(r=s==null?void 0:s.internal)==null?void 0:r.throwOnFailedPublish;try{const a=await this.getSubscriptionId(e);if((s==null?void 0:s.transportType)===re.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(n).catch(l=>this.logger.warn(l))},N.toMiliseconds(N.ONE_SECOND)),a;const c=new Promise(async l=>{const u=d=>{d.topic===e&&(this.events.removeListener(je.created,u),l(d.id))};this.events.on(je.created,u);try{const d=await zt(new Promise((p,m)=>{this.relayer.request(n).catch(g=>{this.logger.warn(g,g==null?void 0:g.message),m(g)}).then(p)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(je.created,u),l(d)}catch{}}),h=await zt(c,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!h&&o)throw new Error(`Subscribing to ${e} failed, please try again`);return h?a:null}catch(a){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(ge.connection_stalled),o)throw a}return null}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,s={method:is(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});try{await await zt(new Promise(r=>{this.relayer.request(s).catch(n=>this.logger.warn(n)).then(r)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(ge.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;const t=e[0].relay,s={method:is(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});let r;try{r=await await zt(new Promise((n,o)=>{this.relayer.request(s).catch(a=>{this.logger.warn(a),o(a)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(ge.connection_stalled)}return r}rpcUnsubscribe(e,t,s){const r={method:is(s.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,Cr(Zi({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,Zi({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,s){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,s),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,Zi({},t)),this.topicMap.set(t.topic,e),this.events.emit(je.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:s}=C("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const s=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(s.topic,e),this.events.emit(je.deleted,Cr(Zi({},s),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(je.sync)}async onRestart(){if(this.cached.length){const e=[...this.cached],t=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let s=0;s<t;s++){const r=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(r)}}this.events.emit(je.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:t}=C("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(await Promise.all(e.map(async t=>Cr(Zi({},t),{id:await this.getSubscriptionId(t.topic)})))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);const t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(await Ef(N.toMiliseconds(N.ONE_SECOND)),await this.relayer.handleBatchMessageEvents(t.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(e){!this.relayer.connected&&!this.relayer.connecting&&(this.cached.push(e),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(e){return ft(e+await this.getClientId())}}var z0=Object.defineProperty,Aa=Object.getOwnPropertySymbols,H0=Object.prototype.hasOwnProperty,F0=Object.prototype.propertyIsEnumerable,bn=(i,e,t)=>e in i?z0(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Oa=(i,e)=>{for(var t in e||(e={}))H0.call(e,t)&&bn(i,t,e[t]);if(Aa)for(var t of Aa(e))F0.call(e,t)&&bn(i,t,e[t]);return i},Y=(i,e,t)=>bn(i,typeof e!="symbol"?e+"":e,t);class V0 extends iu{constructor(e){super(e),Y(this,"protocol","wc"),Y(this,"version",2),Y(this,"core"),Y(this,"logger"),Y(this,"events",new Vt.EventEmitter),Y(this,"provider"),Y(this,"messages"),Y(this,"subscriber"),Y(this,"publisher"),Y(this,"name",Em),Y(this,"transportExplicitlyClosed",!1),Y(this,"initialized",!1),Y(this,"connectionAttemptInProgress",!1),Y(this,"relayUrl"),Y(this,"projectId"),Y(this,"packageName"),Y(this,"bundleId"),Y(this,"hasExperiencedNetworkDisruption",!1),Y(this,"pingTimeout"),Y(this,"heartBeatTimeout",N.toMiliseconds(N.THIRTY_SECONDS+N.FIVE_SECONDS)),Y(this,"reconnectTimeout"),Y(this,"connectPromise"),Y(this,"reconnectInProgress",!1),Y(this,"requestsInFlight",[]),Y(this,"connectTimeout",N.toMiliseconds(N.ONE_SECOND*15)),Y(this,"request",async t=>{var s,r;this.logger.debug("Publishing Request Payload");const n=t.id||Pi().toString();await this.toEstablishConnection();try{this.logger.trace({id:n,method:t.method,topic:(s=t.params)==null?void 0:s.topic},"relayer.request - publishing...");const o=`${n}:${((r=t.params)==null?void 0:r.tag)||""}`;this.requestsInFlight.push(o);const a=await this.provider.request(t);return this.requestsInFlight=this.requestsInFlight.filter(c=>c!==o),a}catch(o){throw this.logger.debug(`Failed to Publish Request: ${n}`),o}}),Y(this,"resetPingTimeout",()=>{Zs()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,s,r,n;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(n=(r=(s=(t=this.provider)==null?void 0:t.connection)==null?void 0:s.socket)==null?void 0:r.terminate)==null||n.call(r)}catch(o){this.logger.warn(o,o==null?void 0:o.message)}},this.heartBeatTimeout))}),Y(this,"onPayloadHandler",t=>{this.onProviderPayload(t),this.resetPingTimeout()}),Y(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected 🛜"),this.startPingTimeout(),this.events.emit(ge.connect)}),Y(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected 🛑"),this.requestsInFlight=[],this.onProviderDisconnect()}),Y(this,"onProviderErrorHandler",t=>{this.logger.fatal(`Fatal socket error: ${t.message}`),this.events.emit(ge.error,t),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),Y(this,"registerProviderListeners",()=>{this.provider.on(Ve.payload,this.onPayloadHandler),this.provider.on(Ve.connect,this.onConnectHandler),this.provider.on(Ve.disconnect,this.onDisconnectHandler),this.provider.on(Ve.error,this.onProviderErrorHandler)}),this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?Te(e.logger,this.name):An(sr({level:e.logger||vm})),this.messages=new $0(this.logger,e.core),this.subscriber=new M0(this,this.logger),this.publisher=new U0(this,this.logger),this.relayUrl=(e==null?void 0:e.relayUrl)||Zh,this.projectId=e.projectId,nf()?this.packageName=Po():of()&&(this.bundleId=Po()),this.provider={}}async init(){this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.transportOpen().catch(e=>this.logger.warn(e,e==null?void 0:e.message))}get context(){return He(this.logger)}get connected(){var e,t,s;return((s=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:s.readyState)===1||!1}get connecting(){var e,t,s;return((s=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:s.readyState)===0||this.connectPromise!==void 0||!1}async publish(e,t,s){this.isInitialized(),await this.publisher.publish(e,t,s),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:re.relay},Fs.outbound)}async subscribe(e,t){var s,r,n;this.isInitialized(),(!(t!=null&&t.transportType)||(t==null?void 0:t.transportType)==="relay")&&await this.toEstablishConnection();const o=typeof((s=t==null?void 0:t.internal)==null?void 0:s.throwOnFailedPublish)>"u"?!0:(r=t==null?void 0:t.internal)==null?void 0:r.throwOnFailedPublish;let a=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c;const h=l=>{l.topic===e&&(this.subscriber.off(je.created,h),c())};return await Promise.all([new Promise(l=>{c=l,this.subscriber.on(je.created,h)}),new Promise(async(l,u)=>{a=await this.subscriber.subscribe(e,Oa({internal:{throwOnFailedPublish:o}},t)).catch(d=>{o&&u(d)})||a,l()})]),a}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await zt(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(!this.subscriber.hasAnyTopics){this.logger.warn("Starting WS connection skipped because the client has no topics to work with.");return}if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(t,s)=>{await this.connect(e).then(t).catch(s).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await ga())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if((e==null?void 0:e.length)===0){this.logger.trace("Batch message events is empty. Ignoring...");return}const t=e.sort((s,r)=>s.publishedAt-r.publishedAt);this.logger.debug(`Batch of ${t.length} message events sorted`);for(const s of t)try{await this.onMessageEvent(s)}catch(r){this.logger.warn(r,"Error while processing batch message event: "+(r==null?void 0:r.message))}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){const{topic:s}=e;if(!t.sessionExists){const r=de(N.FIVE_MINUTES),n={topic:s,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(s,n)}this.events.emit(ge.message,e),await this.recordMessageEvent(e,Fs.inbound)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let t=1;for(;t<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${t}...`),await this.createProvider(),await new Promise(async(s,r)=>{const n=()=>{r(new Error("Connection interrupted while trying to connect"))};this.provider.once(Ve.disconnect,n),await zt(new Promise((o,a)=>{this.provider.connect().then(o).catch(a)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{r(o)}).finally(()=>{this.provider.off(Ve.disconnect,n),clearTimeout(this.reconnectTimeout)}),await new Promise(async(o,a)=>{const c=()=>{r(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(Ve.disconnect,c),await this.subscriber.start().then(o).catch(a).finally(()=>{this.provider.off(Ve.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,s()})}catch(s){await this.subscriber.stop();const r=s;this.logger.warn({},r.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${t}`);break}await new Promise(s=>setTimeout(s,N.toMiliseconds(t*1))),t++}}startPingTimeout(){var e,t,s,r,n;if(Zs())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(s=this.provider)==null?void 0:s.connection)==null?void 0:r.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o==null?void 0:o.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Qe(new Nl(uf({sdkVersion:fn,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e,t){const{topic:s,message:r}=e;await this.messages.set(s,r,t)}async shouldIgnoreMessageEvent(e){const{topic:t,message:s}=e;if(!s||s.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${s}`),!0;if(!await this.subscriber.isKnownTopic(t))return this.logger.warn(`Ignoring message for unknown topic ${t}`),!0;const r=this.messages.has(t,s);return r&&this.logger.warn(`Ignoring duplicate message: ${s}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),On(e)){if(!e.method.endsWith(Im))return;const t=e.params,{topic:s,message:r,publishedAt:n,attestation:o}=t.data,a={topic:s,message:r,publishedAt:n,transportType:re.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Oa({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else Tn(e)&&this.events.emit(ge.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(await this.recordMessageEvent(e,Fs.inbound),this.events.emit(ge.message,e))}async acknowledgePayload(e){const t=rr(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(Ve.payload,this.onPayloadHandler),this.provider.off(Ve.connect,this.onConnectHandler),this.provider.off(Ve.disconnect,this.onDisconnectHandler),this.provider.off(Ve.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await ga();Qy(async t=>{e!==t&&(e=t,t?await this.transportOpen().catch(s=>this.logger.error(s,s==null?void 0:s.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(Ci.pulse,async()=>{if(!this.transportExplicitlyClosed&&!this.connected&&tm())try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(t){this.logger.warn(t,t==null?void 0:t.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(ge.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e,e==null?void 0:e.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},N.toMiliseconds(xm)))))}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise){await this.connectPromise;return}await this.connect()}}}function K0(i,e){return i===e||Number.isNaN(i)&&Number.isNaN(e)}function Ta(i){return Object.getOwnPropertySymbols(i).filter(e=>Object.prototype.propertyIsEnumerable.call(i,e))}function Ra(i){return i==null?i===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(i)}const G0="[object RegExp]",W0="[object String]",J0="[object Number]",Y0="[object Boolean]",Ua="[object Arguments]",Z0="[object Symbol]",Q0="[object Date]",X0="[object Map]",eb="[object Set]",tb="[object Array]",ib="[object Function]",sb="[object ArrayBuffer]",Nr="[object Object]",rb="[object Error]",nb="[object DataView]",ob="[object Uint8Array]",ab="[object Uint8ClampedArray]",cb="[object Uint16Array]",hb="[object Uint32Array]",lb="[object BigUint64Array]",ub="[object Int8Array]",db="[object Int16Array]",fb="[object Int32Array]",pb="[object BigInt64Array]",gb="[object Float32Array]",yb="[object Float64Array]";function mb(){}function Ca(i){if(!i||typeof i!="object")return!1;const e=Object.getPrototypeOf(i);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(i)==="[object Object]":!1}function wb(i,e,t){return ss(i,e,void 0,void 0,void 0,void 0,t)}function ss(i,e,t,s,r,n,o){const a=o(i,e,t,s,r,n);if(a!==void 0)return a;if(typeof i==typeof e)switch(typeof i){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return i===e;case"number":return i===e||Object.is(i,e);case"function":return i===e;case"object":return us(i,e,n,o)}return us(i,e,n,o)}function us(i,e,t,s){if(Object.is(i,e))return!0;let r=Ra(i),n=Ra(e);if(r===Ua&&(r=Nr),n===Ua&&(n=Nr),r!==n)return!1;switch(r){case W0:return i.toString()===e.toString();case J0:{const c=i.valueOf(),h=e.valueOf();return K0(c,h)}case Y0:case Q0:case Z0:return Object.is(i.valueOf(),e.valueOf());case G0:return i.source===e.source&&i.flags===e.flags;case ib:return i===e}t=t??new Map;const o=t.get(i),a=t.get(e);if(o!=null&&a!=null)return o===e;t.set(i,e),t.set(e,i);try{switch(r){case X0:{if(i.size!==e.size)return!1;for(const[c,h]of i.entries())if(!e.has(c)||!ss(h,e.get(c),c,i,e,t,s))return!1;return!0}case eb:{if(i.size!==e.size)return!1;const c=Array.from(i.values()),h=Array.from(e.values());for(let l=0;l<c.length;l++){const u=c[l],d=h.findIndex(p=>ss(u,p,void 0,i,e,t,s));if(d===-1)return!1;h.splice(d,1)}return!0}case tb:case ob:case ab:case cb:case hb:case lb:case ub:case db:case fb:case pb:case gb:case yb:{if(typeof Buffer<"u"&&Buffer.isBuffer(i)!==Buffer.isBuffer(e)||i.length!==e.length)return!1;for(let c=0;c<i.length;c++)if(!ss(i[c],e[c],c,i,e,t,s))return!1;return!0}case sb:return i.byteLength!==e.byteLength?!1:us(new Uint8Array(i),new Uint8Array(e),t,s);case nb:return i.byteLength!==e.byteLength||i.byteOffset!==e.byteOffset?!1:us(new Uint8Array(i),new Uint8Array(e),t,s);case rb:return i.name===e.name&&i.message===e.message;case Nr:{if(!(us(i.constructor,e.constructor,t,s)||Ca(i)&&Ca(e)))return!1;const c=[...Object.keys(i),...Ta(i)],h=[...Object.keys(e),...Ta(e)];if(c.length!==h.length)return!1;for(let l=0;l<c.length;l++){const u=c[l],d=i[u];if(!Object.hasOwn(e,u))return!1;const p=e[u];if(!ss(d,p,u,i,e,t,s))return!1}return!0}default:return!1}}finally{t.delete(i),t.delete(e)}}function bb(i,e){return wb(i,e,mb)}var vb=Object.defineProperty,Na=Object.getOwnPropertySymbols,Eb=Object.prototype.hasOwnProperty,Ib=Object.prototype.propertyIsEnumerable,vn=(i,e,t)=>e in i?vb(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ba=(i,e)=>{for(var t in e||(e={}))Eb.call(e,t)&&vn(i,t,e[t]);if(Na)for(var t of Na(e))Ib.call(e,t)&&vn(i,t,e[t]);return i},Re=(i,e,t)=>vn(i,typeof e!="symbol"?e+"":e,t);class oi extends su{constructor(e,t,s,r=yt,n=void 0){super(e,t,s,r),this.core=e,this.logger=t,this.name=s,Re(this,"map",new Map),Re(this,"version",_m),Re(this,"cached",[]),Re(this,"initialized",!1),Re(this,"getKey"),Re(this,"storagePrefix",yt),Re(this,"recentlyDeleted",[]),Re(this,"recentlyDeletedLimit",200),Re(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!ve(o)?this.map.set(this.getKey(o),o):Oy(o)?this.map.set(o.id,o):Ty(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)}),Re(this,"set",async(o,a)=>{this.isInitialized(),this.map.has(o)?await this.update(o,a):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:a}),this.map.set(o,a),await this.persist())}),Re(this,"get",o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o))),Re(this,"getAll",o=>(this.isInitialized(),o?this.values.filter(a=>Object.keys(o).every(c=>bb(a[c],o[c]))):this.values)),Re(this,"update",async(o,a)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:a});const c=Ba(Ba({},this.getData(o)),a);this.map.set(o,c),await this.persist()}),Re(this,"delete",async(o,a)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:a}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())}),this.logger=Te(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return He(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){const{message:r}=C("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}const{message:s}=C("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(s),new Error(s)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=C("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}}var xb=Object.defineProperty,_b=(i,e,t)=>e in i?xb(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,G=(i,e,t)=>_b(i,typeof e!="symbol"?e+"":e,t);class Pb{constructor(e,t){this.core=e,this.logger=t,G(this,"name",Am),G(this,"version",Om),G(this,"events",new Rn),G(this,"pairings"),G(this,"initialized",!1),G(this,"storagePrefix",yt),G(this,"ignoredPayloadTypes",[_t]),G(this,"registeredMethods",[]),G(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),G(this,"register",({methods:s})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...s])]}),G(this,"create",async s=>{this.isInitialized();const r=ln(),n=await this.core.crypto.setSymKey(r),o=de(N.FIVE_MINUTES),a={protocol:Yh},c={topic:n,expiry:o,relay:a,active:!1,methods:s==null?void 0:s.methods},h=oa({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:a,expiryTimestamp:o,methods:s==null?void 0:s.methods});return this.events.emit(Yt.create,c),this.core.expirer.set(n,o),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:s==null?void 0:s.transportType}),{topic:n,uri:h}}),G(this,"pair",async s=>{this.isInitialized();const r=this.core.eventClient.createEvent({properties:{topic:s==null?void 0:s.uri,trace:[ut.pairing_started]}});this.isValidPair(s,r);const{topic:n,symKey:o,relay:a,expiryTimestamp:c,methods:h}=na(s.uri);r.props.properties.topic=n,r.addTrace(ut.pairing_uri_validation_success),r.addTrace(ut.pairing_uri_not_expired);let l;if(this.pairings.keys.includes(n)){if(l=this.pairings.get(n),r.addTrace(ut.existing_pairing),l.active)throw r.setError(It.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(ut.pairing_not_expired)}const u=c||de(N.FIVE_MINUTES),d={topic:n,relay:a,expiry:u,active:!1,methods:h};this.core.expirer.set(n,u),await this.pairings.set(n,d),r.addTrace(ut.store_new_pairing),s.activatePairing&&await this.activate({topic:n}),this.events.emit(Yt.create,d),r.addTrace(ut.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),r.addTrace(ut.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(It.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:a})}catch(p){throw r.setError(It.subscribe_pairing_topic_failure),p}return r.addTrace(ut.subscribe_pairing_topic_success),d}),G(this,"activate",async({topic:s})=>{this.isInitialized();const r=de(N.FIVE_MINUTES);this.core.expirer.set(s,r),await this.pairings.update(s,{active:!0,expiry:r})}),G(this,"ping",async s=>{this.isInitialized(),await this.isValidPing(s),this.logger.warn("ping() is deprecated and will be removed in the next major release.");const{topic:r}=s;if(this.pairings.keys.includes(r)){const n=await this.sendRequest(r,"wc_pairingPing",{}),{done:o,resolve:a,reject:c}=Jt();this.events.once(X("pairing_ping",n),({error:h})=>{h?c(h):a()}),await o()}}),G(this,"updateExpiry",async({topic:s,expiry:r})=>{this.isInitialized(),await this.pairings.update(s,{expiry:r})}),G(this,"updateMetadata",async({topic:s,metadata:r})=>{this.isInitialized(),await this.pairings.update(s,{peerMetadata:r})}),G(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),G(this,"disconnect",async s=>{this.isInitialized(),await this.isValidDisconnect(s);const{topic:r}=s;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",ne("USER_DISCONNECTED")),await this.deletePairing(r))}),G(this,"formatUriFromPairing",s=>{this.isInitialized();const{topic:r,relay:n,expiry:o,methods:a}=s,c=this.core.crypto.keychain.get(r);return oa({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:o,methods:a})}),G(this,"sendRequest",async(s,r,n)=>{const o=Qt(r,n),a=await this.core.crypto.encode(s,o),c=Ji[r].req;return this.core.history.set(s,o),this.core.relayer.publish(s,a,c),o.id}),G(this,"sendResult",async(s,r,n)=>{const o=rr(s,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,s)).request.method,h=Ji[c].res;await this.core.relayer.publish(r,a,h),await this.core.history.resolve(o)}),G(this,"sendError",async(s,r,n)=>{const o=Un(s,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,s)).request.method,h=Ji[c]?Ji[c].res:Ji.unregistered_method.res;await this.core.relayer.publish(r,a,h),await this.core.history.resolve(o)}),G(this,"deletePairing",async(s,r)=>{await this.core.relayer.unsubscribe(s),await Promise.all([this.pairings.delete(s,ne("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(s),r?Promise.resolve():this.core.expirer.del(s)])}),G(this,"cleanup",async()=>{const s=this.pairings.getAll().filter(r=>Dt(r.expiry));await Promise.all(s.map(r=>this.deletePairing(r.topic)))}),G(this,"onRelayEventRequest",async s=>{const{topic:r,payload:n}=s;switch(n.method){case"wc_pairingPing":return await this.onPairingPingRequest(r,n);case"wc_pairingDelete":return await this.onPairingDeleteRequest(r,n);default:return await this.onUnknownRpcMethodRequest(r,n)}}),G(this,"onRelayEventResponse",async s=>{const{topic:r,payload:n}=s,o=(await this.core.history.get(r,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(o)}}),G(this,"onPairingPingRequest",async(s,r)=>{const{id:n}=r;try{this.isValidPing({topic:s}),await this.sendResult(n,s,!0),this.events.emit(Yt.ping,{id:n,topic:s})}catch(o){await this.sendError(n,s,o),this.logger.error(o)}}),G(this,"onPairingPingResponse",(s,r)=>{const{id:n}=r;setTimeout(()=>{vt(r)?this.events.emit(X("pairing_ping",n),{}):dt(r)&&this.events.emit(X("pairing_ping",n),{error:r.error})},500)}),G(this,"onPairingDeleteRequest",async(s,r)=>{const{id:n}=r;try{this.isValidDisconnect({topic:s}),await this.deletePairing(s),this.events.emit(Yt.delete,{id:n,topic:s})}catch(o){await this.sendError(n,s,o),this.logger.error(o)}}),G(this,"onUnknownRpcMethodRequest",async(s,r)=>{const{id:n,method:o}=r;try{if(this.registeredMethods.includes(o))return;const a=ne("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,s,a),this.logger.error(a)}catch(a){await this.sendError(n,s,a),this.logger.error(a)}}),G(this,"onUnknownRpcMethodResponse",s=>{this.registeredMethods.includes(s)||this.logger.error(ne("WC_METHOD_UNSUPPORTED",s))}),G(this,"isValidPair",(s,r)=>{var n;if(!Ce(s)){const{message:a}=C("MISSING_OR_INVALID",`pair() params: ${s}`);throw r.setError(It.malformed_pairing_uri),new Error(a)}if(!Ay(s.uri)){const{message:a}=C("MISSING_OR_INVALID",`pair() uri: ${s.uri}`);throw r.setError(It.malformed_pairing_uri),new Error(a)}const o=na(s==null?void 0:s.uri);if(!((n=o==null?void 0:o.relay)!=null&&n.protocol)){const{message:a}=C("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(It.malformed_pairing_uri),new Error(a)}if(!(o!=null&&o.symKey)){const{message:a}=C("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(It.malformed_pairing_uri),new Error(a)}if(o!=null&&o.expiryTimestamp&&N.toMiliseconds(o==null?void 0:o.expiryTimestamp)<Date.now()){r.setError(It.pairing_expired);const{message:a}=C("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(a)}}),G(this,"isValidPing",async s=>{if(!Ce(s)){const{message:n}=C("MISSING_OR_INVALID",`ping() params: ${s}`);throw new Error(n)}const{topic:r}=s;await this.isValidPairingTopic(r)}),G(this,"isValidDisconnect",async s=>{if(!Ce(s)){const{message:n}=C("MISSING_OR_INVALID",`disconnect() params: ${s}`);throw new Error(n)}const{topic:r}=s;await this.isValidPairingTopic(r)}),G(this,"isValidPairingTopic",async s=>{if(!le(s,!1)){const{message:r}=C("MISSING_OR_INVALID",`pairing topic should be a string: ${s}`);throw new Error(r)}if(!this.pairings.keys.includes(s)){const{message:r}=C("NO_MATCHING_KEY",`pairing topic doesn't exist: ${s}`);throw new Error(r)}if(Dt(this.pairings.get(s).expiry)){await this.deletePairing(s);const{message:r}=C("EXPIRED",`pairing topic: ${s}`);throw new Error(r)}}),this.core=e,this.logger=Te(t,this.name),this.pairings=new oi(this.core,this.logger,this.name,this.storagePrefix)}get context(){return He(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(ge.message,async e=>{const{topic:t,message:s,transportType:r}=e;if(this.pairings.keys.includes(t)&&r!==re.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(s)))try{const n=await this.core.crypto.decode(t,s);On(n)?(this.core.history.set(t,n),await this.onRelayEventRequest({topic:t,payload:n})):Tn(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id)),await this.core.relayer.messages.ack(t,s)}catch(n){this.logger.error(n)}})}registerExpirerEvents(){this.core.expirer.on(Ge.expired,async e=>{const{topic:t}=th(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Yt.expire,{topic:t}))})}}var $b=Object.defineProperty,Sb=(i,e,t)=>e in i?$b(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,be=(i,e,t)=>Sb(i,typeof e!="symbol"?e+"":e,t);class Ab extends Xl{constructor(e,t){super(e,t),this.core=e,this.logger=t,be(this,"records",new Map),be(this,"events",new Vt.EventEmitter),be(this,"name",Tm),be(this,"version",Rm),be(this,"cached",[]),be(this,"initialized",!1),be(this,"storagePrefix",yt),be(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.records.set(s.id,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),be(this,"set",(s,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:s,request:r,chainId:n}),this.records.has(r.id))return;const o={id:r.id,topic:s,request:{method:r.method,params:r.params||null},chainId:n,expiry:de(N.THIRTY_DAYS)};this.records.set(o.id,o),this.persist(),this.events.emit(et.created,o)}),be(this,"resolve",async s=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:s}),!this.records.has(s.id))return;const r=await this.getRecord(s.id);typeof r.response>"u"&&(r.response=dt(s)?{error:s.error}:{result:s.result},this.records.set(r.id,r),this.persist(),this.events.emit(et.updated,r))}),be(this,"get",async(s,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:s,id:r}),await this.getRecord(r))),be(this,"delete",(s,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===s){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(et.deleted,n)}}),this.persist()}),be(this,"exists",async(s,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===s:!1)),be(this,"on",(s,r)=>{this.events.on(s,r)}),be(this,"once",(s,r)=>{this.events.once(s,r)}),be(this,"off",(s,r)=>{this.events.off(s,r)}),be(this,"removeListener",(s,r)=>{this.events.removeListener(s,r)}),this.logger=Te(t,this.name)}get context(){return He(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const s={topic:t.topic,request:Qt(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(s)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:s}=C("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(et.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=C("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(et.created,e=>{const t=et.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(et.updated,e=>{const t=et.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(et.deleted,e=>{const t=et.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(Ci.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{N.toMiliseconds(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(et.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}}var Ob=Object.defineProperty,Tb=(i,e,t)=>e in i?Ob(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Se=(i,e,t)=>Tb(i,typeof e!="symbol"?e+"":e,t);class Rb extends nu{constructor(e,t){super(e,t),this.core=e,this.logger=t,Se(this,"expirations",new Map),Se(this,"events",new Vt.EventEmitter),Se(this,"name",Um),Se(this,"version",Cm),Se(this,"cached",[]),Se(this,"initialized",!1),Se(this,"storagePrefix",yt),Se(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.expirations.set(s.target,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),Se(this,"has",s=>{try{const r=this.formatTarget(s);return typeof this.getExpiration(r)<"u"}catch{return!1}}),Se(this,"set",(s,r)=>{this.isInitialized();const n=this.formatTarget(s),o={target:n,expiry:r};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit(Ge.created,{target:n,expiration:o})}),Se(this,"get",s=>{this.isInitialized();const r=this.formatTarget(s);return this.getExpiration(r)}),Se(this,"del",s=>{if(this.isInitialized(),this.has(s)){const r=this.formatTarget(s),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(Ge.deleted,{target:r,expiration:n})}}),Se(this,"on",(s,r)=>{this.events.on(s,r)}),Se(this,"once",(s,r)=>{this.events.once(s,r)}),Se(this,"off",(s,r)=>{this.events.off(s,r)}),Se(this,"removeListener",(s,r)=>{this.events.removeListener(s,r)}),this.logger=Te(t,this.name)}get context(){return He(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return df(e);if(typeof e=="number")return ff(e);const{message:t}=C("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(Ge.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=C("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:s}=C("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(s),new Error(s)}return t}checkExpiry(e,t){const{expiry:s}=t;N.toMiliseconds(s)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(Ge.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(Ci.pulse,()=>this.checkExpirations()),this.events.on(Ge.created,e=>{const t=Ge.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Ge.expired,e=>{const t=Ge.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Ge.deleted,e=>{const t=Ge.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}}var Ub=Object.defineProperty,Cb=(i,e,t)=>e in i?Ub(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,he=(i,e,t)=>Cb(i,typeof e!="symbol"?e+"":e,t);class Nb extends ou{constructor(e,t,s){super(e,t,s),this.core=e,this.logger=t,this.store=s,he(this,"name",Nm),he(this,"abortController"),he(this,"isDevEnv"),he(this,"verifyUrlV3",km),he(this,"storagePrefix",yt),he(this,"version",Jh),he(this,"publicKey"),he(this,"fetchPromise"),he(this,"init",async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&N.toMiliseconds((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),he(this,"register",async r=>{if(!ki()||this.isDevEnv)return;const n=window.location.origin,{id:o,decryptedId:a}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${a}`;try{const h=Oi(),l=this.startAbortTimer(N.ONE_SECOND*5),u=await new Promise((d,p)=>{const m=()=>{window.removeEventListener("message",b),h.body.removeChild(g),p("attestation aborted")};this.abortController.signal.addEventListener("abort",m);const g=h.createElement("iframe");g.src=c,g.style.display="none",g.addEventListener("error",m,{signal:this.abortController.signal});const b=T=>{if(T.data&&typeof T.data=="string")try{const $=JSON.parse(T.data);if($.type==="verify_attestation"){if(zr($.attestation).payload.id!==o)return;clearInterval(l),h.body.removeChild(g),this.abortController.signal.removeEventListener("abort",m),window.removeEventListener("message",b),d($.attestation===null?"":$.attestation)}}catch($){this.logger.warn($)}};h.body.appendChild(g),window.addEventListener("message",b,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",u),u}catch(h){this.logger.warn(h)}return""}),he(this,"resolve",async r=>{if(this.isDevEnv)return"";const{attestationId:n,hash:o,encryptedId:a}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(zr(n).payload.id!==a)return;const h=await this.isValidJwtAttestation(n);if(h){if(!h.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return h}}if(!o)return;const c=this.getVerifyUrl(r==null?void 0:r.verifyUrl);return this.fetchAttestation(o,c)}),he(this,"fetchAttestation",async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);const o=this.startAbortTimer(N.ONE_SECOND*5),a=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0}),he(this,"getVerifyUrl",r=>{let n=r||ls;return Dm.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${ls}`),n=ls),n}),he(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);const r=this.startAbortTimer(N.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}}),he(this,"persistPublicKey",async r=>{this.logger.debug("persisting public key to local storage",r),await this.store.setItem(this.storeKey,r),this.publicKey=r}),he(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),he(this,"isValidJwtAttestation",async r=>{const n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}const o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(r,o)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),he(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),he(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{const o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});const r=await this.fetchPromise;return this.fetchPromise=void 0,r}),he(this,"validateAttestation",(r,n)=>{const o=ay(r,n.publicKey),a={hasExpired:N.toMiliseconds(o.exp)<Date.now(),payload:o};if(a.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:a.payload.origin,isScam:a.payload.isScam,isVerified:a.payload.isVerified}}),this.logger=Te(t,this.name),this.abortController=new AbortController,this.isDevEnv=Mn(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return He(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),N.toMiliseconds(e))}}var Bb=Object.defineProperty,kb=(i,e,t)=>e in i?Bb(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ka=(i,e,t)=>kb(i,typeof e!="symbol"?e+"":e,t);class Db extends au{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,ka(this,"context",qm),ka(this,"registerDeviceToken",async s=>{const{clientId:r,token:n,notificationType:o,enableEncrypted:a=!1}=s,c=`${jm}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:o,token:n,always_raw:a})})}),this.logger=Te(t,this.context)}}var qb=Object.defineProperty,Da=Object.getOwnPropertySymbols,jb=Object.prototype.hasOwnProperty,Lb=Object.prototype.propertyIsEnumerable,En=(i,e,t)=>e in i?qb(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Qi=(i,e)=>{for(var t in e||(e={}))jb.call(e,t)&&En(i,t,e[t]);if(Da)for(var t of Da(e))Lb.call(e,t)&&En(i,t,e[t]);return i},fe=(i,e,t)=>En(i,typeof e!="symbol"?e+"":e,t);class Mb extends cu{constructor(e,t,s=!0){super(e,t,s),this.core=e,this.logger=t,fe(this,"context",Mm),fe(this,"storagePrefix",yt),fe(this,"storageVersion",Lm),fe(this,"events",new Map),fe(this,"shouldPersist",!1),fe(this,"init",async()=>{if(!Mn())try{const r={eventId:So(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:Xc(this.core.relayer.protocol,this.core.relayer.version,fn)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}}),fe(this,"createEvent",r=>{const{event:n="ERROR",type:o="",properties:{topic:a,trace:c}}=r,h=So(),l=this.core.projectId||"",u=Date.now(),d=Qi({eventId:h,timestamp:u,props:{event:n,type:o,properties:{topic:a,trace:c}},bundleId:l,domain:this.getAppDomain()},this.setMethods(h));return this.telemetryEnabled&&(this.events.set(h,d),this.shouldPersist=!0),d}),fe(this,"getEvent",r=>{const{eventId:n,topic:o}=r;if(n)return this.events.get(n);const a=Array.from(this.events.values()).find(c=>c.props.properties.topic===o);if(a)return Qi(Qi({},a),this.setMethods(a.eventId))}),fe(this,"deleteEvent",r=>{const{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0}),fe(this,"setEventListeners",()=>{this.core.heartbeat.on(Ci.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{N.fromMiliseconds(Date.now())-N.fromMiliseconds(r.timestamp)>zm&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})}),fe(this,"setMethods",r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)})),fe(this,"addTrace",(r,n)=>{const o=this.events.get(r);o&&(o.props.properties.trace.push(n),this.events.set(r,o),this.shouldPersist=!0)}),fe(this,"setError",(r,n)=>{const o=this.events.get(r);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(r,o),this.shouldPersist=!0)}),fe(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),fe(this,"restore",async()=>{try{const r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,Qi(Qi({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}}),fe(this,"submit",async()=>{if(!this.telemetryEnabled||this.events.size===0)return;const r=[];for(const[n,o]of this.events)o.props.type&&r.push(o);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(const n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}}),fe(this,"sendEvent",async r=>{const n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${Hm}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${fn}${n}`,{method:"POST",body:JSON.stringify(r)})}),fe(this,"getAppDomain",()=>Qc().url),this.logger=Te(t,this.context),this.telemetryEnabled=s,s?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}}var zb=Object.defineProperty,qa=Object.getOwnPropertySymbols,Hb=Object.prototype.hasOwnProperty,Fb=Object.prototype.propertyIsEnumerable,In=(i,e,t)=>e in i?zb(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ja=(i,e)=>{for(var t in e||(e={}))Hb.call(e,t)&&In(i,t,e[t]);if(qa)for(var t of qa(e))Fb.call(e,t)&&In(i,t,e[t]);return i},ie=(i,e,t)=>In(i,typeof e!="symbol"?e+"":e,t);let Vb=class ll extends Jl{constructor(e){var t;super(e),ie(this,"protocol",Wh),ie(this,"version",Jh),ie(this,"name",dn),ie(this,"relayUrl"),ie(this,"projectId"),ie(this,"customStoragePrefix"),ie(this,"events",new Vt.EventEmitter),ie(this,"logger"),ie(this,"heartbeat"),ie(this,"relayer"),ie(this,"crypto"),ie(this,"storage"),ie(this,"history"),ie(this,"expirer"),ie(this,"pairing"),ie(this,"verify"),ie(this,"echoClient"),ie(this,"linkModeSupportedApps"),ie(this,"eventClient"),ie(this,"initialized",!1),ie(this,"logChunkController"),ie(this,"on",(a,c)=>this.events.on(a,c)),ie(this,"once",(a,c)=>this.events.once(a,c)),ie(this,"off",(a,c)=>this.events.off(a,c)),ie(this,"removeListener",(a,c)=>this.events.removeListener(a,c)),ie(this,"dispatchEnvelope",({topic:a,message:c,sessionExists:h})=>{if(!a||!c)return;const l={topic:a,message:c,publishedAt:Date.now(),transportType:re.link_mode};this.relayer.onLinkMessageEvent(l,{sessionExists:h})});const s=this.getGlobalCore(e==null?void 0:e.customStoragePrefix);if(s)try{return this.customStoragePrefix=s.customStoragePrefix,this.logger=s.logger,this.heartbeat=s.heartbeat,this.crypto=s.crypto,this.history=s.history,this.expirer=s.expirer,this.storage=s.storage,this.relayer=s.relayer,this.pairing=s.pairing,this.verify=s.verify,this.echoClient=s.echoClient,this.linkModeSupportedApps=s.linkModeSupportedApps,this.eventClient=s.eventClient,this.initialized=s.initialized,this.logChunkController=s.logChunkController,s}catch(a){console.warn("Failed to copy global core",a)}this.projectId=e==null?void 0:e.projectId,this.relayUrl=(e==null?void 0:e.relayUrl)||Zh,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";const r=sr({level:typeof(e==null?void 0:e.logger)=="string"&&e.logger?e.logger:um.logger,name:dn}),{logger:n,chunkLoggerController:o}=Rl({opts:r,maxSizeInBytes:e==null?void 0:e.maxLogBlobSizeInBytes,loggerOverride:e==null?void 0:e.logger});this.logChunkController=o,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,c;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((c=this.logChunkController)==null||c.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=Te(n,this.name),this.heartbeat=new Ul,this.crypto=new w0(this,this.logger,e==null?void 0:e.keychain),this.history=new Ab(this,this.logger),this.expirer=new Rb(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new Cl(ja(ja({},dm),e==null?void 0:e.storageOptions)),this.relayer=new V0({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new Pb(this,this.logger),this.verify=new Nb(this,this.logger,this.storage),this.echoClient=new Db(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new Mb(this,this.logger,e==null?void 0:e.telemetryEnabled),this.setGlobalCore(this)}static async init(e){const t=new ll(e);await t.initialize();const s=await t.crypto.getClientId();return await t.storage.setItem(Pm,s),t}get context(){return He(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(wa,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(wa)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}getGlobalCore(e=""){try{if(this.isGlobalCoreDisabled())return;const t=`_walletConnectCore_${e}`,s=`${t}_count`;return globalThis[s]=(globalThis[s]||0)+1,globalThis[s]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[s]} times.`),globalThis[t]}catch(t){console.warn("Failed to get global WalletConnect core",t);return}}setGlobalCore(e){var t;try{if(this.isGlobalCoreDisabled())return;const s=`_walletConnectCore_${((t=e.opts)==null?void 0:t.customStoragePrefix)||""}`;globalThis[s]=e}catch(s){console.warn("Failed to set global WalletConnect core",s)}}isGlobalCoreDisabled(){try{return typeof process<"u"&&lm.DISABLE_GLOBAL_CORE==="true"}catch{return!0}}};const Kb=Vb,ul="wc",dl=2,fl="client",to=`${ul}@${dl}:${fl}:`,Br={name:fl,logger:"error"},La="WALLETCONNECT_DEEPLINK_CHOICE",Gb="proposal",Ma="Proposal expired",Wb="session",di=N.SEVEN_DAYS,Jb="engine",pe={wc_sessionPropose:{req:{ttl:N.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:N.ONE_DAY,prompt:!1,tag:1104},res:{ttl:N.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:N.ONE_DAY,prompt:!1,tag:1106},res:{ttl:N.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:N.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:N.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:N.ONE_DAY,prompt:!1,tag:1112},res:{ttl:N.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:N.ONE_DAY,prompt:!1,tag:1114},res:{ttl:N.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:N.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:N.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:N.FIVE_MINUTES,prompt:!1,tag:1119}}},kr={min:N.FIVE_MINUTES,max:N.SEVEN_DAYS},lt={idle:"IDLE",active:"ACTIVE"},Yb={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"},sui_signAndExecuteTransaction:{key:"digest"},sui_signTransaction:{key:""},hedera_signAndExecuteTransaction:{key:"transactionId"},hedera_executeTransaction:{key:"transactionId"},near_signTransaction:{key:""},near_signTransactions:{key:""},tron_signTransaction:{key:"txID"},xrpl_signTransaction:{key:""},xrpl_signTransactionFor:{key:""},algo_signTxn:{key:""},sendTransfer:{key:"txid"},stacks_stxTransfer:{key:"txId"},polkadot_signTransaction:{key:""},cosmos_signDirect:{key:""}},Zb="request",Qb=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],Xb="wc",e1="auth",t1="authKeys",i1="pairingTopics",s1="requests",pr=`${Xb}@${1.5}:${e1}:`,Vs=`${pr}:PUB_KEY`;var r1=Object.defineProperty,n1=Object.defineProperties,o1=Object.getOwnPropertyDescriptors,za=Object.getOwnPropertySymbols,a1=Object.prototype.hasOwnProperty,c1=Object.prototype.propertyIsEnumerable,xn=(i,e,t)=>e in i?r1(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,se=(i,e)=>{for(var t in e||(e={}))a1.call(e,t)&&xn(i,t,e[t]);if(za)for(var t of za(e))c1.call(e,t)&&xn(i,t,e[t]);return i},Ue=(i,e)=>n1(i,o1(e)),O=(i,e,t)=>xn(i,typeof e!="symbol"?e+"":e,t);class h1 extends du{constructor(e){super(e),O(this,"name",Jb),O(this,"events",new Rn),O(this,"initialized",!1),O(this,"requestQueue",{state:lt.idle,queue:[]}),O(this,"sessionRequestQueue",{state:lt.idle,queue:[]}),O(this,"emittedSessionRequests",new If({limit:500})),O(this,"requestQueueDelay",N.ONE_SECOND),O(this,"expectedPairingMethodMap",new Map),O(this,"recentlyDeletedMap",new Map),O(this,"recentlyDeletedLimit",200),O(this,"relayMessageCache",[]),O(this,"pendingSessions",new Map),O(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(pe)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},N.toMiliseconds(this.requestQueueDelay)))}),O(this,"connect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();const s=Ue(se({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(s),s.optionalNamespaces=xy(s.requiredNamespaces,s.optionalNamespaces),s.requiredNamespaces={};const{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:o,sessionProperties:a,scopedProperties:c,relays:h}=s;let l=r,u,d=!1;try{if(l){const j=this.client.core.pairing.pairings.get(l);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),d=j.active}}catch(j){throw this.client.logger.error(`connect() -> pairing.get(${l}) failed`),j}if(!l||!d){const{topic:j,uri:L}=await this.client.core.pairing.create();l=j,u=L}if(!l){const{message:j}=C("NO_MATCHING_KEY",`connect() pairing topic: ${l}`);throw new Error(j)}const p=await this.client.core.crypto.generateKeyPair(),m=pe.wc_sessionPropose.req.ttl||N.FIVE_MINUTES,g=de(m),b=Ue(se(se({requiredNamespaces:n,optionalNamespaces:o,relays:h??[{protocol:Yh}],proposer:{publicKey:p,metadata:this.client.metadata},expiryTimestamp:g,pairingTopic:l},a&&{sessionProperties:a}),c&&{scopedProperties:c}),{id:St()}),T=X("session_connect",b.id),{reject:$,resolve:D,done:M}=Jt(m,Ma),R=({id:j})=>{j===b.id&&(this.client.events.off("proposal_expire",R),this.pendingSessions.delete(b.id),this.events.emit(T,{error:{message:Ma,code:0}}))};return this.client.events.on("proposal_expire",R),this.events.once(T,({error:j,session:L})=>{this.client.events.off("proposal_expire",R),j?$(j):L&&D(L)}),await this.sendRequest({topic:l,method:"wc_sessionPropose",params:b,throwOnFailedPublish:!0,clientRpcId:b.id}),await this.setProposal(b.id,b),{uri:u,approval:M}}),O(this,"pair",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(t)}catch(s){throw this.client.logger.error("pair() failed"),s}}),O(this,"approve",async t=>{var s,r,n;const o=this.client.core.eventClient.createEvent({properties:{topic:(s=t==null?void 0:t.id)==null?void 0:s.toString(),trace:[tt.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(y){throw o.setError(Gt.no_internet_connection),y}try{await this.isValidProposalId(t==null?void 0:t.id)}catch(y){throw this.client.logger.error(`approve() -> proposal.get(${t==null?void 0:t.id}) failed`),o.setError(Gt.proposal_not_found),y}try{await this.isValidApprove(t)}catch(y){throw this.client.logger.error("approve() -> isValidApprove() failed"),o.setError(Gt.session_approve_namespace_validation_failure),y}const{id:a,relayProtocol:c,namespaces:h,sessionProperties:l,scopedProperties:u,sessionConfig:d}=t,p=this.client.proposal.get(a);this.client.core.eventClient.deleteEvent({eventId:o.eventId});const{pairingTopic:m,proposer:g,requiredNamespaces:b,optionalNamespaces:T}=p;let $=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:m});$||($=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:tt.session_approve_started,properties:{topic:m,trace:[tt.session_approve_started,tt.session_namespaces_validation_success]}}));const D=await this.client.core.crypto.generateKeyPair(),M=g.publicKey,R=await this.client.core.crypto.generateSharedKey(D,M),j=se(se(se({relay:{protocol:c??"irn"},namespaces:h,controller:{publicKey:D,metadata:this.client.metadata},expiry:de(di)},l&&{sessionProperties:l}),u&&{scopedProperties:u}),d&&{sessionConfig:d}),L=re.relay;$.addTrace(tt.subscribing_session_topic);try{await this.client.core.relayer.subscribe(R,{transportType:L})}catch(y){throw $.setError(Gt.subscribe_session_topic_failure),y}$.addTrace(tt.subscribe_session_topic_success);const q=Ue(se({},j),{topic:R,requiredNamespaces:b,optionalNamespaces:T,pairingTopic:m,acknowledged:!1,self:j.controller,peer:{publicKey:g.publicKey,metadata:g.metadata},controller:D,transportType:re.relay});await this.client.session.set(R,q),$.addTrace(tt.store_session);try{$.addTrace(tt.publishing_session_settle),await this.sendRequest({topic:R,method:"wc_sessionSettle",params:j,throwOnFailedPublish:!0}).catch(y=>{throw $==null||$.setError(Gt.session_settle_publish_failure),y}),$.addTrace(tt.session_settle_publish_success),$.addTrace(tt.publishing_session_approve),await this.sendResult({id:a,topic:m,result:{relay:{protocol:c??"irn"},responderPublicKey:D},throwOnFailedPublish:!0}).catch(y=>{throw $==null||$.setError(Gt.session_approve_publish_failure),y}),$.addTrace(tt.session_approve_publish_success)}catch(y){throw this.client.logger.error(y),this.client.session.delete(R,ne("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(R),y}return this.client.core.eventClient.deleteEvent({eventId:$.eventId}),await this.client.core.pairing.updateMetadata({topic:m,metadata:g.metadata}),await this.deleteProposal(a),await this.client.core.pairing.activate({topic:m}),await this.setExpiry(R,de(di)),{topic:R,acknowledged:()=>Promise.resolve(this.client.session.get(R))}}),O(this,"reject",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(t)}catch(o){throw this.client.logger.error("reject() -> isValidReject() failed"),o}const{id:s,reason:r}=t;let n;try{n=this.client.proposal.get(s).pairingTopic}catch(o){throw this.client.logger.error(`reject() -> proposal.get(${s}) failed`),o}n&&await this.sendError({id:s,topic:n,error:r,rpcOpts:pe.wc_sessionPropose.reject}),await this.deleteProposal(s)}),O(this,"update",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(t)}catch(u){throw this.client.logger.error("update() -> isValidUpdate() failed"),u}const{topic:s,namespaces:r}=t,{done:n,resolve:o,reject:a}=Jt(),c=St(),h=Pi().toString(),l=this.client.session.get(s).namespaces;return this.events.once(X("session_update",c),({error:u})=>{u?a(u):o()}),await this.client.session.update(s,{namespaces:r}),await this.sendRequest({topic:s,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:h}).catch(u=>{this.client.logger.error(u),this.client.session.update(s,{namespaces:l}),a(u)}),{acknowledged:n}}),O(this,"extend",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(t)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}const{topic:s}=t,r=St(),{done:n,resolve:o,reject:a}=Jt();return this.events.once(X("session_extend",r),({error:c})=>{c?a(c):o()}),await this.setExpiry(s,de(di)),this.sendRequest({topic:s,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{a(c)}),{acknowledged:n}}),O(this,"request",async t=>{this.isInitialized();try{await this.isValidRequest(t)}catch(b){throw this.client.logger.error("request() -> isValidRequest() failed"),b}const{chainId:s,request:r,topic:n,expiry:o=pe.wc_sessionRequest.req.ttl}=t,a=this.client.session.get(n);(a==null?void 0:a.transportType)===re.relay&&await this.confirmOnlineStateOrThrow();const c=St(),h=Pi().toString(),{done:l,resolve:u,reject:d}=Jt(o,"Request expired. Please try again.");this.events.once(X("session_request",c),({error:b,result:T})=>{b?d(b):u(T)});const p="wc_sessionRequest",m=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);if(m)return await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:p,params:{request:Ue(se({},r),{expiryTimestamp:de(o)}),chainId:s},expiry:o,throwOnFailedPublish:!0,appLink:m}).catch(b=>d(b)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:s,id:c}),await l();const g={request:Ue(se({},r),{expiryTimestamp:de(o)}),chainId:s};return await Promise.all([new Promise(async b=>{await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:p,params:g,expiry:o,throwOnFailedPublish:!0,tvf:this.getTVFParams(c,g)}).catch(T=>d(T)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:s,id:c}),b()}),new Promise(async b=>{var T;if(!((T=a.sessionConfig)!=null&&T.disableDeepLink)){const $=await mf(this.client.core.storage,La);await pf({id:c,topic:n,wcDeepLink:$})}b()}),l()]).then(b=>b[2])}),O(this,"respond",async t=>{this.isInitialized(),await this.isValidRespond(t);const{topic:s,response:r}=t,{id:n}=r,o=this.client.session.get(s);o.transportType===re.relay&&await this.confirmOnlineStateOrThrow();const a=this.getAppLinkIfEnabled(o.peer.metadata,o.transportType);vt(r)?await this.sendResult({id:n,topic:s,result:r.result,throwOnFailedPublish:!0,appLink:a}):dt(r)&&await this.sendError({id:n,topic:s,error:r.error,appLink:a}),this.cleanupAfterResponse(t)}),O(this,"ping",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(t)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}const{topic:s}=t;if(this.client.session.keys.includes(s)){const r=St(),n=Pi().toString(),{done:o,resolve:a,reject:c}=Jt();this.events.once(X("session_ping",r),({error:h})=>{h?c(h):a()}),await Promise.all([this.sendRequest({topic:s,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),o()])}else this.client.core.pairing.pairings.keys.includes(s)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:s}))}),O(this,"emit",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(t);const{topic:s,event:r,chainId:n}=t,o=Pi().toString(),a=St();await this.sendRequest({topic:s,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:o,clientRpcId:a})}),O(this,"disconnect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(t);const{topic:s}=t;if(this.client.session.keys.includes(s))await this.sendRequest({topic:s,method:"wc_sessionDelete",params:ne("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:s,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(s))await this.client.core.pairing.disconnect({topic:s});else{const{message:r}=C("MISMATCHED_TOPIC",`Session or pairing topic not found: ${s}`);throw new Error(r)}}),O(this,"find",t=>(this.isInitialized(),this.client.session.getAll().filter(s=>$y(s,t)))),O(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),O(this,"authenticate",async(t,s)=>{var r;this.isInitialized(),this.isValidAuthenticate(t);const n=s&&this.client.core.linkModeSupportedApps.includes(s)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),o=n?re.link_mode:re.relay;o===re.relay&&await this.confirmOnlineStateOrThrow();const{chains:a,statement:c="",uri:h,domain:l,nonce:u,type:d,exp:p,nbf:m,methods:g=[],expiry:b}=t,T=[...t.resources||[]],{topic:$,uri:D}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:o});this.client.logger.info({message:"Generated new pairing",pairing:{topic:$,uri:D}});const M=await this.client.core.crypto.generateKeyPair(),R=Hs(M);if(await Promise.all([this.client.auth.authKeys.set(Vs,{responseTopic:R,publicKey:M}),this.client.auth.pairingTopics.set(R,{topic:R,pairingTopic:$})]),await this.client.core.relayer.subscribe(R,{transportType:o}),this.client.logger.info(`sending request to new pairing topic: ${$}`),g.length>0){const{namespace:x}=Ai(a[0]);let A=Cp(x,"request",g);zs(T)&&(A=Bp(A,T.pop())),T.push(A)}const j=b&&b>pe.wc_sessionAuthenticate.req.ttl?b:pe.wc_sessionAuthenticate.req.ttl,L={authPayload:{type:d??"caip122",chains:a,statement:c,aud:h,domain:l,version:"1",nonce:u,iat:new Date().toISOString(),exp:p,nbf:m,resources:T},requester:{publicKey:M,metadata:this.client.metadata},expiryTimestamp:de(j)},q={eip155:{chains:a,methods:[...new Set(["personal_sign",...g])],events:["chainChanged","accountsChanged"]}},y={requiredNamespaces:{},optionalNamespaces:q,relays:[{protocol:"irn"}],pairingTopic:$,proposer:{publicKey:M,metadata:this.client.metadata},expiryTimestamp:de(pe.wc_sessionPropose.req.ttl),id:St()},{done:_,resolve:E,reject:v}=Jt(j,"Request expired"),P=St(),U=X("session_connect",y.id),f=X("session_request",P),w=async({error:x,session:A})=>{this.events.off(f,I),x?v(x):A&&E({session:A})},I=async x=>{var A,k,H;if(await this.deletePendingAuthRequest(P,{message:"fulfilled",code:0}),x.error){const oe=ne("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return x.error.code===oe.code?void 0:(this.events.off(U,w),v(x.error.message))}await this.deleteProposal(y.id),this.events.off(U,w);const{cacaos:K,responder:z}=x.result,F=[],ee=[];for(const oe of K){await qo({cacao:oe,projectId:this.client.core.projectId})||(this.client.logger.error(oe,"Signature verification failed"),v(ne("SESSION_SETTLEMENT_FAILED","Signature verification failed")));const{p:Fe}=oe,mt=zs(Fe.resources),ro=[en(Fe.iss)],_l=Qs(Fe.iss);if(mt){const yr=jo(mt),Pl=Lo(mt);F.push(...yr),ro.push(...Pl)}for(const yr of ro)ee.push(`${yr}:${_l}`)}const ce=await this.client.core.crypto.generateSharedKey(M,z.publicKey);let ae;F.length>0&&(ae={topic:ce,acknowledged:!0,self:{publicKey:M,metadata:this.client.metadata},peer:z,controller:z.publicKey,expiry:de(di),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:$,namespaces:la([...new Set(F)],[...new Set(ee)]),transportType:o},await this.client.core.relayer.subscribe(ce,{transportType:o}),await this.client.session.set(ce,ae),$&&await this.client.core.pairing.updateMetadata({topic:$,metadata:z.metadata}),ae=this.client.session.get(ce)),(A=this.client.metadata.redirect)!=null&&A.linkMode&&(k=z.metadata.redirect)!=null&&k.linkMode&&(H=z.metadata.redirect)!=null&&H.universal&&s&&(this.client.core.addLinkModeSupportedApp(z.metadata.redirect.universal),this.client.session.update(ce,{transportType:re.link_mode})),E({auths:K,session:ae})};this.events.once(U,w),this.events.once(f,I);let S;try{if(n){const x=Qt("wc_sessionAuthenticate",L,P);this.client.core.history.set($,x);const A=await this.client.core.crypto.encode("",x,{type:Is,encoding:Mt});S=Bs(s,$,A)}else await Promise.all([this.sendRequest({topic:$,method:"wc_sessionAuthenticate",params:L,expiry:t.expiry,throwOnFailedPublish:!0,clientRpcId:P}),this.sendRequest({topic:$,method:"wc_sessionPropose",params:y,expiry:pe.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:y.id})])}catch(x){throw this.events.off(U,w),this.events.off(f,I),x}return await this.setProposal(y.id,y),await this.setAuthRequest(P,{request:Ue(se({},L),{verifyContext:{}}),pairingTopic:$,transportType:o}),{uri:S??D,response:_}}),O(this,"approveSessionAuthenticate",async t=>{const{id:s,auths:r}=t,n=this.client.core.eventClient.createEvent({properties:{topic:s.toString(),trace:[Wt.authenticated_session_approve_started]}});try{this.isInitialized()}catch(b){throw n.setError(Yi.no_internet_connection),b}const o=this.getPendingAuthRequest(s);if(!o)throw n.setError(Yi.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${s}`);const a=o.transportType||re.relay;a===re.relay&&await this.confirmOnlineStateOrThrow();const c=o.requester.publicKey,h=await this.client.core.crypto.generateKeyPair(),l=Hs(c),u={type:_t,receiverPublicKey:c,senderPublicKey:h},d=[],p=[];for(const b of r){if(!await qo({cacao:b,projectId:this.client.core.projectId})){n.setError(Yi.invalid_cacao);const R=ne("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:s,topic:l,error:R,encodeOpts:u}),new Error(R.message)}n.addTrace(Wt.cacaos_verified);const{p:T}=b,$=zs(T.resources),D=[en(T.iss)],M=Qs(T.iss);if($){const R=jo($),j=Lo($);d.push(...R),D.push(...j)}for(const R of D)p.push(`${R}:${M}`)}const m=await this.client.core.crypto.generateSharedKey(h,c);n.addTrace(Wt.create_authenticated_session_topic);let g;if((d==null?void 0:d.length)>0){g={topic:m,acknowledged:!0,self:{publicKey:h,metadata:this.client.metadata},peer:{publicKey:c,metadata:o.requester.metadata},controller:c,expiry:de(di),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:o.pairingTopic,namespaces:la([...new Set(d)],[...new Set(p)]),transportType:a},n.addTrace(Wt.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(m,{transportType:a})}catch(b){throw n.setError(Yi.subscribe_authenticated_session_topic_failure),b}n.addTrace(Wt.subscribe_authenticated_session_topic_success),await this.client.session.set(m,g),n.addTrace(Wt.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:o.pairingTopic,metadata:o.requester.metadata})}n.addTrace(Wt.publishing_authenticated_session_approve);try{await this.sendResult({topic:l,id:s,result:{cacaos:r,responder:{publicKey:h,metadata:this.client.metadata}},encodeOpts:u,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(o.requester.metadata,a)})}catch(b){throw n.setError(Yi.authenticated_session_approve_publish_failure),b}return await this.client.auth.requests.delete(s,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:o.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:g}}),O(this,"rejectSessionAuthenticate",async t=>{this.isInitialized();const{id:s,reason:r}=t,n=this.getPendingAuthRequest(s);if(!n)throw new Error(`Could not find pending auth request with id ${s}`);n.transportType===re.relay&&await this.confirmOnlineStateOrThrow();const o=n.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),c=Hs(o),h={type:_t,receiverPublicKey:o,senderPublicKey:a};await this.sendError({id:s,topic:c,error:r,encodeOpts:h,rpcOpts:pe.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(s,{message:"rejected",code:0}),await this.deleteProposal(s)}),O(this,"formatAuthMessage",t=>{this.isInitialized();const{request:s,iss:r}=t;return yh(s,r)}),O(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{const t=this.relayMessageCache.shift();t&&await this.onRelayMessage(t)}catch(t){this.client.logger.error(t)}},50)}),O(this,"cleanupDuplicatePairings",async t=>{if(t.pairingTopic)try{const s=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var o,a;return((o=n.peerMetadata)==null?void 0:o.url)&&((a=n.peerMetadata)==null?void 0:a.url)===t.peer.metadata.url&&n.topic&&n.topic!==s.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(s){this.client.logger.error(s)}}),O(this,"deleteSession",async t=>{var s;const{topic:r,expirerHasDeleted:n=!1,emitEvent:o=!0,id:a=0}=t,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,ne("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem(La).catch(h=>this.client.logger.warn(h)),this.getPendingSessionRequests().forEach(h=>{h.topic===r&&this.deletePendingSessionRequest(h.id,ne("USER_DISCONNECTED"))}),r===((s=this.sessionRequestQueue.queue[0])==null?void 0:s.topic)&&(this.sessionRequestQueue.state=lt.idle),o&&this.client.events.emit("session_delete",{id:a,topic:r})}),O(this,"deleteProposal",async(t,s)=>{if(s)try{const r=this.client.proposal.get(t),n=this.client.core.eventClient.getEvent({topic:r.pairingTopic});n==null||n.setError(Gt.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(t,ne("USER_DISCONNECTED")),s?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"proposal")}),O(this,"deletePendingSessionRequest",async(t,s,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,s),r?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==t),r&&(this.sessionRequestQueue.state=lt.idle,this.client.events.emit("session_request_expire",{id:t}))}),O(this,"deletePendingAuthRequest",async(t,s,r=!1)=>{await Promise.all([this.client.auth.requests.delete(t,s),r?Promise.resolve():this.client.core.expirer.del(t)])}),O(this,"setExpiry",async(t,s)=>{this.client.session.keys.includes(t)&&(this.client.core.expirer.set(t,s),await this.client.session.update(t,{expiry:s}))}),O(this,"setProposal",async(t,s)=>{this.client.core.expirer.set(t,de(pe.wc_sessionPropose.req.ttl)),await this.client.proposal.set(t,s)}),O(this,"setAuthRequest",async(t,s)=>{const{request:r,pairingTopic:n,transportType:o=re.relay}=s;this.client.core.expirer.set(t,r.expiryTimestamp),await this.client.auth.requests.set(t,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:t,pairingTopic:n,verifyContext:r.verifyContext,transportType:o})}),O(this,"setPendingSessionRequest",async t=>{const{id:s,topic:r,params:n,verifyContext:o}=t,a=n.request.expiryTimestamp||de(pe.wc_sessionRequest.req.ttl);this.client.core.expirer.set(s,a),await this.client.pendingRequest.set(s,{id:s,topic:r,params:n,verifyContext:o})}),O(this,"sendRequest",async t=>{const{topic:s,method:r,params:n,expiry:o,relayRpcId:a,clientRpcId:c,throwOnFailedPublish:h,appLink:l,tvf:u}=t,d=Qt(r,n,c);let p;const m=!!l;try{const T=m?Mt:nt;p=await this.client.core.crypto.encode(s,d,{encoding:T})}catch(T){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${s} failed`),T}let g;if(Qb.includes(r)){const T=ft(JSON.stringify(d)),$=ft(p);g=await this.client.core.verify.register({id:$,decryptedId:T})}const b=pe[r].req;if(b.attestation=g,o&&(b.ttl=o),a&&(b.id=a),this.client.core.history.set(s,d),m){const T=Bs(l,s,p);await global.Linking.openURL(T,this.client.name)}else{const T=pe[r].req;o&&(T.ttl=o),a&&(T.id=a),T.tvf=Ue(se({},u),{correlationId:d.id}),h?(T.internal=Ue(se({},T.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(s,p,T)):this.client.core.relayer.publish(s,p,T).catch($=>this.client.logger.error($))}return d.id}),O(this,"sendResult",async t=>{const{id:s,topic:r,result:n,throwOnFailedPublish:o,encodeOpts:a,appLink:c}=t,h=rr(s,n);let l;const u=c&&typeof(global==null?void 0:global.Linking)<"u";try{const m=u?Mt:nt;l=await this.client.core.crypto.encode(r,h,Ue(se({},a||{}),{encoding:m}))}catch(m){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),m}let d,p;try{d=await this.client.core.history.get(r,s);const m=d.request;try{p=this.getTVFParams(s,m.params,n)}catch(g){this.client.logger.warn(`sendResult() -> getTVFParams() failed: ${g==null?void 0:g.message}`)}}catch(m){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${s}) failed`),m}if(u){const m=Bs(c,r,l);await global.Linking.openURL(m,this.client.name)}else{const m=d.request.method,g=pe[m].res;g.tvf=Ue(se({},p),{correlationId:s}),o?(g.internal=Ue(se({},g.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,l,g)):this.client.core.relayer.publish(r,l,g).catch(b=>this.client.logger.error(b))}await this.client.core.history.resolve(h)}),O(this,"sendError",async t=>{const{id:s,topic:r,error:n,encodeOpts:o,rpcOpts:a,appLink:c}=t,h=Un(s,n);let l;const u=c&&typeof(global==null?void 0:global.Linking)<"u";try{const p=u?Mt:nt;l=await this.client.core.crypto.encode(r,h,Ue(se({},o||{}),{encoding:p}))}catch(p){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),p}let d;try{d=await this.client.core.history.get(r,s)}catch(p){throw this.client.logger.error(`sendError() -> history.get(${r}, ${s}) failed`),p}if(u){const p=Bs(c,r,l);await global.Linking.openURL(p,this.client.name)}else{const p=d.request.method,m=a||pe[p].res;this.client.core.relayer.publish(r,l,m)}await this.client.core.history.resolve(h)}),O(this,"cleanup",async()=>{const t=[],s=[];this.client.session.getAll().forEach(r=>{let n=!1;Dt(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{Dt(r.expiryTimestamp)&&s.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession({topic:r})),...s.map(r=>this.deleteProposal(r))])}),O(this,"onProviderMessageEvent",async t=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(t):await this.onRelayMessage(t)}),O(this,"onRelayEventRequest",async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()}),O(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===lt.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=lt.active;const t=this.requestQueue.queue.shift();if(t)try{await this.processRequest(t)}catch(s){this.client.logger.warn(s)}}this.requestQueue.state=lt.idle}),O(this,"processRequest",async t=>{const{topic:s,payload:r,attestation:n,transportType:o,encryptedId:a}=t,c=r.method;if(!this.shouldIgnorePairingRequest({topic:s,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:s,payload:r,attestation:n,encryptedId:a});case"wc_sessionSettle":return await this.onSessionSettleRequest(s,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(s,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(s,r);case"wc_sessionPing":return await this.onSessionPingRequest(s,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(s,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:s,payload:r,attestation:n,encryptedId:a,transportType:o});case"wc_sessionEvent":return await this.onSessionEventRequest(s,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:s,payload:r,attestation:n,encryptedId:a,transportType:o});default:return this.client.logger.info(`Unsupported request method ${c}`)}}),O(this,"onRelayEventResponse",async t=>{const{topic:s,payload:r,transportType:n}=t,o=(await this.client.core.history.get(s,r.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(s,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(s,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(s,r);case"wc_sessionExtend":return this.onSessionExtendResponse(s,r);case"wc_sessionPing":return this.onSessionPingResponse(s,r);case"wc_sessionRequest":return this.onSessionRequestResponse(s,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(s,r);default:return this.client.logger.info(`Unsupported response method ${o}`)}}),O(this,"onRelayEventUnknownPayload",t=>{const{topic:s}=t,{message:r}=C("MISSING_OR_INVALID",`Decoded payload on topic ${s} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)}),O(this,"shouldIgnorePairingRequest",t=>{const{topic:s,requestMethod:r}=t,n=this.expectedPairingMethodMap.get(s);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),O(this,"onSessionProposeRequest",async t=>{const{topic:s,payload:r,attestation:n,encryptedId:o}=t,{params:a,id:c}=r;try{const h=this.client.core.eventClient.getEvent({topic:s});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),h==null||h.setError(It.proposal_listener_not_found)),this.isValidConnect(se({},r.params));const l=a.expiryTimestamp||de(pe.wc_sessionPropose.req.ttl),u=se({id:c,pairingTopic:s,expiryTimestamp:l,attestation:n,encryptedId:o},a);await this.setProposal(c,u);const d=await this.getVerifyContext({attestationId:n,hash:ft(JSON.stringify(r)),encryptedId:o,metadata:u.proposer.metadata});h==null||h.addTrace(ut.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:u,verifyContext:d})}catch(h){await this.sendError({id:c,topic:s,error:h,rpcOpts:pe.wc_sessionPropose.autoReject}),this.client.logger.error(h)}}),O(this,"onSessionProposeResponse",async(t,s,r)=>{const{id:n}=s;if(vt(s)){const{result:o}=s;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});const a=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});const c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});const h=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:h});const l=await this.client.core.crypto.generateSharedKey(c,h);this.pendingSessions.set(n,{sessionTopic:l,pairingTopic:t,proposalId:n,publicKey:c});const u=await this.client.core.relayer.subscribe(l,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:u}),await this.client.core.pairing.activate({topic:t})}else if(dt(s)){await this.deleteProposal(n);const o=X("session_connect",n);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners, 954`);this.events.emit(o,{error:s.error})}}),O(this,"onSessionSettleRequest",async(t,s)=>{const{id:r,params:n}=s;try{this.isValidSessionSettleRequest(n);const{relay:o,controller:a,expiry:c,namespaces:h,sessionProperties:l,scopedProperties:u,sessionConfig:d}=s.params,p=[...this.pendingSessions.values()].find(b=>b.sessionTopic===t);if(!p)return this.client.logger.error(`Pending session not found for topic ${t}`);const m=this.client.proposal.get(p.proposalId),g=Ue(se(se(se({topic:t,relay:o,expiry:c,namespaces:h,acknowledged:!0,pairingTopic:p.pairingTopic,requiredNamespaces:m.requiredNamespaces,optionalNamespaces:m.optionalNamespaces,controller:a.publicKey,self:{publicKey:p.publicKey,metadata:this.client.metadata},peer:{publicKey:a.publicKey,metadata:a.metadata}},l&&{sessionProperties:l}),u&&{scopedProperties:u}),d&&{sessionConfig:d}),{transportType:re.relay});await this.client.session.set(g.topic,g),await this.setExpiry(g.topic,g.expiry),await this.client.core.pairing.updateMetadata({topic:p.pairingTopic,metadata:g.peer.metadata}),this.client.events.emit("session_connect",{session:g}),this.events.emit(X("session_connect",p.proposalId),{session:g}),this.pendingSessions.delete(p.proposalId),this.deleteProposal(p.proposalId,!1),this.cleanupDuplicatePairings(g),await this.sendResult({id:s.id,topic:t,result:!0})}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),O(this,"onSessionSettleResponse",async(t,s)=>{const{id:r}=s;vt(s)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(X("session_approve",r),{})):dt(s)&&(await this.client.session.delete(t,ne("USER_DISCONNECTED")),this.events.emit(X("session_approve",r),{error:s.error}))}),O(this,"onSessionUpdateRequest",async(t,s)=>{const{params:r,id:n}=s;try{const o=`${t}_session_update`,a=Wi.get(o);if(a&&this.isRequestOutOfSync(a,n)){this.client.logger.warn(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:t,error:ne("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(se({topic:t},r));try{Wi.set(o,n),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:t,result:!0})}catch(c){throw Wi.delete(o),c}this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(o){await this.sendError({id:n,topic:t,error:o}),this.client.logger.error(o)}}),O(this,"isRequestOutOfSync",(t,s)=>s.toString().slice(0,-3)<t.toString().slice(0,-3)),O(this,"onSessionUpdateResponse",(t,s)=>{const{id:r}=s,n=X("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);vt(s)?this.events.emit(X("session_update",r),{}):dt(s)&&this.events.emit(X("session_update",r),{error:s.error})}),O(this,"onSessionExtendRequest",async(t,s)=>{const{id:r}=s;try{this.isValidExtend({topic:t}),await this.setExpiry(t,de(di)),await this.sendResult({id:r,topic:t,result:!0}),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),O(this,"onSessionExtendResponse",(t,s)=>{const{id:r}=s,n=X("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);vt(s)?this.events.emit(X("session_extend",r),{}):dt(s)&&this.events.emit(X("session_extend",r),{error:s.error})}),O(this,"onSessionPingRequest",async(t,s)=>{const{id:r}=s;try{this.isValidPing({topic:t}),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),O(this,"onSessionPingResponse",(t,s)=>{const{id:r}=s,n=X("session_ping",r);setTimeout(()=>{if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners 2176`);vt(s)?this.events.emit(X("session_ping",r),{}):dt(s)&&this.events.emit(X("session_ping",r),{error:s.error})},500)}),O(this,"onSessionDeleteRequest",async(t,s)=>{const{id:r}=s;try{this.isValidDisconnect({topic:t,reason:s.params}),Promise.all([new Promise(n=>{this.client.core.relayer.once(ge.publish,async()=>{n(await this.deleteSession({topic:t,id:r}))})}),this.sendResult({id:r,topic:t,result:!0}),this.cleanupPendingSentRequestsForTopic({topic:t,error:ne("USER_DISCONNECTED")})]).catch(n=>this.client.logger.error(n))}catch(n){this.client.logger.error(n)}}),O(this,"onSessionRequest",async t=>{var s,r,n;const{topic:o,payload:a,attestation:c,encryptedId:h,transportType:l}=t,{id:u,params:d}=a;try{await this.isValidRequest(se({topic:o},d));const p=this.client.session.get(o),m=await this.getVerifyContext({attestationId:c,hash:ft(JSON.stringify(Qt("wc_sessionRequest",d,u))),encryptedId:h,metadata:p.peer.metadata,transportType:l}),g={id:u,topic:o,params:d,verifyContext:m};await this.setPendingSessionRequest(g),l===re.link_mode&&(s=p.peer.metadata.redirect)!=null&&s.universal&&this.client.core.addLinkModeSupportedApp((r=p.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(g):(this.addSessionRequestToSessionRequestQueue(g),this.processSessionRequestQueue())}catch(p){await this.sendError({id:u,topic:o,error:p}),this.client.logger.error(p)}}),O(this,"onSessionRequestResponse",(t,s)=>{const{id:r}=s,n=X("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);vt(s)?this.events.emit(X("session_request",r),{result:s.result}):dt(s)&&this.events.emit(X("session_request",r),{error:s.error})}),O(this,"onSessionEventRequest",async(t,s)=>{const{id:r,params:n}=s;try{const o=`${t}_session_event_${n.event.name}`,a=Wi.get(o);if(a&&this.isRequestOutOfSync(a,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(se({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n}),Wi.set(o,r)}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),O(this,"onSessionAuthenticateResponse",(t,s)=>{const{id:r}=s;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:t,payload:s}),vt(s)?this.events.emit(X("session_request",r),{result:s.result}):dt(s)&&this.events.emit(X("session_request",r),{error:s.error})}),O(this,"onSessionAuthenticateRequest",async t=>{var s;const{topic:r,payload:n,attestation:o,encryptedId:a,transportType:c}=t;try{const{requester:h,authPayload:l,expiryTimestamp:u}=n.params,d=await this.getVerifyContext({attestationId:o,hash:ft(JSON.stringify(n)),encryptedId:a,metadata:h.metadata,transportType:c}),p={requester:h,pairingTopic:r,id:n.id,authPayload:l,verifyContext:d,expiryTimestamp:u};await this.setAuthRequest(n.id,{request:p,pairingTopic:r,transportType:c}),c===re.link_mode&&(s=h.metadata.redirect)!=null&&s.universal&&this.client.core.addLinkModeSupportedApp(h.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:d})}catch(h){this.client.logger.error(h);const l=n.params.requester.publicKey,u=await this.client.core.crypto.generateKeyPair(),d=this.getAppLinkIfEnabled(n.params.requester.metadata,c),p={type:_t,receiverPublicKey:l,senderPublicKey:u};await this.sendError({id:n.id,topic:r,error:h,encodeOpts:p,rpcOpts:pe.wc_sessionAuthenticate.autoReject,appLink:d})}}),O(this,"addSessionRequestToSessionRequestQueue",t=>{this.sessionRequestQueue.queue.push(t)}),O(this,"cleanupAfterResponse",t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=lt.idle,this.processSessionRequestQueue()},N.toMiliseconds(this.requestQueueDelay))}),O(this,"cleanupPendingSentRequestsForTopic",({topic:t,error:s})=>{const r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===t&&n.request.method==="wc_sessionRequest").forEach(n=>{const o=n.request.id,a=X("session_request",o);if(this.events.listenerCount(a)===0)throw new Error(`emitting ${a} without any listeners`);this.events.emit(X("session_request",n.request.id),{error:s})})}),O(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===lt.active){this.client.logger.info("session request queue is already active.");return}const t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.emitSessionRequest(t)}catch(s){this.client.logger.error(s)}}),O(this,"emitSessionRequest",t=>{if(this.emittedSessionRequests.has(t.id)){this.client.logger.warn({id:t.id},`Skipping emitting \`session_request\` event for duplicate request. id: ${t.id}`);return}this.sessionRequestQueue.state=lt.active,this.emittedSessionRequests.add(t.id),this.client.events.emit("session_request",t)}),O(this,"onPairingCreated",t=>{if(t.methods&&this.expectedPairingMethodMap.set(t.topic,t.methods),t.active)return;const s=this.client.proposal.getAll().find(r=>r.pairingTopic===t.topic);s&&this.onSessionProposeRequest({topic:t.topic,payload:Qt("wc_sessionPropose",Ue(se({},s),{requiredNamespaces:s.requiredNamespaces,optionalNamespaces:s.optionalNamespaces,relays:s.relays,proposer:s.proposer,sessionProperties:s.sessionProperties,scopedProperties:s.scopedProperties}),s.id),attestation:s.attestation,encryptedId:s.encryptedId})}),O(this,"isValidConnect",async t=>{if(!Ce(t)){const{message:h}=C("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(h)}const{pairingTopic:s,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:o,scopedProperties:a,relays:c}=t;if(ve(s)||await this.isValidPairingTopic(s),!qy(c)){const{message:h}=C("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(h)}if(!ve(r)&&gt(r)!==0){const h="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(h):this.client.logger.warn(h),this.validateNamespaces(r,"requiredNamespaces")}if(!ve(n)&&gt(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),ve(o)||this.validateSessionProps(o,"sessionProperties"),!ve(a)){this.validateSessionProps(a,"scopedProperties");const h=Object.keys(r||{}).concat(Object.keys(n||{}));if(!Object.keys(a).every(l=>h.includes(l.split(":")[0])))throw new Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(a)}, required/optional namespaces: ${JSON.stringify(h)}`)}}),O(this,"validateNamespaces",(t,s)=>{const r=Dy(t,"connect()",s);if(r)throw new Error(r.message)}),O(this,"isValidApprove",async t=>{if(!Ce(t))throw new Error(C("MISSING_OR_INVALID",`approve() params: ${t}`).message);const{id:s,namespaces:r,relayProtocol:n,sessionProperties:o,scopedProperties:a}=t;this.checkRecentlyDeleted(s),await this.isValidProposalId(s);const c=this.client.proposal.get(s),h=Or(r,"approve()");if(h)throw new Error(h.message);const l=fa(c.requiredNamespaces,r,"approve()");if(l)throw new Error(l.message);if(!le(n,!0)){const{message:u}=C("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(u)}if(ve(o)||this.validateSessionProps(o,"sessionProperties"),!ve(a)){this.validateSessionProps(a,"scopedProperties");const u=new Set(Object.keys(r));if(!Object.keys(a).every(d=>u.has(d.split(":")[0])))throw new Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(a)}, approved namespaces: ${Array.from(u).join(", ")}`)}}),O(this,"isValidReject",async t=>{if(!Ce(t)){const{message:n}=C("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}const{id:s,reason:r}=t;if(this.checkRecentlyDeleted(s),await this.isValidProposalId(s),!Ly(r)){const{message:n}=C("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}}),O(this,"isValidSessionSettleRequest",t=>{if(!Ce(t)){const{message:h}=C("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(h)}const{relay:s,controller:r,namespaces:n,expiry:o}=t;if(!Gh(s)){const{message:h}=C("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(h)}const a=Ry(r,"onSessionSettleRequest()");if(a)throw new Error(a.message);const c=Or(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(Dt(o)){const{message:h}=C("EXPIRED","onSessionSettleRequest()");throw new Error(h)}}),O(this,"isValidUpdate",async t=>{if(!Ce(t)){const{message:c}=C("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(c)}const{topic:s,namespaces:r}=t;this.checkRecentlyDeleted(s),await this.isValidSessionTopic(s);const n=this.client.session.get(s),o=Or(r,"update()");if(o)throw new Error(o.message);const a=fa(n.requiredNamespaces,r,"update()");if(a)throw new Error(a.message)}),O(this,"isValidExtend",async t=>{if(!Ce(t)){const{message:r}=C("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}const{topic:s}=t;this.checkRecentlyDeleted(s),await this.isValidSessionTopic(s)}),O(this,"isValidRequest",async t=>{if(!Ce(t)){const{message:c}=C("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(c)}const{topic:s,request:r,chainId:n,expiry:o}=t;this.checkRecentlyDeleted(s),await this.isValidSessionTopic(s);const{namespaces:a}=this.client.session.get(s);if(!da(a,n)){const{message:c}=C("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!My(r)){const{message:c}=C("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!Fy(a,n,r.method)){const{message:c}=C("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}if(o&&!Wy(o,kr)){const{message:c}=C("MISSING_OR_INVALID",`request() expiry: ${o}. Expiry must be a number (in seconds) between ${kr.min} and ${kr.max}`);throw new Error(c)}}),O(this,"isValidRespond",async t=>{var s;if(!Ce(t)){const{message:o}=C("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(o)}const{topic:r,response:n}=t;try{await this.isValidSessionTopic(r)}catch(o){throw(s=t==null?void 0:t.response)!=null&&s.id&&this.cleanupAfterResponse(t),o}if(!zy(n)){const{message:o}=C("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(o)}}),O(this,"isValidPing",async t=>{if(!Ce(t)){const{message:r}=C("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}const{topic:s}=t;await this.isValidSessionOrPairingTopic(s)}),O(this,"isValidEmit",async t=>{if(!Ce(t)){const{message:a}=C("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(a)}const{topic:s,event:r,chainId:n}=t;await this.isValidSessionTopic(s);const{namespaces:o}=this.client.session.get(s);if(!da(o,n)){const{message:a}=C("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(a)}if(!Hy(r)){const{message:a}=C("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}if(!Vy(o,n,r.name)){const{message:a}=C("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}}),O(this,"isValidDisconnect",async t=>{if(!Ce(t)){const{message:r}=C("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}const{topic:s}=t;await this.isValidSessionOrPairingTopic(s)}),O(this,"isValidAuthenticate",t=>{const{chains:s,uri:r,domain:n,nonce:o}=t;if(!Array.isArray(s)||s.length===0)throw new Error("chains is required and must be a non-empty array");if(!le(r,!1))throw new Error("uri is required parameter");if(!le(n,!1))throw new Error("domain is required parameter");if(!le(o,!1))throw new Error("nonce is required parameter");if([...new Set(s.map(c=>Ai(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");const{namespace:a}=Ai(s[0]);if(a!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),O(this,"getVerifyContext",async t=>{const{attestationId:s,hash:r,encryptedId:n,metadata:o,transportType:a}=t,c={verified:{verifyUrl:o.verifyUrl||ls,validation:"UNKNOWN",origin:o.url||""}};try{if(a===re.link_mode){const l=this.getAppLinkIfEnabled(o,a);return c.verified.validation=l&&new URL(l).origin===new URL(o.url).origin?"VALID":"INVALID",c}const h=await this.client.core.verify.resolve({attestationId:s,hash:r,encryptedId:n,verifyUrl:o.verifyUrl});h&&(c.verified.origin=h.origin,c.verified.isScam=h.isScam,c.verified.validation=h.origin===new URL(o.url).origin?"VALID":"INVALID")}catch(h){this.client.logger.warn(h)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c}),O(this,"validateSessionProps",(t,s)=>{Object.values(t).forEach((r,n)=>{if(r==null){const{message:o}=C("MISSING_OR_INVALID",`${s} must contain an existing value for each key. Received: ${r} for key ${Object.keys(t)[n]}`);throw new Error(o)}})}),O(this,"getPendingAuthRequest",t=>{const s=this.client.auth.requests.get(t);return typeof s=="object"?s:void 0}),O(this,"addToRecentlyDeleted",(t,s)=>{if(this.recentlyDeletedMap.set(t,s),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0;const n=this.recentlyDeletedLimit/2;for(const o of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(o)}}}),O(this,"checkRecentlyDeleted",t=>{const s=this.recentlyDeletedMap.get(t);if(s){const{message:r}=C("MISSING_OR_INVALID",`Record was recently deleted - ${s}: ${t}`);throw new Error(r)}}),O(this,"isLinkModeEnabled",(t,s)=>{var r,n,o,a,c,h,l,u,d;return!t||s!==re.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((a=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:a.universal)!==void 0&&((h=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:h.universal)!==""&&((l=t==null?void 0:t.redirect)==null?void 0:l.universal)!==void 0&&((u=t==null?void 0:t.redirect)==null?void 0:u.universal)!==""&&((d=t==null?void 0:t.redirect)==null?void 0:d.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(t.redirect.universal)&&typeof(global==null?void 0:global.Linking)<"u"}),O(this,"getAppLinkIfEnabled",(t,s)=>{var r;return this.isLinkModeEnabled(t,s)?(r=t==null?void 0:t.redirect)==null?void 0:r.universal:void 0}),O(this,"handleLinkModeMessage",({url:t})=>{if(!t||!t.includes("wc_ev")||!t.includes("topic"))return;const s=$o(t,"topic")||"",r=decodeURIComponent($o(t,"wc_ev")||""),n=this.client.session.keys.includes(s);n&&this.client.session.update(s,{transportType:re.link_mode}),this.client.core.dispatchEnvelope({topic:s,message:r,sessionExists:n})}),O(this,"registerLinkModeListeners",async()=>{var t;if(Mn()||Kt()&&(t=this.client.metadata.redirect)!=null&&t.linkMode){const s=global==null?void 0:global.Linking;if(typeof s<"u"){s.addEventListener("url",this.handleLinkModeMessage,this.client.name);const r=await s.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}),O(this,"getTVFParams",(t,s,r)=>{var n,o,a;if(!((n=s.request)!=null&&n.method))return{};const c={correlationId:t,rpcMethods:[s.request.method],chainId:s.chainId};try{const h=this.extractTxHashesFromResult(s.request,r);c.txHashes=h,c.contractAddresses=this.isValidContractData(s.request.params)?[(a=(o=s.request.params)==null?void 0:o[0])==null?void 0:a.to]:[]}catch(h){this.client.logger.warn("Error getting TVF params",h)}return c}),O(this,"isValidContractData",t=>{var s;if(!t)return!1;try{const r=(t==null?void 0:t.data)||((s=t==null?void 0:t[0])==null?void 0:s.data);if(!r.startsWith("0x"))return!1;const n=r.slice(2);return/^[0-9a-fA-F]*$/.test(n)?n.length%2===0:!1}catch{}return!1}),O(this,"extractTxHashesFromResult",(t,s)=>{var r;try{if(!s)return[];const n=t.method,o=Yb[n];if(n==="sui_signTransaction")return[mp(s.transactionBytes)];if(n==="near_signTransaction")return[No(s)];if(n==="near_signTransactions")return s.map(c=>No(c));if(n==="xrpl_signTransactionFor"||n==="xrpl_signTransaction")return[(r=s.tx_json)==null?void 0:r.hash];if(n==="polkadot_signTransaction")return[hm({transaction:t.params.transactionPayload,signature:s.signature})];if(n==="algo_signTxn")return Pt(s)?s.map(c=>Bo(c)):[Bo(s)];if(n==="cosmos_signDirect")return[bp(s)];if(typeof s=="string")return[s];const a=s[o.key];if(Pt(a))return n==="solana_signAllTransactions"?a.map(c=>yp(c)):a;if(typeof a=="string")return[a]}catch(n){this.client.logger.warn("Error extracting tx hashes from result",n)}return[]})}async processPendingMessageEvents(){try{const e=this.client.session.keys,t=this.client.core.relayer.messages.getWithoutAck(e);for(const[s,r]of Object.entries(t))for(const n of r)try{await this.onProviderMessageEvent({topic:s,message:n,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${s}, message: ${n}`)}}catch(e){this.client.logger.warn("processPendingMessageEvents failed",e)}}isInitialized(){if(!this.initialized){const{message:e}=C("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(ge.message,e=>{this.onProviderMessageEvent(e)})}async onRelayMessage(e){const{topic:t,message:s,attestation:r,transportType:n}=e,{publicKey:o}=this.client.auth.authKeys.keys.includes(Vs)?this.client.auth.authKeys.get(Vs):{publicKey:void 0};try{const a=await this.client.core.crypto.decode(t,s,{receiverPublicKey:o,encoding:n===re.link_mode?Mt:nt});On(a)?(this.client.core.history.set(t,a),await this.onRelayEventRequest({topic:t,payload:a,attestation:r,transportType:n,encryptedId:ft(s)})):Tn(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:t,payload:a,transportType:n}),this.client.core.history.delete(t,a.id)):await this.onRelayEventUnknownPayload({topic:t,payload:a,transportType:n}),await this.client.core.relayer.messages.ack(t,s)}catch(a){this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on(Ge.expired,async e=>{const{topic:t,id:s}=th(e.target);if(s&&this.client.pendingRequest.keys.includes(s))return await this.deletePendingSessionRequest(s,C("EXPIRED"),!0);if(s&&this.client.auth.requests.keys.includes(s))return await this.deletePendingAuthRequest(s,C("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession({topic:t,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:t})):s&&(await this.deleteProposal(s,!0),this.client.events.emit("proposal_expire",{id:s}))})}registerPairingEvents(){this.client.core.pairing.events.on(Yt.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(Yt.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!le(e,!1)){const{message:t}=C("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){const{message:t}=C("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(Dt(this.client.core.pairing.pairings.get(e).expiry)){const{message:t}=C("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!le(e,!1)){const{message:t}=C("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){const{message:t}=C("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(Dt(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});const{message:t}=C("EXPIRED",`session topic: ${e}`);throw new Error(t)}if(!this.client.core.crypto.keychain.has(e)){const{message:t}=C("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(le(e,!1)){const{message:t}=C("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{const{message:t}=C("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!jy(e)){const{message:t}=C("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){const{message:t}=C("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(Dt(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);const{message:t}=C("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}}class l1 extends oi{constructor(e,t){super(e,t,Gb,to),this.core=e,this.logger=t}}let u1=class extends oi{constructor(e,t){super(e,t,Wb,to),this.core=e,this.logger=t}};class d1 extends oi{constructor(e,t){super(e,t,Zb,to,s=>s.id),this.core=e,this.logger=t}}class f1 extends oi{constructor(e,t){super(e,t,t1,pr,()=>Vs),this.core=e,this.logger=t}}class p1 extends oi{constructor(e,t){super(e,t,i1,pr),this.core=e,this.logger=t}}class g1 extends oi{constructor(e,t){super(e,t,s1,pr,s=>s.id),this.core=e,this.logger=t}}var y1=Object.defineProperty,m1=(i,e,t)=>e in i?y1(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Dr=(i,e,t)=>m1(i,typeof e!="symbol"?e+"":e,t);class w1{constructor(e,t){this.core=e,this.logger=t,Dr(this,"authKeys"),Dr(this,"pairingTopics"),Dr(this,"requests"),this.authKeys=new f1(this.core,this.logger),this.pairingTopics=new p1(this.core,this.logger),this.requests=new g1(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}}var b1=Object.defineProperty,v1=(i,e,t)=>e in i?b1(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,W=(i,e,t)=>v1(i,typeof e!="symbol"?e+"":e,t);let E1=class pl extends uu{constructor(e){super(e),W(this,"protocol",ul),W(this,"version",dl),W(this,"name",Br.name),W(this,"metadata"),W(this,"core"),W(this,"logger"),W(this,"events",new Vt.EventEmitter),W(this,"engine"),W(this,"session"),W(this,"proposal"),W(this,"pendingRequest"),W(this,"auth"),W(this,"signConfig"),W(this,"on",(s,r)=>this.events.on(s,r)),W(this,"once",(s,r)=>this.events.once(s,r)),W(this,"off",(s,r)=>this.events.off(s,r)),W(this,"removeListener",(s,r)=>this.events.removeListener(s,r)),W(this,"removeAllListeners",s=>this.events.removeAllListeners(s)),W(this,"connect",async s=>{try{return await this.engine.connect(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"pair",async s=>{try{return await this.engine.pair(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"approve",async s=>{try{return await this.engine.approve(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"reject",async s=>{try{return await this.engine.reject(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"update",async s=>{try{return await this.engine.update(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"extend",async s=>{try{return await this.engine.extend(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"request",async s=>{try{return await this.engine.request(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"respond",async s=>{try{return await this.engine.respond(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"ping",async s=>{try{return await this.engine.ping(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"emit",async s=>{try{return await this.engine.emit(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"disconnect",async s=>{try{return await this.engine.disconnect(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"find",s=>{try{return this.engine.find(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(s){throw this.logger.error(s.message),s}}),W(this,"authenticate",async(s,r)=>{try{return await this.engine.authenticate(s,r)}catch(n){throw this.logger.error(n.message),n}}),W(this,"formatAuthMessage",s=>{try{return this.engine.formatAuthMessage(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"approveSessionAuthenticate",async s=>{try{return await this.engine.approveSessionAuthenticate(s)}catch(r){throw this.logger.error(r.message),r}}),W(this,"rejectSessionAuthenticate",async s=>{try{return await this.engine.rejectSessionAuthenticate(s)}catch(r){throw this.logger.error(r.message),r}}),this.name=(e==null?void 0:e.name)||Br.name,this.metadata=cf(e==null?void 0:e.metadata),this.signConfig=e==null?void 0:e.signConfig;const t=typeof(e==null?void 0:e.logger)<"u"&&typeof(e==null?void 0:e.logger)!="string"?e.logger:An(sr({level:(e==null?void 0:e.logger)||Br.logger}));this.core=(e==null?void 0:e.core)||new Kb(e),this.logger=Te(t,this.name),this.session=new u1(this.core,this.logger),this.proposal=new l1(this.core,this.logger),this.pendingRequest=new d1(this.core,this.logger),this.engine=new h1(this),this.auth=new w1(this.core,this.logger)}static async init(e){const t=new pl(e);return await t.initialize(),t}get context(){return He(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success")}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};var _n={exports:{}};(function(i,e){var t=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof _s<"u"&&_s,s=function(){function n(){this.fetch=!1,this.DOMException=t.DOMException}return n.prototype=t,new n}();(function(n){(function(o){var a=typeof n<"u"&&n||typeof self<"u"&&self||typeof _s<"u"&&_s||{},c={searchParams:"URLSearchParams"in a,iterable:"Symbol"in a&&"iterator"in Symbol,blob:"FileReader"in a&&"Blob"in a&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in a,arrayBuffer:"ArrayBuffer"in a};function h(f){return f&&DataView.prototype.isPrototypeOf(f)}if(c.arrayBuffer)var l=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(f){return f&&l.indexOf(Object.prototype.toString.call(f))>-1};function d(f){if(typeof f!="string"&&(f=String(f)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(f)||f==="")throw new TypeError('Invalid character in header field name: "'+f+'"');return f.toLowerCase()}function p(f){return typeof f!="string"&&(f=String(f)),f}function m(f){var w={next:function(){var I=f.shift();return{done:I===void 0,value:I}}};return c.iterable&&(w[Symbol.iterator]=function(){return w}),w}function g(f){this.map={},f instanceof g?f.forEach(function(w,I){this.append(I,w)},this):Array.isArray(f)?f.forEach(function(w){if(w.length!=2)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+w.length);this.append(w[0],w[1])},this):f&&Object.getOwnPropertyNames(f).forEach(function(w){this.append(w,f[w])},this)}g.prototype.append=function(f,w){f=d(f),w=p(w);var I=this.map[f];this.map[f]=I?I+", "+w:w},g.prototype.delete=function(f){delete this.map[d(f)]},g.prototype.get=function(f){return f=d(f),this.has(f)?this.map[f]:null},g.prototype.has=function(f){return this.map.hasOwnProperty(d(f))},g.prototype.set=function(f,w){this.map[d(f)]=p(w)},g.prototype.forEach=function(f,w){for(var I in this.map)this.map.hasOwnProperty(I)&&f.call(w,this.map[I],I,this)},g.prototype.keys=function(){var f=[];return this.forEach(function(w,I){f.push(I)}),m(f)},g.prototype.values=function(){var f=[];return this.forEach(function(w){f.push(w)}),m(f)},g.prototype.entries=function(){var f=[];return this.forEach(function(w,I){f.push([I,w])}),m(f)},c.iterable&&(g.prototype[Symbol.iterator]=g.prototype.entries);function b(f){if(!f._noBody){if(f.bodyUsed)return Promise.reject(new TypeError("Already read"));f.bodyUsed=!0}}function T(f){return new Promise(function(w,I){f.onload=function(){w(f.result)},f.onerror=function(){I(f.error)}})}function $(f){var w=new FileReader,I=T(w);return w.readAsArrayBuffer(f),I}function D(f){var w=new FileReader,I=T(w),S=/charset=([A-Za-z0-9_-]+)/.exec(f.type),x=S?S[1]:"utf-8";return w.readAsText(f,x),I}function M(f){for(var w=new Uint8Array(f),I=new Array(w.length),S=0;S<w.length;S++)I[S]=String.fromCharCode(w[S]);return I.join("")}function R(f){if(f.slice)return f.slice(0);var w=new Uint8Array(f.byteLength);return w.set(new Uint8Array(f)),w.buffer}function j(){return this.bodyUsed=!1,this._initBody=function(f){this.bodyUsed=this.bodyUsed,this._bodyInit=f,f?typeof f=="string"?this._bodyText=f:c.blob&&Blob.prototype.isPrototypeOf(f)?this._bodyBlob=f:c.formData&&FormData.prototype.isPrototypeOf(f)?this._bodyFormData=f:c.searchParams&&URLSearchParams.prototype.isPrototypeOf(f)?this._bodyText=f.toString():c.arrayBuffer&&c.blob&&h(f)?(this._bodyArrayBuffer=R(f.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):c.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(f)||u(f))?this._bodyArrayBuffer=R(f):this._bodyText=f=Object.prototype.toString.call(f):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||(typeof f=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):c.searchParams&&URLSearchParams.prototype.isPrototypeOf(f)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},c.blob&&(this.blob=function(){var f=b(this);if(f)return f;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var f=b(this);return f||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else{if(c.blob)return this.blob().then($);throw new Error("could not read as ArrayBuffer")}},this.text=function(){var f=b(this);if(f)return f;if(this._bodyBlob)return D(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(M(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},c.formData&&(this.formData=function(){return this.text().then(_)}),this.json=function(){return this.text().then(JSON.parse)},this}var L=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function q(f){var w=f.toUpperCase();return L.indexOf(w)>-1?w:f}function y(f,w){if(!(this instanceof y))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');w=w||{};var I=w.body;if(f instanceof y){if(f.bodyUsed)throw new TypeError("Already read");this.url=f.url,this.credentials=f.credentials,w.headers||(this.headers=new g(f.headers)),this.method=f.method,this.mode=f.mode,this.signal=f.signal,!I&&f._bodyInit!=null&&(I=f._bodyInit,f.bodyUsed=!0)}else this.url=String(f);if(this.credentials=w.credentials||this.credentials||"same-origin",(w.headers||!this.headers)&&(this.headers=new g(w.headers)),this.method=q(w.method||this.method||"GET"),this.mode=w.mode||this.mode||null,this.signal=w.signal||this.signal||function(){if("AbortController"in a){var A=new AbortController;return A.signal}}(),this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&I)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(I),(this.method==="GET"||this.method==="HEAD")&&(w.cache==="no-store"||w.cache==="no-cache")){var S=/([?&])_=[^&]*/;if(S.test(this.url))this.url=this.url.replace(S,"$1_="+new Date().getTime());else{var x=/\?/;this.url+=(x.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}y.prototype.clone=function(){return new y(this,{body:this._bodyInit})};function _(f){var w=new FormData;return f.trim().split("&").forEach(function(I){if(I){var S=I.split("="),x=S.shift().replace(/\+/g," "),A=S.join("=").replace(/\+/g," ");w.append(decodeURIComponent(x),decodeURIComponent(A))}}),w}function E(f){var w=new g,I=f.replace(/\r?\n[\t ]+/g," ");return I.split("\r").map(function(S){return S.indexOf(`
`)===0?S.substr(1,S.length):S}).forEach(function(S){var x=S.split(":"),A=x.shift().trim();if(A){var k=x.join(":").trim();try{w.append(A,k)}catch(H){console.warn("Response "+H.message)}}}),w}j.call(y.prototype);function v(f,w){if(!(this instanceof v))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(w||(w={}),this.type="default",this.status=w.status===void 0?200:w.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=w.statusText===void 0?"":""+w.statusText,this.headers=new g(w.headers),this.url=w.url||"",this._initBody(f)}j.call(v.prototype),v.prototype.clone=function(){return new v(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new g(this.headers),url:this.url})},v.error=function(){var f=new v(null,{status:200,statusText:""});return f.ok=!1,f.status=0,f.type="error",f};var P=[301,302,303,307,308];v.redirect=function(f,w){if(P.indexOf(w)===-1)throw new RangeError("Invalid status code");return new v(null,{status:w,headers:{location:f}})},o.DOMException=a.DOMException;try{new o.DOMException}catch{o.DOMException=function(w,I){this.message=w,this.name=I;var S=Error(w);this.stack=S.stack},o.DOMException.prototype=Object.create(Error.prototype),o.DOMException.prototype.constructor=o.DOMException}function U(f,w){return new Promise(function(I,S){var x=new y(f,w);if(x.signal&&x.signal.aborted)return S(new o.DOMException("Aborted","AbortError"));var A=new XMLHttpRequest;function k(){A.abort()}A.onload=function(){var z={statusText:A.statusText,headers:E(A.getAllResponseHeaders()||"")};x.url.indexOf("file://")===0&&(A.status<200||A.status>599)?z.status=200:z.status=A.status,z.url="responseURL"in A?A.responseURL:z.headers.get("X-Request-URL");var F="response"in A?A.response:A.responseText;setTimeout(function(){I(new v(F,z))},0)},A.onerror=function(){setTimeout(function(){S(new TypeError("Network request failed"))},0)},A.ontimeout=function(){setTimeout(function(){S(new TypeError("Network request timed out"))},0)},A.onabort=function(){setTimeout(function(){S(new o.DOMException("Aborted","AbortError"))},0)};function H(z){try{return z===""&&a.location.href?a.location.href:z}catch{return z}}if(A.open(x.method,H(x.url),!0),x.credentials==="include"?A.withCredentials=!0:x.credentials==="omit"&&(A.withCredentials=!1),"responseType"in A&&(c.blob?A.responseType="blob":c.arrayBuffer&&(A.responseType="arraybuffer")),w&&typeof w.headers=="object"&&!(w.headers instanceof g||a.Headers&&w.headers instanceof a.Headers)){var K=[];Object.getOwnPropertyNames(w.headers).forEach(function(z){K.push(d(z)),A.setRequestHeader(z,p(w.headers[z]))}),x.headers.forEach(function(z,F){K.indexOf(F)===-1&&A.setRequestHeader(F,z)})}else x.headers.forEach(function(z,F){A.setRequestHeader(F,z)});x.signal&&(x.signal.addEventListener("abort",k),A.onreadystatechange=function(){A.readyState===4&&x.signal.removeEventListener("abort",k)}),A.send(typeof x._bodyInit>"u"?null:x._bodyInit)})}return U.polyfill=!0,a.fetch||(a.fetch=U,a.Headers=g,a.Request=y,a.Response=v),o.Headers=g,o.Request=y,o.Response=v,o.fetch=U,Object.defineProperty(o,"__esModule",{value:!0}),o})({})})(s),s.fetch.ponyfill=!0,delete s.fetch.polyfill;var r=t.fetch?t:s;e=r.fetch,e.default=r.fetch,e.fetch=r.fetch,e.Headers=r.Headers,e.Request=r.Request,e.Response=r.Response,i.exports=e})(_n,_n.exports);var I1=_n.exports;const Ha=Dl(I1);var x1=Object.defineProperty,_1=Object.defineProperties,P1=Object.getOwnPropertyDescriptors,Fa=Object.getOwnPropertySymbols,$1=Object.prototype.hasOwnProperty,S1=Object.prototype.propertyIsEnumerable,Va=(i,e,t)=>e in i?x1(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ka=(i,e)=>{for(var t in e||(e={}))$1.call(e,t)&&Va(i,t,e[t]);if(Fa)for(var t of Fa(e))S1.call(e,t)&&Va(i,t,e[t]);return i},Ga=(i,e)=>_1(i,P1(e));const A1={Accept:"application/json","Content-Type":"application/json"},O1="POST",Wa={headers:A1,method:O1},Ja=10;let at=class{constructor(e,t=!1){if(this.url=e,this.disableProviderPing=t,this.events=new Vt.EventEmitter,this.isAvailable=!1,this.registering=!1,!ao(e))throw new Error(`Provided URL is not compatible with HTTP connection: ${e}`);this.url=e,this.disableProviderPing=t}get connected(){return this.isAvailable}get connecting(){return this.registering}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async open(e=this.url){await this.register(e)}async close(){if(!this.isAvailable)throw new Error("Connection already closed");this.onClose()}async send(e){this.isAvailable||await this.register();try{const t=Hr(e),s=await(await Ha(this.url,Ga(Ka({},Wa),{body:t}))).json();this.onPayload({data:s})}catch(t){this.onError(e.id,t)}}async register(e=this.url){if(!ao(e))throw new Error(`Provided URL is not compatible with HTTP connection: ${e}`);if(this.registering){const t=this.events.getMaxListeners();return(this.events.listenerCount("register_error")>=t||this.events.listenerCount("open")>=t)&&this.events.setMaxListeners(t+1),new Promise((s,r)=>{this.events.once("register_error",n=>{this.resetMaxListeners(),r(n)}),this.events.once("open",()=>{if(this.resetMaxListeners(),typeof this.isAvailable>"u")return r(new Error("HTTP connection is missing or invalid"));s()})})}this.url=e,this.registering=!0;try{if(!this.disableProviderPing){const t=Hr({id:1,jsonrpc:"2.0",method:"test",params:[]});await Ha(e,Ga(Ka({},Wa),{body:t}))}this.onOpen()}catch(t){const s=this.parseError(t);throw this.events.emit("register_error",s),this.onClose(),s}}onOpen(){this.isAvailable=!0,this.registering=!1,this.events.emit("open")}onClose(){this.isAvailable=!1,this.registering=!1,this.events.emit("close")}onPayload(e){if(typeof e.data>"u")return;const t=typeof e.data=="string"?Fr(e.data):e.data;this.events.emit("payload",t)}onError(e,t){const s=this.parseError(t),r=s.message||s.toString(),n=Un(e,r);this.events.emit("payload",n)}parseError(e,t=this.url){return ql(e,t,"HTTP")}resetMaxListeners(){this.events.getMaxListeners()>Ja&&this.events.setMaxListeners(Ja)}};const Ya="error",T1="wss://relay.walletconnect.org",R1="wc",U1="universal_provider",Ds=`${R1}@2:${U1}:`,gl="https://rpc.walletconnect.org/v1/",_i="generic",C1=`${gl}bundler`,Xe={DEFAULT_CHAIN_CHANGED:"default_chain_changed"};function io(i){return i==null||typeof i!="object"&&typeof i!="function"}function yl(i){return Object.getOwnPropertySymbols(i).filter(e=>Object.prototype.propertyIsEnumerable.call(i,e))}function ml(i){return i==null?i===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(i)}const N1="[object RegExp]",wl="[object String]",bl="[object Number]",vl="[object Boolean]",El="[object Arguments]",B1="[object Symbol]",k1="[object Date]",D1="[object Map]",q1="[object Set]",j1="[object Array]",L1="[object ArrayBuffer]",M1="[object Object]",z1="[object DataView]",H1="[object Uint8Array]",F1="[object Uint8ClampedArray]",V1="[object Uint16Array]",K1="[object Uint32Array]",G1="[object Int8Array]",W1="[object Int16Array]",J1="[object Int32Array]",Y1="[object Float32Array]",Z1="[object Float64Array]";function so(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Q1(i,e){return Si(i,void 0,i,new Map,e)}function Si(i,e,t,s=new Map,r=void 0){const n=r==null?void 0:r(i,e,t,s);if(n!=null)return n;if(io(i))return i;if(s.has(i))return s.get(i);if(Array.isArray(i)){const o=new Array(i.length);s.set(i,o);for(let a=0;a<i.length;a++)o[a]=Si(i[a],a,t,s,r);return Object.hasOwn(i,"index")&&(o.index=i.index),Object.hasOwn(i,"input")&&(o.input=i.input),o}if(i instanceof Date)return new Date(i.getTime());if(i instanceof RegExp){const o=new RegExp(i.source,i.flags);return o.lastIndex=i.lastIndex,o}if(i instanceof Map){const o=new Map;s.set(i,o);for(const[a,c]of i)o.set(a,Si(c,a,t,s,r));return o}if(i instanceof Set){const o=new Set;s.set(i,o);for(const a of i)o.add(Si(a,void 0,t,s,r));return o}if(typeof Buffer<"u"&&Buffer.isBuffer(i))return i.subarray();if(so(i)){const o=new(Object.getPrototypeOf(i)).constructor(i.length);s.set(i,o);for(let a=0;a<i.length;a++)o[a]=Si(i[a],a,t,s,r);return o}if(i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer)return i.slice(0);if(i instanceof DataView){const o=new DataView(i.buffer.slice(0),i.byteOffset,i.byteLength);return s.set(i,o),Zt(o,i,t,s,r),o}if(typeof File<"u"&&i instanceof File){const o=new File([i],i.name,{type:i.type});return s.set(i,o),Zt(o,i,t,s,r),o}if(i instanceof Blob){const o=new Blob([i],{type:i.type});return s.set(i,o),Zt(o,i,t,s,r),o}if(i instanceof Error){const o=new i.constructor;return s.set(i,o),o.message=i.message,o.name=i.name,o.stack=i.stack,o.cause=i.cause,Zt(o,i,t,s,r),o}if(typeof i=="object"&&X1(i)){const o=Object.create(Object.getPrototypeOf(i));return s.set(i,o),Zt(o,i,t,s,r),o}return i}function Zt(i,e,t=i,s,r){const n=[...Object.keys(e),...yl(e)];for(let o=0;o<n.length;o++){const a=n[o],c=Object.getOwnPropertyDescriptor(i,a);(c==null||c.writable)&&(i[a]=Si(e[a],a,t,s,r))}}function X1(i){switch(ml(i)){case El:case j1:case L1:case z1:case vl:case k1:case Y1:case Z1:case G1:case W1:case J1:case D1:case bl:case M1:case N1:case q1:case wl:case B1:case H1:case F1:case V1:case K1:return!0;default:return!1}}function ev(i,e){return Q1(i,(t,s,r,n)=>{if(typeof i=="object")switch(Object.prototype.toString.call(i)){case bl:case wl:case vl:{const o=new i.constructor(i==null?void 0:i.valueOf());return Zt(o,i),o}case El:{const o={};return Zt(o,i),o.length=i.length,o[Symbol.iterator]=i[Symbol.iterator],o}default:return}})}function Za(i){return ev(i)}function Qa(i){return i!==null&&typeof i=="object"&&ml(i)==="[object Arguments]"}function Xa(i){return typeof i=="object"&&i!==null}function tv(){}function iv(i){return so(i)}function sv(i){var t;if(typeof i!="object"||i==null)return!1;if(Object.getPrototypeOf(i)===null)return!0;if(Object.prototype.toString.call(i)!=="[object Object]"){const s=i[Symbol.toStringTag];return s==null||!((t=Object.getOwnPropertyDescriptor(i,Symbol.toStringTag))!=null&&t.writable)?!1:i.toString()===`[object ${s}]`}let e=i;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(i)===e}function rv(i){if(io(i))return i;if(Array.isArray(i)||so(i)||i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer)return i.slice(0);const e=Object.getPrototypeOf(i),t=e.constructor;if(i instanceof Date||i instanceof Map||i instanceof Set)return new t(i);if(i instanceof RegExp){const s=new t(i);return s.lastIndex=i.lastIndex,s}if(i instanceof DataView)return new t(i.buffer.slice(0));if(i instanceof Error){const s=new t(i.message);return s.stack=i.stack,s.name=i.name,s.cause=i.cause,s}if(typeof File<"u"&&i instanceof File)return new t([i],i.name,{type:i.type,lastModified:i.lastModified});if(typeof i=="object"){const s=Object.create(e);return Object.assign(s,i)}return i}function nv(i,...e){const t=e.slice(0,-1),s=e[e.length-1];let r=i;for(let n=0;n<t.length;n++){const o=t[n];r=Pn(r,o,s,new Map)}return r}function Pn(i,e,t,s){if(io(i)&&(i=Object(i)),e==null||typeof e!="object")return i;if(s.has(e))return rv(s.get(e));if(s.set(e,i),Array.isArray(e)){e=e.slice();for(let n=0;n<e.length;n++)e[n]=e[n]??void 0}const r=[...Object.keys(e),...yl(e)];for(let n=0;n<r.length;n++){const o=r[n];let a=e[o],c=i[o];if(Qa(a)&&(a={...a}),Qa(c)&&(c={...c}),typeof Buffer<"u"&&Buffer.isBuffer(a)&&(a=Za(a)),Array.isArray(a))if(typeof c=="object"&&c!=null){const l=[],u=Reflect.ownKeys(c);for(let d=0;d<u.length;d++){const p=u[d];l[p]=c[p]}c=l}else c=[];const h=t(c,a,o,i,e,s);h!=null?i[o]=h:Array.isArray(a)||Xa(c)&&Xa(a)?i[o]=Pn(c,a,t,s):c==null&&sv(a)?i[o]=Pn({},a,t,s):c==null&&iv(a)?i[o]=Za(a):(c===void 0||a!==void 0)&&(i[o]=a)}return i}function ov(i,...e){return nv(i,...e,tv)}var av=Object.defineProperty,cv=Object.defineProperties,hv=Object.getOwnPropertyDescriptors,ec=Object.getOwnPropertySymbols,lv=Object.prototype.hasOwnProperty,uv=Object.prototype.propertyIsEnumerable,tc=(i,e,t)=>e in i?av(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,qs=(i,e)=>{for(var t in e||(e={}))lv.call(e,t)&&tc(i,t,e[t]);if(ec)for(var t of ec(e))uv.call(e,t)&&tc(i,t,e[t]);return i},dv=(i,e)=>cv(i,hv(e));function ze(i,e,t){var s;const r=Ai(i);return((s=e.rpcMap)==null?void 0:s[r.reference])||`${gl}?chainId=${r.namespace}:${r.reference}&projectId=${t}`}function ai(i){return i.includes(":")?i.split(":")[1]:i}function Il(i){return i.map(e=>`${e.split(":")[0]}:${e.split(":")[1]}`)}function fv(i,e){const t=Object.keys(e.namespaces).filter(r=>r.includes(i));if(!t.length)return[];const s=[];return t.forEach(r=>{const n=e.namespaces[r].accounts;s.push(...n)}),s}function js(i={},e={}){const t=ic(i),s=ic(e);return ov(t,s)}function ic(i){var e,t,s,r,n;const o={};if(!gt(i))return o;for(const[a,c]of Object.entries(i)){const h=dr(a)?[a]:c.chains,l=c.methods||[],u=c.events||[],d=c.rpcMap||{},p=$i(a);o[p]=dv(qs(qs({},o[p]),c),{chains:pt(h,(e=o[p])==null?void 0:e.chains),methods:pt(l,(t=o[p])==null?void 0:t.methods),events:pt(u,(s=o[p])==null?void 0:s.events)}),(gt(d)||gt(((r=o[p])==null?void 0:r.rpcMap)||{}))&&(o[p].rpcMap=qs(qs({},d),(n=o[p])==null?void 0:n.rpcMap))}return o}function sc(i){return i.includes(":")?i.split(":")[2]:i}function rc(i){const e={};for(const[t,s]of Object.entries(i)){const r=s.methods||[],n=s.events||[],o=s.accounts||[],a=dr(t)?[t]:s.chains?s.chains:Il(s.accounts);e[t]={chains:a,methods:r,events:n,accounts:o}}return e}function qr(i){return typeof i=="number"?i:i.includes("0x")?parseInt(i,16):(i=i.includes(":")?i.split(":")[1]:i,isNaN(Number(i))?i:Number(i))}const xl={},Q=i=>xl[i],jr=(i,e)=>{xl[i]=e};var pv=Object.defineProperty,nc=Object.getOwnPropertySymbols,gv=Object.prototype.hasOwnProperty,yv=Object.prototype.propertyIsEnumerable,oc=(i,e,t)=>e in i?pv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ac=(i,e)=>{for(var t in e||(e={}))gv.call(e,t)&&oc(i,t,e[t]);if(nc)for(var t of nc(e))yv.call(e,t)&&oc(i,t,e[t]);return i};const cc="eip155",mv=["atomic","flow-control","paymasterService","sessionKeys","auxiliaryFunds"],wv=i=>i&&i.startsWith("0x")?BigInt(i).toString(10):i,Lr=i=>i&&i.startsWith("0x")?i:`0x${BigInt(i).toString(16)}`,hc=i=>Object.keys(i).filter(e=>mv.includes(e)).reduce((e,t)=>(e[t]=i[t],e),{}),bv=(i,e,t)=>{const{sessionProperties:s={},scopedProperties:r={}}=i,n={};if(!gt(r)&&!gt(s))return;const o=hc(s);for(const a of t){const c=wv(a);if(!c)continue;n[Lr(c)]=o;const h=r==null?void 0:r[`${cc}:${c}`];if(h){const l=h==null?void 0:h[`${cc}:${c}:${e}`];n[Lr(c)]=ac(ac({},n[Lr(c)]),hc(l||h))}}for(const[a,c]of Object.entries(n))Object.keys(c).length===0&&delete n[a];return Object.keys(n).length>0?n:void 0};var vv=Object.defineProperty,Ev=(i,e,t)=>e in i?vv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,fi=(i,e,t)=>Ev(i,typeof e!="symbol"?e+"":e,t);class Iv{constructor(e){fi(this,"name","polkadot"),fi(this,"client"),fi(this,"httpProviders"),fi(this,"events"),fi(this,"namespace"),fi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getAccounts(){const e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;const r=ai(t);e[r]=this.createHttpProvider(r,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var xv=Object.defineProperty,_v=Object.defineProperties,Pv=Object.getOwnPropertyDescriptors,lc=Object.getOwnPropertySymbols,$v=Object.prototype.hasOwnProperty,Sv=Object.prototype.propertyIsEnumerable,$n=(i,e,t)=>e in i?xv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,uc=(i,e)=>{for(var t in e||(e={}))$v.call(e,t)&&$n(i,t,e[t]);if(lc)for(var t of lc(e))Sv.call(e,t)&&$n(i,t,e[t]);return i},dc=(i,e)=>_v(i,Pv(e)),pi=(i,e,t)=>$n(i,typeof e!="symbol"?e+"":e,t);class Av{constructor(e){pi(this,"name","eip155"),pi(this,"client"),pi(this,"chainId"),pi(this,"namespace"),pi(this,"httpProviders"),pi(this,"events"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain())}async request(e){switch(e.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(e);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(e);case"wallet_getCallsStatus":return await this.getCallStatus(e)}return this.namespace.methods.includes(e.request.method)?await this.client.request(e):this.getHttpProvider().request(e.request)}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(parseInt(e),t),this.chainId=parseInt(e),this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}createHttpProvider(e,t){const s=t||ze(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;const r=parseInt(ai(t));e[r]=this.createHttpProvider(r,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}getHttpProvider(){const e=this.chainId,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}async handleSwitchChain(e){var t,s;let r=e.request.params?(t=e.request.params[0])==null?void 0:t.chainId:"0x0";r=r.startsWith("0x")?r:`0x${r}`;const n=parseInt(r,16);if(this.isChainApproved(n))this.setDefaultChain(`${n}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:e.topic,request:{method:e.request.method,params:[{chainId:r}]},chainId:(s=this.namespace.chains)==null?void 0:s[0]}),this.setDefaultChain(`${n}`);else throw new Error(`Failed to switch to chain 'eip155:${n}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(e){return this.namespace.chains.includes(`${this.name}:${e}`)}async getCapabilities(e){var t,s,r,n,o;const a=(s=(t=e.request)==null?void 0:t.params)==null?void 0:s[0],c=((n=(r=e.request)==null?void 0:r.params)==null?void 0:n[1])||[];if(!a)throw new Error("Missing address parameter in `wallet_getCapabilities` request");const h=this.client.session.get(e.topic),l=((o=h==null?void 0:h.sessionProperties)==null?void 0:o.capabilities)||{},u=`${a}${c.join(",")}`,d=l==null?void 0:l[u];if(d)return d;let p;try{p=bv(h,a,c)}catch(g){console.warn("Failed to extract capabilities from session",g)}if(p)return p;const m=await this.client.request(e);try{await this.client.session.update(e.topic,{sessionProperties:dc(uc({},h.sessionProperties||{}),{capabilities:dc(uc({},l||{}),{[u]:m})})})}catch(g){console.warn("Failed to update session with capabilities",g)}return m}async getCallStatus(e){var t,s;const r=this.client.session.get(e.topic),n=(t=r.sessionProperties)==null?void 0:t.bundler_name;if(n){const a=this.getBundlerUrl(e.chainId,n);try{return await this.getUserOperationReceipt(a,e)}catch(c){console.warn("Failed to fetch call status from bundler",c,a)}}const o=(s=r.sessionProperties)==null?void 0:s.bundler_url;if(o)try{return await this.getUserOperationReceipt(o,e)}catch(a){console.warn("Failed to fetch call status from custom bundler",a,o)}if(this.namespace.methods.includes(e.request.method))return await this.client.request(e);throw new Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(e,t){var s;const r=new URL(e),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Qt("eth_getUserOperationReceipt",[(s=t.request.params)==null?void 0:s[0]]))});if(!n.ok)throw new Error(`Failed to fetch user operation receipt - ${n.status}`);return await n.json()}getBundlerUrl(e,t){return`${C1}?projectId=${this.client.core.projectId}&chainId=${e}&bundler=${t}`}}var Ov=Object.defineProperty,Tv=(i,e,t)=>e in i?Ov(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,gi=(i,e,t)=>Tv(i,typeof e!="symbol"?e+"":e,t);class Rv{constructor(e){gi(this,"name","solana"),gi(this,"client"),gi(this,"httpProviders"),gi(this,"events"),gi(this,"namespace"),gi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;const r=ai(t);e[r]=this.createHttpProvider(r,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var Uv=Object.defineProperty,Cv=(i,e,t)=>e in i?Uv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,yi=(i,e,t)=>Cv(i,typeof e!="symbol"?e+"":e,t);class Nv{constructor(e){yi(this,"name","cosmos"),yi(this,"client"),yi(this,"httpProviders"),yi(this,"events"),yi(this,"namespace"),yi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;const r=ai(t);e[r]=this.createHttpProvider(r,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var Bv=Object.defineProperty,kv=(i,e,t)=>e in i?Bv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,mi=(i,e,t)=>kv(i,typeof e!="symbol"?e+"":e,t);class Dv{constructor(e){mi(this,"name","algorand"),mi(this,"client"),mi(this,"httpProviders"),mi(this,"events"),mi(this,"namespace"),mi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(!this.httpProviders[e]){const s=t||ze(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,s)}this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;e[t]=this.createHttpProvider(t,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);return typeof s>"u"?void 0:new Qe(new at(s,Q("disableProviderPing")))}}var qv=Object.defineProperty,jv=(i,e,t)=>e in i?qv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,wi=(i,e,t)=>jv(i,typeof e!="symbol"?e+"":e,t);class Lv{constructor(e){wi(this,"name","cip34"),wi(this,"client"),wi(this,"httpProviders"),wi(this,"events"),wi(this,"namespace"),wi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{const s=this.getCardanoRPCUrl(t),r=ai(t);e[r]=this.createHttpProvider(r,s)}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}getCardanoRPCUrl(e){const t=this.namespace.rpcMap;if(t)return t[e]}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||this.getCardanoRPCUrl(e);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var Mv=Object.defineProperty,zv=(i,e,t)=>e in i?Mv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,bi=(i,e,t)=>zv(i,typeof e!="symbol"?e+"":e,t);class Hv{constructor(e){bi(this,"name","elrond"),bi(this,"client"),bi(this,"httpProviders"),bi(this,"events"),bi(this,"namespace"),bi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;const r=ai(t);e[r]=this.createHttpProvider(r,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var Fv=Object.defineProperty,Vv=(i,e,t)=>e in i?Fv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,vi=(i,e,t)=>Vv(i,typeof e!="symbol"?e+"":e,t);class Kv{constructor(e){vi(this,"name","multiversx"),vi(this,"client"),vi(this,"httpProviders"),vi(this,"events"),vi(this,"namespace"),vi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;const r=ai(t);e[r]=this.createHttpProvider(r,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var Gv=Object.defineProperty,Wv=(i,e,t)=>e in i?Gv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ei=(i,e,t)=>Wv(i,typeof e!="symbol"?e+"":e,t);class Jv{constructor(e){Ei(this,"name","near"),Ei(this,"client"),Ei(this,"httpProviders"),Ei(this,"events"),Ei(this,"namespace"),Ei(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){const s=t||ze(`${this.name}:${e}`,this.namespace);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,s)}this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var s;e[t]=this.createHttpProvider(t,(s=this.namespace.rpcMap)==null?void 0:s[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace);return typeof s>"u"?void 0:new Qe(new at(s,Q("disableProviderPing")))}}var Yv=Object.defineProperty,Zv=(i,e,t)=>e in i?Yv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ii=(i,e,t)=>Zv(i,typeof e!="symbol"?e+"":e,t);class Qv{constructor(e){Ii(this,"name","tezos"),Ii(this,"client"),Ii(this,"httpProviders"),Ii(this,"events"),Ii(this,"namespace"),Ii(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){const s=t||ze(`${this.name}:${e}`,this.namespace);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,s)}this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{e[t]=this.createHttpProvider(t)}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace);return typeof s>"u"?void 0:new Qe(new at(s))}}var Xv=Object.defineProperty,eE=(i,e,t)=>e in i?Xv(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,xi=(i,e,t)=>eE(i,typeof e!="symbol"?e+"":e,t);class tE{constructor(e){xi(this,"name",_i),xi(this,"client"),xi(this,"httpProviders"),xi(this,"events"),xi(this,"namespace"),xi(this,"chainId"),this.namespace=e.namespace,this.events=Q("events"),this.client=Q("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(e.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(e.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(e.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(e.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider(e.chainId).request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Xe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){var e,t;const s={};return(t=(e=this.namespace)==null?void 0:e.accounts)==null||t.forEach(r=>{const n=Ai(r);s[`${n.namespace}:${n.reference}`]=this.createHttpProvider(r)}),s}getHttpProvider(e){const t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const s=this.createHttpProvider(e,t);s&&(this.httpProviders[e]=s)}createHttpProvider(e,t){const s=t||ze(e,this.namespace,this.client.core.projectId);if(!s)throw new Error(`No RPC url provided for chainId: ${e}`);return new Qe(new at(s,Q("disableProviderPing")))}}var iE=Object.defineProperty,sE=Object.defineProperties,rE=Object.getOwnPropertyDescriptors,fc=Object.getOwnPropertySymbols,nE=Object.prototype.hasOwnProperty,oE=Object.prototype.propertyIsEnumerable,Sn=(i,e,t)=>e in i?iE(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ls=(i,e)=>{for(var t in e||(e={}))nE.call(e,t)&&Sn(i,t,e[t]);if(fc)for(var t of fc(e))oE.call(e,t)&&Sn(i,t,e[t]);return i},Mr=(i,e)=>sE(i,rE(e)),Ke=(i,e,t)=>Sn(i,typeof e!="symbol"?e+"":e,t);class gr{constructor(e){Ke(this,"client"),Ke(this,"namespaces"),Ke(this,"optionalNamespaces"),Ke(this,"sessionProperties"),Ke(this,"scopedProperties"),Ke(this,"events",new Rn),Ke(this,"rpcProviders",{}),Ke(this,"session"),Ke(this,"providerOpts"),Ke(this,"logger"),Ke(this,"uri"),Ke(this,"disableProviderPing",!1),this.providerOpts=e,this.logger=typeof(e==null?void 0:e.logger)<"u"&&typeof(e==null?void 0:e.logger)!="string"?e.logger:An(sr({level:(e==null?void 0:e.logger)||Ya})),this.disableProviderPing=(e==null?void 0:e.disableProviderPing)||!1}static async init(e){const t=new gr(e);return await t.initialize(),t}async request(e,t,s){const[r,n]=this.validateChain(t);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(r).request({request:Ls({},e),chainId:`${r}:${n}`,topic:this.session.topic,expiry:s})}sendAsync(e,t,s,r){const n=new Date().getTime();this.request(e,s,r).then(o=>t(null,rr(n,o))).catch(o=>t(o,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var e;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(e=this.session)==null?void 0:e.topic,reason:ne("USER_DISCONNECTED")}),await this.cleanup()}async connect(e){if(!this.client)throw new Error("Sign Client not initialized");if(this.setNamespaces(e),await this.cleanupPendingPairings(),!e.skipPairing)return await this.pair(e.pairingTopic)}async authenticate(e,t){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(e),await this.cleanupPendingPairings();const{uri:s,response:r}=await this.client.authenticate(e,t);s&&(this.uri=s,this.events.emit("display_uri",s));const n=await r();if(this.session=n.session,this.session){const o=rc(this.session.namespaces);this.namespaces=js(this.namespaces,o),await this.persist("namespaces",this.namespaces),this.onConnect()}return n}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}removeListener(e,t){this.events.removeListener(e,t)}off(e,t){this.events.off(e,t)}get isWalletConnect(){return!0}async pair(e){const{uri:t,approval:s}=await this.client.connect({pairingTopic:e,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties});t&&(this.uri=t,this.events.emit("display_uri",t));const r=await s();this.session=r;const n=rc(r.namespaces);return this.namespaces=js(this.namespaces,n),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(e,t){try{if(!this.session)return;const[s,r]=this.validateChain(e),n=this.getProvider(s);n.name===_i?n.setDefaultChain(`${s}:${r}`,t):n.setDefaultChain(r,t)}catch(s){if(!/Please call connect/.test(s.message))throw s}}async cleanupPendingPairings(e={}){this.logger.info("Cleaning up inactive pairings...");const t=this.client.pairing.getAll();if(Pt(t)){for(const s of t)e.deletePairings?this.client.core.expirer.set(s.topic,0):await this.client.core.relayer.subscriber.unsubscribe(s.topic);this.logger.info(`Inactive pairings cleared: ${t.length}`)}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var e,t;if(this.client=this.providerOpts.client||await E1.init({core:this.providerOpts.core,logger:this.providerOpts.logger||Ya,relayUrl:this.providerOpts.relayUrl||T1,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(s){throw this.logger.error("Failed to get session",s),new Error(`The provided session: ${(t=(e=this.providerOpts)==null?void 0:e.session)==null?void 0:t.topic} doesn't exist in the Sign client`)}else{const s=this.client.session.getAll();this.session=s[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");const e=[...new Set(Object.keys(this.session.namespaces).map(t=>$i(t)))];jr("client",this.client),jr("events",this.events),jr("disableProviderPing",this.disableProviderPing),e.forEach(t=>{if(!this.session)return;const s=fv(t,this.session),r=Il(s),n=js(this.namespaces,this.optionalNamespaces),o=Mr(Ls({},n[t]),{accounts:s,chains:r});switch(t){case"eip155":this.rpcProviders[t]=new Av({namespace:o});break;case"algorand":this.rpcProviders[t]=new Dv({namespace:o});break;case"solana":this.rpcProviders[t]=new Rv({namespace:o});break;case"cosmos":this.rpcProviders[t]=new Nv({namespace:o});break;case"polkadot":this.rpcProviders[t]=new Iv({namespace:o});break;case"cip34":this.rpcProviders[t]=new Lv({namespace:o});break;case"elrond":this.rpcProviders[t]=new Hv({namespace:o});break;case"multiversx":this.rpcProviders[t]=new Kv({namespace:o});break;case"near":this.rpcProviders[t]=new Jv({namespace:o});break;case"tezos":this.rpcProviders[t]=new Qv({namespace:o});break;default:this.rpcProviders[_i]?this.rpcProviders[_i].updateNamespace(o):this.rpcProviders[_i]=new tE({namespace:o})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",e=>{var t;const{topic:s}=e;s===((t=this.session)==null?void 0:t.topic)&&this.events.emit("session_ping",e)}),this.client.on("session_event",e=>{var t;const{params:s,topic:r}=e;if(r!==((t=this.session)==null?void 0:t.topic))return;const{event:n}=s;if(n.name==="accountsChanged"){const o=n.data;o&&Pt(o)&&this.events.emit("accountsChanged",o.map(sc))}else if(n.name==="chainChanged"){const o=s.chainId,a=s.event.data,c=$i(o),h=qr(o)!==qr(a)?`${c}:${qr(a)}`:o;this.onChainChanged(h)}else this.events.emit(n.name,n.data);this.events.emit("session_event",e)}),this.client.on("session_update",({topic:e,params:t})=>{var s,r;if(e!==((s=this.session)==null?void 0:s.topic))return;const{namespaces:n}=t,o=(r=this.client)==null?void 0:r.session.get(e);this.session=Mr(Ls({},o),{namespaces:n}),this.onSessionUpdate(),this.events.emit("session_update",{topic:e,params:t})}),this.client.on("session_delete",async e=>{var t;e.topic===((t=this.session)==null?void 0:t.topic)&&(await this.cleanup(),this.events.emit("session_delete",e),this.events.emit("disconnect",Mr(Ls({},ne("USER_DISCONNECTED")),{data:e.topic})))}),this.on(Xe.DEFAULT_CHAIN_CHANGED,e=>{this.onChainChanged(e,!0)})}getProvider(e){return this.rpcProviders[e]||this.rpcProviders[_i]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(e=>{var t;this.getProvider(e).updateNamespace((t=this.session)==null?void 0:t.namespaces[e])})}setNamespaces(e){const{namespaces:t={},optionalNamespaces:s={},sessionProperties:r,scopedProperties:n}=e;this.optionalNamespaces=js(t,s),this.sessionProperties=r,this.scopedProperties=n}validateChain(e){const[t,s]=(e==null?void 0:e.split(":"))||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[t,s];if(t&&!Object.keys(this.namespaces||{}).map(o=>$i(o)).includes(t))throw new Error(`Namespace '${t}' is not configured. Please call connect() first with namespace config.`);if(t&&s)return[t,s];const r=$i(Object.keys(this.namespaces)[0]),n=this.rpcProviders[r].getDefaultChain();return[r,n]}async requestAccounts(){const[e]=this.validateChain();return await this.getProvider(e).requestAccounts()}async onChainChanged(e,t=!1){if(!this.namespaces)return;const[s,r]=this.validateChain(e);if(!r)return;this.updateNamespaceChain(s,r),this.events.emit("chainChanged",r);const n=this.getProvider(s).getDefaultChain();t||this.getProvider(s).setDefaultChain(r),this.emitAccountsChangedOnChainChange({namespace:s,previousChainId:n,newChainId:e}),await this.persist("namespaces",this.namespaces)}emitAccountsChangedOnChainChange({namespace:e,previousChainId:t,newChainId:s}){var r,n;try{if(t===s)return;const o=(n=(r=this.session)==null?void 0:r.namespaces[e])==null?void 0:n.accounts;if(!o)return;const a=o.filter(c=>c.includes(`${s}:`)).map(sc);if(!Pt(a))return;this.events.emit("accountsChanged",a)}catch(o){this.logger.warn("Failed to emit accountsChanged on chain change",o)}}updateNamespaceChain(e,t){if(!this.namespaces)return;const s=this.namespaces[e]?e:`${e}:${t}`,r={chains:[],methods:[],events:[],defaultChain:t};this.namespaces[s]?this.namespaces[s]&&(this.namespaces[s].defaultChain=t):this.namespaces[s]=r}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,await this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(e,t){var s;const r=((s=this.session)==null?void 0:s.topic)||"";await this.client.core.storage.setItem(`${Ds}/${e}${r}`,t)}async getFromStore(e){var t;const s=((t=this.session)==null?void 0:t.topic)||"";return await this.client.core.storage.getItem(`${Ds}/${e}${s}`)}async deleteFromStore(e){var t;const s=((t=this.session)==null?void 0:t.topic)||"";await this.client.core.storage.removeItem(`${Ds}/${e}${s}`)}async cleanupStorage(){var e;try{if(((e=this.client)==null?void 0:e.session.length)>0)return;const t=await this.client.core.storage.getKeys();for(const s of t)s.startsWith(Ds)&&await this.client.core.storage.removeItem(s)}catch(t){this.logger.warn("Failed to cleanup storage",t)}}}const aE=gr,kE=Object.freeze(Object.defineProperty({__proto__:null,UniversalProvider:aE,default:gr},Symbol.toStringTag,{value:"Module"}));export{ju as H,po as a,fs as b,xE as c,Cu as d,_c as e,Lu as f,IE as g,Js as h,$E as i,PE as j,kE as k,_E as r,Pc as t};
